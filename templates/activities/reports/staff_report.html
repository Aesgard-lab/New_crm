{% extends "backoffice/base.html" %}
{% load static analytics_tags sanitize_tags %}


{% block title %}Reporte de Instructores - {{ gym.name }}{% endblock %}

{% block extra_css %}
{% include "backoffice/analytics/partials/_analytics_css.html" %}
<style>
    /* Specific styles for Staff Report that are not in shared CSS */
    .instructor-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.95rem;
    }

    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .rank-1 {
        background: #fef3c7;
        color: #d97706;
    }

    .rank-2 {
        background: #f1f5f9;
        color: #64748b;
    }

    .rank-3 {
        background: #f1f5f9;
        color: #64748b;
    }

    .rank-other {
        background: transparent;
        color: #94a3b8;
    }

    .tab-button {
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        color: #64748b;
        background: transparent;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .tab-button:hover {
        background: #f1f5f9;
        color: var(--brand-color);
    }

    .tab-button.active {
        background: white;
        color: var(--brand-color);
        border-color: #e2e8f0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .utilization-ring svg {
        transform: rotate(-90deg);
    }

    .utilization-ring circle {
        transition: stroke-dashoffset 1s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="analytics-container">

        <!-- Header -->
        <div class="analytics-header">
            <div>
                <h1 class="analytics-title">
                    <span class="icon-box"
                        style="width: 40px; height: 40px; font-size: 1.25rem; margin-bottom: 0;">üë®‚Äçüè´</span>
                    Reporte de Instructores
                </h1>
                <p class="analytics-subtitle">{{ start_date|date:"d M Y" }} - {{ end_date|date:"d M Y" }}</p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'analytics_dashboard' %}" class="btn-secondary">
                    ‚Üê Volver al Dashboard
                </a>
                <a href="{% url 'export_report_csv' %}?type=staff&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}"
                    class="btn-brand">
                    üì• Exportar CSV
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <form method="get" class="analytics-filters">
            <div class="filter-group">
                <label class="filter-label">Fecha Inicio</label>
                <input type="date" name="start_date" class="filter-input" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="filter-group">
                <label class="filter-label">Fecha Fin</label>
                <input type="date" name="end_date" class="filter-input" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="filter-group" style="flex: 2;">
                <label class="filter-label">Instructor</label>
                <select name="staff_id" class="filter-input">
                    <option value="">-- Todos los instructores --</option>
                    {% for staff in staff_list %}
                    {% with staff_id_str=staff.id|stringformat:"s" %}
                    <option value="{{ staff.id }}" {% if staff_id_str == selected_staff_id %}selected{% endif %}>
                        {{ staff.user.first_name }} {{ staff.user.last_name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" class="btn-brand"
                    style="height: 42px; width: 42px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    üîç
                </button>
            </div>
        </form>

        <!-- KPI de Utilizaci√≥n Global -->
        <div class="analytics-card">
            <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Utilizaci√≥n Global del Staff</h3>
                    <div class="text-4xl font-extrabold text-slate-800 mb-2">{{ staff_utilization|floatformat:1 }}%
                    </div>
                    <p class="text-slate-500">de la capacidad total est√° siendo utilizada en el per√≠odo seleccionado.
                    </p>
                </div>
                <div class="relative w-40 h-40">
                    <svg class="utilization-ring w-full h-full" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="10" />
                        <circle cx="50" cy="50" r="45" fill="none" stroke="var(--brand-color)" stroke-width="10"
                            stroke-dasharray="283"
                            stroke-dashoffset="{{ 283|sub:283|mul:staff_utilization|div:100|floatformat:0 }}"
                            stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-2xl font-bold text-slate-800">{{ staff_utilization|floatformat:0 }}%</span>
                        <span class="text-xs font-bold text-slate-400 uppercase">Uso</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs de Rankings -->
        <div class="analytics-card">
            <div class="flex flex-wrap gap-2 mb-6 bg-slate-50 p-1.5 rounded-xl border border-slate-200">
                <button class="tab-button active flex-1" onclick="showRanking('attendance', this)">
                    üìä Por Asistencia
                </button>
                <button class="tab-button flex-1" onclick="showRanking('rating', this)">
                    ‚≠ê Por Rating
                </button>
                <button class="tab-button flex-1" onclick="showRanking('classes', this)">
                    üìÖ Por Clases
                </button>
                <button class="tab-button flex-1" onclick="showRanking('clients', this)">
                    üë• Por Clientes
                </button>
            </div>

            <!-- Ranking por Asistencia -->
            <div class="ranking-panel" id="ranking-attendance">
                <h3 class="text-lg font-bold text-slate-800 mb-4">üèÜ Top Instructores por Asistencia Total</h3>
                <div class="analytics-table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Instructor</th>
                                <th>Clases</th>
                                <th>Asistencia</th>
                                <th>Prom/Clase</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instructor in top_by_attendance %}
                            <tr>
                                <td>
                                    <span
                                        class="rank-badge {% if forloop.counter <= 3 %}rank-1{% else %}rank-other{% endif %}">
                                        {{ forloop.counter }}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="instructor-avatar">
                                            {{ instructor.staff__user__first_name|slice:":1" }}{{
                                            instructor.staff__user__last_name|slice:":1" }}
                                        </div>
                                        <span class="font-semibold text-slate-700">{{ instructor.staff__user__first_name
                                            }} {{ instructor.staff__user__last_name }}</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-slate-100 text-slate-600">{{ instructor.classes_taught
                                        }}</span></td>
                                <td><span class="badge badge-brand">{{ instructor.total_attendance }}</span></td>
                                <td>{{ instructor.avg_attendance|floatformat:1 }}</td>
                                <td>
                                    {% if instructor.avg_rating %}‚≠ê {{ instructor.avg_rating|floatformat:1 }}{% else
                                    %}-{% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">No hay datos disponibles</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ranking por Rating -->
            <div class="ranking-panel" id="ranking-rating" style="display: none;">
                <h3 class="text-lg font-bold text-slate-800 mb-4">‚≠ê Top Instructores por Rating</h3>
                <div class="analytics-table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Instructor</th>
                                <th>Rating</th>
                                <th>Clases</th>
                                <th>Asistencia</th>
                                <th>Clientes √önicos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instructor in top_by_rating %}
                            <tr>
                                <td><span
                                        class="rank-badge {% if forloop.counter <= 3 %}rank-1{% else %}rank-other{% endif %}">{{
                                        forloop.counter }}</span></td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="instructor-avatar">
                                            {{ instructor.staff__user__first_name|slice:":1" }}{{
                                            instructor.staff__user__last_name|slice:":1" }}
                                        </div>
                                        <span class="font-semibold text-slate-700">{{ instructor.staff__user__first_name
                                            }} {{ instructor.staff__user__last_name }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="font-bold text-amber-500">‚≠ê {{ instructor.avg_rating|floatformat:2
                                        }}</span>
                                </td>
                                <td>{{ instructor.classes_taught }}</td>
                                <td>{{ instructor.total_attendance }}</td>
                                <td><span class="badge badge-brand">{{ instructor.unique_clients }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">No hay datos disponibles</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ranking por Clases -->
            <div class="ranking-panel" id="ranking-classes" style="display: none;">
                <h3 class="text-lg font-bold text-slate-800 mb-4">üìÖ Top Instructores por Clases Impartidas</h3>
                <div class="analytics-table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Instructor</th>
                                <th>Clases</th>
                                <th>Asistencia</th>
                                <th>Prom/Clase</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instructor in top_by_classes %}
                            <tr>
                                <td><span
                                        class="rank-badge {% if forloop.counter <= 3 %}rank-1{% else %}rank-other{% endif %}">{{
                                        forloop.counter }}</span></td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="instructor-avatar">
                                            {{ instructor.staff__user__first_name|slice:":1" }}{{
                                            instructor.staff__user__last_name|slice:":1" }}
                                        </div>
                                        <span class="font-semibold text-slate-700">{{ instructor.staff__user__first_name
                                            }} {{ instructor.staff__user__last_name }}</span>
                                    </div>
                                </td>
                                <td><span class="badge badge-brand">{{ instructor.classes_taught }}</span></td>
                                <td>{{ instructor.total_attendance }}</td>
                                <td>{{ instructor.avg_attendance|floatformat:1 }}</td>
                                <td>{% if instructor.avg_rating %}‚≠ê {{ instructor.avg_rating|floatformat:1 }}{% else
                                    %}-{% endif %}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">No hay datos disponibles</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ranking por Clientes -->
            <div class="ranking-panel" id="ranking-clients" style="display: none;">
                <h3 class="text-lg font-bold text-slate-800 mb-4">üë• Top Instructores por Clientes √önicos</h3>
                <div class="analytics-table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Instructor</th>
                                <th>Clientes √önicos</th>
                                <th>Clases</th>
                                <th>Asistencia</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instructor in top_by_clients %}
                            <tr>
                                <td><span
                                        class="rank-badge {% if forloop.counter <= 3 %}rank-1{% else %}rank-other{% endif %}">{{
                                        forloop.counter }}</span></td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="instructor-avatar">
                                            {{ instructor.staff__user__first_name|slice:":1" }}{{
                                            instructor.staff__user__last_name|slice:":1" }}
                                        </div>
                                        <span class="font-semibold text-slate-700">{{ instructor.staff__user__first_name
                                            }} {{ instructor.staff__user__last_name }}</span>
                                    </div>
                                </td>
                                <td><span class="badge badge-brand">{{ instructor.unique_clients }}</span></td>
                                <td>{{ instructor.classes_taught }}</td>
                                <td>{{ instructor.total_attendance }}</td>
                                <td>{% if instructor.avg_rating %}‚≠ê {{ instructor.avg_rating|floatformat:1 }}{% else
                                    %}-{% endif %}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">No hay datos disponibles</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Performance Detallado (si se selecciona un instructor) -->
        {% if selected_staff_id and staff_performance %}
        <div class="analytics-card">
            <h3 class="text-lg font-bold text-slate-800 mb-4">üìà Performance Detallado</h3>

            {% for perf in staff_performance %}
            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <div class="instructor-avatar" style="width: 64px; height: 64px; font-size: 1.5rem;">
                            {{ perf.staff__user__first_name|slice:":1" }}{{ perf.staff__user__last_name|slice:":1" }}
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">{{ perf.staff__user__first_name }} {{
                                perf.staff__user__last_name }}</h2>
                            <div class="text-slate-500">Instructor</div>
                        </div>
                    </div>
                    {% if perf.avg_rating %}
                    <div
                        class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm">
                        <span class="text-2xl">‚≠ê</span>
                        <span class="text-2xl font-bold text-slate-800">{{ perf.avg_rating|floatformat:1 }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-white rounded-lg border border-slate-200">
                        <div class="text-2xl font-extrabold text-[var(--brand-color)]">{{ perf.classes_taught }}</div>
                        <div class="text-xs font-bold uppercase text-slate-500 mt-1">Clases</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg border border-slate-200">
                        <div class="text-2xl font-extrabold text-[var(--brand-color)]">{{ perf.total_attendance }}</div>
                        <div class="text-xs font-bold uppercase text-slate-500 mt-1">Asistencia Total</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg border border-slate-200">
                        <div class="text-2xl font-extrabold text-[var(--brand-color)]">{{
                            perf.avg_attendance|floatformat:1 }}</div>
                        <div class="text-xs font-bold uppercase text-slate-500 mt-1">Promedio/Clase</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg border border-slate-200">
                        <div class="text-2xl font-extrabold text-[var(--brand-color)]">{{ perf.unique_clients }}</div>
                        <div class="text-xs font-bold uppercase text-slate-500 mt-1">Clientes √önicos</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Gr√°fica Comparativa -->
        <div class="analytics-card">
            <h3 class="text-lg font-bold text-slate-800 mb-4">üìä Comparativa de Instructores</h3>
            <div class="chart-wrapper">
                <canvas id="instructorComparisonChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Cambiar entre rankings
    function showRanking(type, button) {
        document.querySelectorAll('.ranking-panel').forEach(panel => {
            panel.style.display = 'none';
        });

        const targetPanel = document.getElementById('ranking-' + type);
        if (targetPanel) {
            targetPanel.style.display = 'block';
        }

        document.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
        if (button) {
            button.classList.add('active');
        }
    }

    // Gr√°fica comparativa
    const comparisonCtx = document.getElementById('instructorComparisonChart').getContext('2d');
    const instructorData = {{ top_by_attendance| safe_json }};

    // Colores de la marca (calculados o est√°ticos si es m√°s seguro)
    const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color').trim() || '#0f172a';

    new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: instructorData.slice(0, 10).map(i =>
                `${i.staff__user__first_name} ${i.staff__user__last_name}`
            ),
            datasets: [
                {
                    label: 'Total Asistencia',
                    data: instructorData.slice(0, 10).map(i => i.total_attendance),
                    backgroundColor: brandColor,
                    borderRadius: 6,
                    yAxisID: 'y'
                },
                {
                    label: 'Promedio por Clase',
                    data: instructorData.slice(0, 10).map(i => i.avg_attendance),
                    backgroundColor: '#cbd5e1', // slate-300
                    borderRadius: 6,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    grid: { display: false }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Asistencia Total' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Promedio/Clase' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });

    // Anillo de utilizaci√≥n (SVG animation)
    document.addEventListener('DOMContentLoaded', function () {
        // La animaci√≥n CSS se encarga, pero podemos a√±adir l√≥gica extra si es necesario
        // En este caso, el valor stroke-dashoffset ya est√° calculado en el template Django
    });
</script>
{% endblock %}
