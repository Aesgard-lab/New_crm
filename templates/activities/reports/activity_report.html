{% extends "backoffice/base.html" %}
{% load static analytics_tags %}
{% load sanitize_tags %}

{% block title %}Reporte de Actividades - {{ gym.name }}{% endblock %}

{% block extra_css %}
{% include "backoffice/analytics/partials/_analytics_css.html" %}
<style>
    /* Specific styles for Activity Report */
    .trend-up {
        color: #10b981;
    }

    .trend-down {
        color: #ef4444;
    }

    .trend-neutral {
        color: #64748b;
    }

    /* Heatmap styles */
    .heatmap-grid {
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
        gap: 4px;
        overflow-x: auto;
    }

    .heatmap-cell {
        aspect-ratio: 2/1;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: #1e293b;
        transition: all 0.2s;
        position: relative;
    }

    .heatmap-cell:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        white-space: nowrap;
        z-index: 10;
        pointer-events: none;
        margin-bottom: 4px;
    }

    .intensity-0 {
        background-color: #f1f5f9;
        color: #94a3b8;
    }

    .intensity-1 {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .intensity-2 {
        background-color: #93c5fd;
        color: #1e3a8a;
    }

    .intensity-3 {
        background-color: #3b82f6;
        color: white;
    }

    .intensity-4 {
        background-color: #2563eb;
        color: white;
    }

    .intensity-5 {
        background-color: #1d4ed8;
        color: white;
    }

    .day-header {
        text-align: center;
        font-weight: 600;
        font-size: 0.85rem;
        color: #64748b;
        padding-bottom: 8px;
    }

    .time-label {
        font-size: 0.75rem;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="analytics-container">

        <!-- Header -->
        <div class="analytics-header">
            <div>
                <h1 class="analytics-title">
                    <span class="icon-box"
                        style="width: 40px; height: 40px; font-size: 1.25rem; margin-bottom: 0;">üí™</span>
                    Reporte de Actividades
                </h1>
                <p class="analytics-subtitle">{{ start_date|date:"d M Y" }} - {{ end_date|date:"d M Y" }}</p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'analytics_dashboard' %}" class="btn-secondary">
                    ‚Üê Volver al Dashboard
                </a>
                <a href="{% url 'export_report_csv' %}?type=activities&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}"
                    class="btn-brand">
                    üì• Exportar CSV
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <form method="get" class="analytics-filters">
            <div class="filter-group">
                <label class="filter-label">Fecha Inicio</label>
                <input type="date" name="start_date" class="filter-input" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="filter-group">
                <label class="filter-label">Fecha Fin</label>
                <input type="date" name="end_date" class="filter-input" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="filter-group" style="flex: 2;">
                <label class="filter-label">Actividad</label>
                <select name="activity_id" class="filter-input">
                    <option value="">-- Todas las actividades --</option>
                    {% for activity in activities %}
                    {% with aid=activity.id|stringformat:"s" %}
                    <option value="{{ activity.id }}" {% if aid == selected_activity_id %}selected{% endif %}>
                        {{ activity.name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Per√≠odo</label>
                <select name="period" class="filter-input">
                    <option value="daily" {% if period == 'daily' %}selected{% endif %}>Diario</option>
                    <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>Semanal</option>
                    <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>Mensual</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn-brand"
                    style="height: 42px; width: 42px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    üîç
                </button>
            </div>
        </form>

        <!-- Top Actividades -->
        <div class="analytics-card">
            <h3 class="text-lg font-bold text-slate-800 mb-4">‚≠ê Top 15 Actividades M√°s Populares</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for activity in popular_activities %}
                <div
                    class="border border-slate-200 rounded-xl p-4 hover:border-[var(--brand-color)] transition-colors bg-white shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div class="font-bold text-slate-800 text-lg">{{ forloop.counter }}. {{ activity.name }}</div>
                        <span class="bg-blue-50 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">
                            {{ activity.percent_total|floatformat:1 }}%
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Total</div>
                            <div class="font-bold text-slate-800 text-lg">{{ activity.total_attendance }}</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Promedio</div>
                            <div class="font-bold text-slate-800 text-lg">{{ activity.avg_attendance|floatformat:1 }}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8 text-slate-400">
                    No hay datos de actividades en este per√≠odo
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Gr√°fica de Tendencia -->
            <div class="analytics-card mb-0">
                <h3 class="text-lg font-bold text-slate-800 mb-2">üìà Tendencia de Participaci√≥n</h3>
                <p class="text-slate-500 text-sm mb-4">Evoluci√≥n de la asistencia en el tiempo</p>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Distribuci√≥n por Horario -->
            <div class="analytics-card mb-0">
                <h3 class="text-lg font-bold text-slate-800 mb-2">‚è∞ Distribuci√≥n Horaria</h3>
                <p class="text-slate-500 text-sm mb-4">Asistencia promedio por hora del d√≠a</p>
                <div class="chart-wrapper">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Mapa de Calor Semanal -->
        <div class="analytics-card">
            <h3 class="text-lg font-bold text-slate-800 mb-2">üî• Mapa de Calor Semanal</h3>
            <p class="text-slate-500 text-sm mb-6">Intensidad de ocupaci√≥n por d√≠a y hora</p>

            <div class="heatmap-grid">
                <!-- Header Row -->
                <div></div>
                {% for day in days_of_week %}
                <div class="day-header">{{ day }}</div>
                {% endfor %}

                <!-- Time Rows -->
                {% for hour in hours_range %}
                <div class="time-label">{{ hour }}:00</div>
                {% for day_idx in "0123456"|make_list %}
                {% with cell_data=heatmap_data|get_heatmap_cell:day_idx|get_heatmap_cell:hour %}
                <div class="heatmap-cell intensity-{{ cell_data.intensity }}"
                    data-tooltip="{{ cell_data.count }} reservas">
                    {% if cell_data.count > 0 %}{{ cell_data.count }}{% endif %}
                </div>
                {% endwith %}
                {% endfor %}
                {% endfor %}
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color').trim() || '#0f172a';

    // --- Trend Chart ---
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendData = {{ trend_data| safe }};

    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: trendData.labels,
            datasets: [{
                label: 'Asistencia Total',
                data: trendData.values,
                borderColor: brandColor,
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: brandColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f5f9' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // --- Hourly Chart ---
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    const hourlyData = {{ hourly_distribution| safe }};

    new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: hourlyData.labels,
            datasets: [{
                label: 'Promedio Asistencia',
                data: hourlyData.values,
                backgroundColor: brandColor,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f5f9' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
</script>
{% endblock %}