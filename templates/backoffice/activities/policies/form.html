{% extends "backoffice/includes/form_base.html" %}

{% block subtitle %}Configuraci√≥n de reglas de reserva{% endblock %}
{% block form_width %}max-w-3xl mx-auto{% endblock %}
{% block cancel_url %}{% url 'policy_list' %}{% endblock %}
{% block submit_label %}Guardar Pol√≠tica{% endblock %}

{% block form_fields %}
<!-- Basic Info -->
<div class="mb-8">
    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre de la Pol√≠tica</label>
    {{ form.name }}
    {{ form.name.errors }}
</div>

<!-- Booking Rules -->
<div class="bg-slate-50 border border-slate-100 rounded-xl p-5 mb-6">
    <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--brand-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        Apertura de Reservas
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="col-span-2">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Modo de Apertura</label>
            {{ form.booking_window_mode }}
            <p class="text-[10px] text-slate-400 mt-1">Elige c√≥mo y cu√°ndo se abren las plazas.</p>
            {{ form.booking_window_mode.errors }}
        </div>

        <!-- Campo Valor - Se oculta en modo OPEN -->
        <div id="booking-value-field">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valor de Antelaci√≥n</label>
            {{ form.booking_window_value }}
            <p class="text-[10px] text-slate-400 mt-1" id="booking-value-help">Horas (si es relativo) o D√≠as (si es hora fija).</p>
            {{ form.booking_window_value.errors }}
        </div>

        <!-- Campo Hora - Visible en FIXED_TIME y WEEKLY_FIXED -->
        <div id="booking-time-field">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hora de Apertura</label>
            {{ form.booking_time_release }}
            <p class="text-[10px] text-slate-400 mt-1">Ej: 00:00 o 22:00</p>
            {{ form.booking_time_release.errors }}
        </div>
        
        <!-- Campo D√≠a de la Semana - Solo visible en WEEKLY_FIXED -->
        <div id="booking-weekday-field" class="col-span-2">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">D√≠a de Apertura</label>
            {{ form.booking_weekday_release }}
            <p class="text-[10px] text-slate-400 mt-1">D√≠a de la semana en que se abren las reservas para la semana siguiente.</p>
            {{ form.booking_weekday_release.errors }}
        </div>
    </div>
    
    <!-- Info de Modos -->
    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
        <p class="text-xs text-blue-700">
            <strong class="block mb-1">üìã Modos de Apertura:</strong>
            <span class="block"><strong>‚Ä¢ Abierto:</strong> Las reservas est√°n siempre disponibles hasta que empiece la clase.</span>
            <span class="block"><strong>‚Ä¢ Horas antes:</strong> Se abre X horas antes del inicio de la clase.</span>
            <span class="block"><strong>‚Ä¢ D√≠as antes (hora fija):</strong> Se abre X d√≠as antes a una hora espec√≠fica (ej: 2 d√≠as antes a las 00:00).</span>
            <span class="block"><strong>‚Ä¢ D√≠a de la semana:</strong> Se abre un d√≠a espec√≠fico a una hora fija (ej: todos los Lunes a las 22:00 para la semana siguiente).</span>
        </p>
    </div>
</div>

<!-- Membership Requirements -->
<div class="bg-indigo-50/50 border border-indigo-100 rounded-xl p-5 mb-6">
    <h3 class="font-bold text-indigo-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
        </svg>
        Requisitos de Membres√≠a
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-3 bg-white rounded-lg border border-indigo-100">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Requiere Membres√≠a Activa</label>
            {{ form.require_active_membership_choice }}
            <p class="text-[10px] text-slate-400 mt-1">El cliente debe tener una membres√≠a/cuota activa para reservar.</p>
            {{ form.require_active_membership_choice.errors }}
        </div>
        
        <div class="p-3 bg-white rounded-lg border border-indigo-100">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Requiere Membres√≠a Pagada</label>
            {{ form.require_paid_membership_choice }}
            <p class="text-[10px] text-slate-400 mt-1">Adem√°s de activa, el cliente debe estar al d√≠a en los pagos.</p>
            {{ form.require_paid_membership_choice.errors }}
        </div>
    </div>
    
    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
        <p class="text-xs text-blue-700">
            <strong class="block mb-1">üìã Jerarqu√≠a de Configuraci√≥n:</strong>
            <span class="block"><strong>‚Ä¢ Heredar:</strong> Usa la configuraci√≥n general del gimnasio (Configuraci√≥n ‚Üí General ‚Üí "Permitir reservas con pago pendiente").</span>
            <span class="block"><strong>‚Ä¢ S√≠, requerir:</strong> Siempre requiere esta condici√≥n para esta actividad, ignorando la configuraci√≥n general.</span>
            <span class="block"><strong>‚Ä¢ No, permitir:</strong> No requiere esta condici√≥n para esta actividad, ignorando la configuraci√≥n general.</span>
        </p>
    </div>
    
    <div class="mt-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
        <p class="text-xs text-amber-700">
            <strong>‚ö†Ô∏è Nota:</strong> La pol√≠tica de la actividad tiene prioridad sobre la configuraci√≥n general del gimnasio.
            Esto permite clases de prueba o d√≠as de puertas abiertas manteniendo requisitos estrictos en otras clases.
        </p>
    </div>
</div>

<!-- Waitlist Settings -->
<div class="bg-slate-50 border border-slate-100 rounded-xl p-5 mb-6">
    <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--brand-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
            </path>
        </svg>
        Lista de Espera
    </h3>

    <div class="flex items-center gap-2 mb-4">
        {{ form.waitlist_enabled }}
        <label class="text-sm font-medium text-slate-700">Activar Lista de Espera</label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Modo de Funcionamiento</label>
            {{ form.waitlist_mode }}
            <p class="text-[10px] text-slate-400 mt-1">
                <strong>Auto-Promoci√≥n:</strong> El primero en lista sube autom√°ticamente.<br>
                <strong>Broadcast:</strong> Notifica a varios, primero en reclamar gana.<br>
                <strong>Primero que Reclama:</strong> Notifica a TODOS, compiten por la plaza.
            </p>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">L√≠mite de Personas</label>
            {{ form.waitlist_limit }}
            <p class="text-[10px] text-slate-400 mt-1">0 = Sin l√≠mite.</p>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Congelar Lista (Horas)</label>
            {{ form.auto_promote_cutoff_hours }}
            <p class="text-[10px] text-slate-400 mt-1">Horas antes de la clase que detienen la auto-promoci√≥n.</p>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Timeout para Reclamar (Minutos)</label>
            {{ form.waitlist_claim_timeout_minutes }}
            <p class="text-[10px] text-slate-400 mt-1">Tras este tiempo sin reclamar, se auto-promociona al primero.</p>
        </div>
    </div>
    
    <!-- VIP Configuration -->
    <div class="mt-6 pt-6 border-t border-slate-200">
        <h4 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
            <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            Prioridad VIP
        </h4>
        <p class="text-xs text-slate-500 mb-4">Los clientes VIP pasan autom√°ticamente a la clase cuando se libera una plaza, sin competir.</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Grupos VIP</label>
                <div class="bg-white rounded-lg border border-slate-200 p-3 max-h-40 overflow-y-auto">
                    {% if form.vip_groups %}
                        {{ form.vip_groups }}
                    {% else %}
                        <p class="text-xs text-slate-400">No hay grupos configurados</p>
                    {% endif %}
                </div>
                <p class="text-[10px] text-slate-400 mt-1">Clientes en estos grupos tienen prioridad.</p>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Planes VIP</label>
                <div class="bg-white rounded-lg border border-slate-200 p-3 max-h-40 overflow-y-auto">
                    {% if form.vip_membership_plans %}
                        {{ form.vip_membership_plans }}
                    {% else %}
                        <p class="text-xs text-slate-400">No hay planes configurados</p>
                    {% endif %}
                </div>
                <p class="text-[10px] text-slate-400 mt-1">Clientes con estos planes tienen prioridad.</p>
            </div>
        </div>
    </div>
</div>

<!-- Cancellation -->
<div class="bg-red-50/50 border border-red-100 rounded-xl p-5">
    <h3 class="font-bold text-red-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
            </path>
        </svg>
        Pol√≠tica de Cancelaci√≥n
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ventana de Cancelaci√≥n</label>
            {{ form.cancellation_window_value }}
            <p class="text-[10px] text-slate-400 mt-1">Tiempo antes de la clase para cancelar sin penalizaci√≥n.</p>
            {{ form.cancellation_window_value.errors }}
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unidad de Tiempo</label>
            {{ form.cancellation_window_unit }}
            <p class="text-[10px] text-slate-400 mt-1">Minutos, horas o d√≠as.</p>
            {{ form.cancellation_window_unit.errors }}
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo de Penalizaci√≥n</label>
            {{ form.penalty_type }}
            {{ form.penalty_type.errors }}
        </div>
        <div class="md:col-span-2">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Monto Multa (solo si tipo = Cobro)</label>
            {{ form.fee_amount }}
            <p class="text-[10px] text-slate-400 mt-1">Se cobra esta cantidad si cancela tarde.</p>
            {{ form.fee_amount.errors }}
        </div>
    </div>
    
    <div class="mt-4 p-3 bg-red-100 rounded-lg border border-red-200">
        <p class="text-xs text-red-700">
            <strong>Tipos de Penalizaci√≥n:</strong><br>
            <strong>‚Ä¢ Strike:</strong> Acumula una falta. Tras X faltas, puede perder privilegios.<br>
            <strong>‚Ä¢ Cobro:</strong> Se cobra una multa monetaria al cliente.<br>
            <strong>‚Ä¢ P√©rdida de Cr√©dito:</strong> Pierde un cr√©dito/sesi√≥n de su bono.
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modeSelect = document.querySelector('[name="booking_window_mode"]');
    const valueField = document.getElementById('booking-value-field');
    const timeField = document.getElementById('booking-time-field');
    const weekdayField = document.getElementById('booking-weekday-field');
    const valueHelp = document.getElementById('booking-value-help');
    
    function updateFieldsVisibility() {
        const mode = modeSelect.value;
        
        // Ocultar/mostrar campos seg√∫n el modo
        if (mode === 'OPEN') {
            // Modo abierto: ocultar todo
            valueField.style.display = 'none';
            timeField.style.display = 'none';
            weekdayField.style.display = 'none';
        } else if (mode === 'RELATIVE_START') {
            // Modo relativo: solo valor (horas)
            valueField.style.display = 'block';
            timeField.style.display = 'none';
            weekdayField.style.display = 'none';
            valueHelp.textContent = 'Horas antes del inicio de la clase.';
        } else if (mode === 'FIXED_TIME') {
            // Modo d√≠a fijo: valor (d√≠as) + hora
            valueField.style.display = 'block';
            timeField.style.display = 'block';
            weekdayField.style.display = 'none';
            valueHelp.textContent = 'D√≠as antes de la clase.';
        } else if (mode === 'WEEKLY_FIXED') {
            // Modo semanal: d√≠a de semana + hora
            valueField.style.display = 'none';
            timeField.style.display = 'block';
            weekdayField.style.display = 'block';
        }
    }
    
    // Ejecutar al cargar
    updateFieldsVisibility();
    
    // Ejecutar al cambiar el modo
    modeSelect.addEventListener('change', updateFieldsVisibility);
});
</script>
{% endblock %}