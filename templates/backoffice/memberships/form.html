{% extends "backoffice/base.html" %}

{% block page_title %}
<div>{{ title }}</div>
<div class="text-sm font-normal text-slate-500 mt-1">Dise√±a tu plan de precios</div>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" class="max-w-6xl mx-auto" novalidate>
    {% csrf_token %}

    {% if form.errors or formset.errors %}
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-xl">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                        clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm leading-5 font-medium text-red-800">
                    Hay errores en el formulario
                </h3>
                <div class="mt-2 text-sm leading-5 text-red-700">
                    {{ form.errors }}
                    {{ formset.non_form_errors }}
                    <ul>
                        {% for form in formset %}
                        {% for error in form.errors.values %}
                        <li>{{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-sm space-y-6 mb-8">
        <h3 class="font-bold text-slate-800 border-b border-slate-100 pb-2">1. Configuraci√≥n Principal</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="col-span-2">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre del Plan</label>
                {{ form.name }}
                {{ form.name.errors }}
            </div>
            <div class="col-span-2">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descripci√≥n</label>
                {{ form.description }}
            </div>
            <div class="col-span-2">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Imagen</label>
                <input type="file" name="image"
                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-50 file:text-slate-700 hover:file:bg-slate-100 transition-colors" />
            </div>
        </div>

        <div
            class="grid grid-cols-1 md:grid-cols-4 gap-6 pt-4 border-t border-slate-100 bg-slate-50/50 p-4 rounded-xl items-end"
            x-data="priceCalculator()">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Precio Base (‚Ç¨)</label>
                {{ form.base_price }}
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Impuestos (%)</label>
                {{ form.tax_rate }}
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estrategia Precio</label>
                {{ form.price_strategy }}
            </div>

            <div class="bg-slate-900 rounded-xl p-3 flex flex-col justify-center shadow-lg shadow-slate-900/10 text-white relative">
                <div class="flex items-baseline justify-between gap-2">
                    <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">PVP Cuota</span>
                    <div class="text-lg font-bold leading-none">
                        <span id="finalPriceDisplay">0.00</span>‚Ç¨
                    </div>
                </div>
                <!-- Matr√≠cula y Total (solo si est√° activada) -->
                <template x-if="hasEnrollmentFee && enrollmentFee > 0">
                    <div class="mt-2 pt-2 border-t border-slate-700 space-y-1">
                        <div class="flex items-baseline justify-between gap-2">
                            <span class="text-[9px] text-amber-400 uppercase font-bold">+ Matr√≠cula</span>
                            <span class="text-sm font-bold text-amber-400" x-text="enrollmentFeeDisplay + '‚Ç¨'"></span>
                        </div>
                        <div class="flex items-baseline justify-between gap-2 pt-1 border-t border-slate-600">
                            <span class="text-[9px] text-emerald-400 uppercase font-bold">Total Alta</span>
                            <span class="text-sm font-bold text-emerald-400" x-text="totalFirstPayment + '‚Ç¨'"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div
            class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 shadow-sm pt-4 border-t border-slate-100">
            <h3 class="text-lg font-bold text-blue-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Configuraci√≥n de Cuota
            </h3>

            <!-- Is Recurring Toggle -->
            <div class="bg-white rounded-lg p-4 mb-4 border-2 border-blue-100">
                <label class="flex items-center justify-between cursor-pointer group">
                    <div class="flex items-center gap-3">
                        {{ form.is_recurring }}
                        <div>
                            <span
                                class="font-bold text-slate-800 text-sm group-hover:text-blue-700 transition-colors">Cuota
                                Recurrente (Suscripci√≥n)</span>
                            <p class="text-xs text-slate-500 mt-0.5">Se cobra autom√°ticamente cada per√≠odo</p>
                        </div>
                    </div>
                    <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">AUTOM√ÅTICA</span>
                </label>
            </div>

            <!-- Frequency Settings -->
            <div class="bg-white rounded-lg p-4 mb-4 border border-slate-200">
                <label class="block text-xs font-bold text-slate-700 mb-3 uppercase tracking-wide">Frecuencia de
                    Cobro</label>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cada...</label>
                        {{ form.frequency_amount }}
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unidad</label>
                        {{ form.frequency_unit }}
                    </div>
                </div>
                <p class="text-[10px] text-slate-400 mt-2">Ejemplo: "Cada 1 Mes" = Cobro mensual</p>
            </div>

            <!-- Additional Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="bg-white rounded-lg p-3 border border-slate-200">
                    <label class="flex items-center gap-2 cursor-pointer">
                        {{ form.prorate_first_month }}
                        <div>
                            <span class="text-xs font-medium text-slate-700">Prorratear primer ciclo</span>
                            <p class="text-[10px] text-slate-400 mt-0.5">Ajustar primer cobro proporcionalmente</p>
                        </div>
                    </label>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border-2 border-green-200">
                    <label class="flex items-center gap-2 cursor-pointer">
                        {{ form.is_membership }}
                        <div>
                            <span class="text-xs font-bold text-green-800">‚úì Contabiliza como SOCIO</span>
                            <p class="text-[10px] text-green-600 mt-0.5">Cuenta en estad√≠sticas de miembros</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Cuota de Inscripci√≥n / Matr√≠cula -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-xl border-2 border-amber-200 shadow-sm pt-4 border-t border-slate-100"
             x-data="enrollmentFeeSection()">
            <h3 class="text-lg font-bold text-amber-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Cuota de Inscripci√≥n / Matr√≠cula
            </h3>

            <!-- Toggle Matr√≠cula -->
            <div class="bg-white rounded-lg p-4 mb-4 border-2 border-amber-100">
                <label class="flex items-center justify-between cursor-pointer group">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" name="has_enrollment_fee" id="id_has_enrollment_fee"
                            x-model="hasEnrollmentFee"
                            @change="updatePriceCalculator()"
                            class="w-5 h-5 rounded border-slate-300 text-amber-500 focus:ring-amber-500"
                            {% if form.has_enrollment_fee.value %}checked{% endif %}>
                        <div>
                            <span class="font-bold text-slate-800 text-sm group-hover:text-amber-700 transition-colors">
                                Cobrar Cuota de Inscripci√≥n
                            </span>
                            <p class="text-xs text-slate-500 mt-0.5">Cargo √∫nico al dar de alta al cliente en este plan</p>
                        </div>
                    </div>
                    <span class="text-xs bg-amber-100 text-amber-700 px-3 py-1 rounded-full font-bold">MATR√çCULA</span>
                </label>
            </div>

            <!-- Configuraci√≥n de Matr√≠cula -->
            <div x-show="hasEnrollmentFee" x-transition class="bg-white rounded-lg p-4 border border-amber-200 space-y-4">
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Importe de Matr√≠cula (‚Ç¨)</label>
                        {{ form.enrollment_fee }}
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Impuesto Aplicable</label>
                        {{ form.enrollment_fee_tax_rate }}
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estrategia Impuestos</label>
                        {{ form.enrollment_fee_price_strategy }}
                        <p class="text-[10px] text-slate-500 mt-1">Si el importe incluye IVA o no</p>
                    </div>
                    <div class="bg-amber-100 rounded-xl p-3 flex flex-col justify-center">
                        <span class="text-[9px] text-amber-600 uppercase font-bold">PVP Matr√≠cula</span>
                        <span class="text-lg font-bold text-amber-800" x-text="enrollmentFeeDisplay + '‚Ç¨'">0.00‚Ç¨</span>
                    </div>
                </div>
                
                <!-- Canal de cobro de matr√≠cula -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">D√≥nde Cobrar Matr√≠cula</label>
                        {{ form.enrollment_fee_channel }}
                        <p class="text-[10px] text-slate-500 mt-1">Define si se cobra presencial, online o ambos</p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 border border-amber-200/50 flex items-center">
                        <label class="flex items-center gap-2 cursor-pointer">
                            {{ form.enrollment_fee_waivable }}
                            <div>
                                <span class="text-xs font-medium text-amber-800">Condonable por staff</span>
                                <p class="text-[10px] text-amber-600 mt-0.5">Permite eximir en casos especiales</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pause Configuration (Only for Recurring) -->
        <div class="pt-6 border-t border-slate-100">
            <div class="bg-purple-50 p-5 rounded-xl border border-purple-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-bold text-purple-900 text-sm">Configuraci√≥n de Pausas</span>
                        <span class="text-[10px] bg-purple-200 text-purple-700 px-2 py-0.5 rounded-full">Solo
                            Cuotas</span>
                    </div>
                    {{ form.allow_pause }}
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cargo por Pausa (‚Ç¨)</label>
                        {{ form.pause_fee }}
                        <p class="text-[10px] text-purple-700 mt-1">Cargo √∫nico al activar</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pausas al A√±o</label>
                        {{ form.pause_max_per_year }}
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">D√≠as M√≠nimos</label>
                        {{ form.pause_min_days }}
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">D√≠as M√°ximos</label>
                        {{ form.pause_max_days }}
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Anticipaci√≥n</label>
                        {{ form.pause_advance_notice_days }}
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 pt-3 border-t border-purple-200/50">
                    <div class="flex items-center gap-2">
                        {{ form.pause_allows_gym_access }}
                        <label class="text-xs text-slate-600">Permite Acceso</label>
                    </div>
                    <div class="flex items-center gap-2">
                        {{ form.pause_allows_booking }}
                        <label class="text-xs text-slate-600">Permite Reservas</label>
                    </div>
                    <div class="flex items-center gap-2">
                        {{ form.pause_extends_end_date }}
                        <label class="text-xs text-slate-600">Extiende Fecha</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-6 pt-4">
            <div class="flex items-center gap-3">
                {{ form.is_active }}
                <label class="text-sm font-medium">Activo</label>
            </div>
            <div class="flex items-center gap-3">
                {{ form.is_visible_online }}
                <label class="text-sm font-medium">Venta Online</label>
            </div>
        </div>

        <!-- RESTRICCIONES DE ELEGIBILIDAD -->
        <div class="pt-6 border-t border-slate-100">
            <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-5 rounded-xl border-2 border-amber-200">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="font-bold text-amber-900 text-sm">Restricciones de Elegibilidad</span>
                    <span class="text-[10px] bg-amber-200 text-amber-700 px-2 py-0.5 rounded-full">Ofertas Segmentadas</span>
                </div>

                <div class="space-y-4">
                    <div class="bg-white rounded-lg p-4 border border-amber-100">
                        <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">¬øQui√©n puede comprar este plan?</label>
                        {{ form.eligibility_criteria }}
                        <div class="mt-3 text-[10px] text-slate-500 grid grid-cols-2 gap-x-4 gap-y-1">
                            <p>‚Ä¢ <strong>Sin restricci√≥n:</strong> Disponible para todos</p>
                            <p>‚Ä¢ <strong>Nunca tuvo membres√≠a:</strong> Nuevos clientes</p>
                            <p>‚Ä¢ <strong>Nunca compr√≥ este plan:</strong> Primera compra</p>
                            <p>‚Ä¢ <strong>Ya compr√≥ este plan:</strong> Fidelizaci√≥n</p>
                            <p>‚Ä¢ <strong>Sin membres√≠a activa:</strong> Captaci√≥n</p>
                            <p>‚Ä¢ <strong>Con membres√≠a activa:</strong> Upgrades</p>
                            <p>‚Ä¢ <strong>Registrado recientemente:</strong> Bienvenida</p>
                            <p>‚Ä¢ <strong>Inactivo X meses:</strong> Re-captaci√≥n</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4" id="eligibility-options">
                        <div class="bg-white rounded-lg p-4 border border-amber-100">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Umbral (D√≠as/Meses)</label>
                            {{ form.eligibility_days_threshold }}
                            <p class="text-[10px] text-amber-700 mt-1">Solo para criterios con tiempo</p>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-amber-100">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Si NO es elegible...</label>
                            {{ form.visibility_for_ineligible }}
                            <p class="text-[10px] text-amber-700 mt-1">Ocultar = no ve el plan. Bloqueado = ve pero no compra.</p>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-amber-100">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Texto del Badge</label>
                            {{ form.eligibility_badge_text }}
                            <p class="text-[10px] text-amber-700 mt-1">Ej: üéÅ Solo Nuevos, ‚≠ê VIP</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Propagation (Franchise Owners Only) -->
    {% if form.propagate_to_gyms %}
    <div class="mt-8 pt-6 border-t border-slate-200 bg-slate-50/50 -mx-6 px-6 pb-6 rounded-b-xl">
        <div class="flex items-center gap-2 mb-4">
            <span class="bg-indigo-100 text-indigo-700 p-1.5 rounded-lg">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
            </span>
            <div>
                <h3 class="font-bold text-slate-900 text-sm">Propagar a Franquicia</h3>
                <p class="text-xs text-slate-500">Copia o actualiza esta cuota en otros gimnasios.</p>
            </div>
        </div>

        <div class="space-y-2">
            <div class="flex items-center justify-between mb-2">
                <label class="block text-xs font-bold text-slate-500 uppercase">Seleccionar Gimnasios</label>
                <button type="button"
                    onclick="document.querySelectorAll('input[name=\'propagate_to_gyms\']').forEach(c => c.checked = true)"
                    class="text-[10px] font-bold text-[var(--brand-color)] hover:underline">
                    Seleccionar Todos
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                {% for checkbox in form.propagate_to_gyms %}
                <label
                    class="flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-200 cursor-pointer hover:border-[var(--brand-color)] hover:shadow-sm transition-all">
                    {{ checkbox.tag }}
                    <span class="text-xs font-medium text-slate-700 truncate">{{ checkbox.choice_label }}</span>
                </label>
                {% endfor %}
            </div>
            <p class="text-[10px] text-slate-400 mt-2">
                <strong>Nota:</strong> Se copiar√°n tambi√©n las reglas de acceso (creando categor√≠as si faltan).
            </p>
        </div>
    </div>
    {% endif %}
    </div>

    <!-- ACCESS RULES SECTION -->
    <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-sm space-y-6">
        <h3 class="font-bold text-slate-800 border-b border-slate-100 pb-2 flex items-center justify-between">
            <span>2. Reglas de Acceso</span>
            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-full font-normal">Define qu√© incluye esta
                cuota</span>
        </h3>

        <div class="space-y-4 overflow-x-auto">
            {{ formset.management_form }}

            <table class="w-full text-sm text-left min-w-[800px]">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                    <tr>
                        <th class="px-3 py-2 w-1/4">Actividad (Cat / Espec√≠fica)</th>
                        <th class="px-3 py-2 w-1/4">Servicio (Cat / Espec√≠fico)</th>
                        <th class="px-3 py-2 w-24">Cant.</th>
                        <th class="px-3 py-2">Periodo</th>
                        <th class="px-3 py-2 w-10">Eliminar</th>
                    </tr>
                </thead>
                <tbody id="access-rules-body">
                    <!-- Contract -->
                    <div class="bg-white border border-slate-200 rounded-2xl p-6 mb-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Contrato y T√©rminos</h3>

                        <div class="mb-4">
                            <label
                                class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                                {{ form.contract_required }}
                                <span class="text-sm font-medium text-slate-700">Requiere firma de contrato al
                                    contratar</span>
                            </label>
                        </div>

                        <div x-show="true" class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Contenido del Contrato</label>
                            {{ form.contract_content }}
                            <p class="text-xs text-slate-500">Este texto se mostrar√° al cliente y deber√°
                                aceptarlo/firmarlo para completar la contrataci√≥n.</p>
                        </div>
                    </div>

                    <!-- Access Rules (Dynamic Formset) -->
                    {% for rule_form in formset %}
                    <tr class="border-b border-slate-100 rule-row {% if rule_form.DELETE.value %}hidden{% endif %}">
                        <td class="px-3 py-3 space-y-2">
                            {{ rule_form.id }}
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-0.5">Categor√≠a</span>
                                {{ rule_form.activity_category }}
                            </div>
                            <div class="text-center text-[10px] text-slate-300 font-bold">- O -</div>
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-0.5">Espec√≠fica</span>
                                {{ rule_form.activity }}
                            </div>
                        </td>
                        <td class="px-3 py-3 space-y-2">
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-0.5">Categor√≠a</span>
                                {{ rule_form.service_category }}
                            </div>
                            <div class="text-center text-[10px] text-slate-300 font-bold">- O -</div>
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-0.5">Espec√≠fico</span>
                                {{ rule_form.service }}
                            </div>
                        </td>
                        <td class="px-3 py-3 align-top pt-8">{{ rule_form.quantity }}</td>
                        <td class="px-3 py-3 align-top pt-8">{{ rule_form.period }}</td>
                        <td class="px-3 py-3 align-top pt-8 text-center">
                            <div class="hidden">
                                {{ rule_form.DELETE }}
                            </div>
                            <button type="button" class="text-red-400 hover:text-red-600 delete-row-btn"
                                title="Eliminar fila">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="button" id="add-rule-btn"
                class="mt-4 text-sm font-bold text-[var(--brand-color)] flex items-center gap-2 hover:underline">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                A√±adir otra regla / concepto
            </button>
        </div>
    </div>

    <div class="flex gap-4 mt-8 justify-end pb-12">
        <a href="{% url 'membership_plan_list' %}"
            class="px-6 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors">Cancelar</a>
        <button type="submit" style="background-color: #0f172a;"
            class="px-8 py-3 bg-slate-900 text-white font-bold rounded-xl hover:opacity-90 transition-opacity shadow-lg shadow-slate-900/20">
            Guardar Plan
        </button>
    </div>
</form>

<!-- Empty Form Template for JS -->
<table style="display:none">
    <tbody id="empty-form-row">
        <tr class="border-b border-slate-100 rule-row bg-slate-50/50">
            <td class="px-3 py-3 space-y-2">
                {{ formset.empty_form.id }}
                <div>
                    <span class="text-[10px] text-slate-400 block mb-0.5">Categor√≠a</span>
                    {{ formset.empty_form.activity_category }}
                </div>
                <div class="text-center text-[10px] text-slate-300 font-bold">- O -</div>
                <div>
                    <span class="text-[10px] text-slate-400 block mb-0.5">Espec√≠fica</span>
                    {{ formset.empty_form.activity }}
                </div>
            </td>
            <td class="px-3 py-3 space-y-2">
                <div>
                    <span class="text-[10px] text-slate-400 block mb-0.5">Categor√≠a</span>
                    {{ formset.empty_form.service_category }}
                </div>
                <div class="text-center text-[10px] text-slate-300 font-bold">- O -</div>
                <div>
                    <span class="text-[10px] text-slate-400 block mb-0.5">Espec√≠fico</span>
                    {{ formset.empty_form.service }}
                </div>
            </td>
            <td class="px-3 py-3 align-top pt-8">{{ formset.empty_form.quantity }}</td>
            <td class="px-3 py-3 align-top pt-8">{{ formset.empty_form.period }}</td>
            <td class="px-3 py-3 align-top pt-8 text-center">
                <button type="button" class="text-red-400 hover:text-red-600 delete-row-btn" title="Eliminar fila">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                </button>
                <div class="hidden">
                    {{ formset.empty_form.DELETE }}
                </div>
            </td>
        </tr>
    </tbody>
</table>

<script>
    // Alpine.js components for price calculations
    document.addEventListener('alpine:init', () => {
        // Global tax rates map
        window.taxRatesMap = {};
        const taxSelect = document.querySelector('[name="tax_rate"]');
        
        if (taxSelect) {
            Array.from(taxSelect.options).forEach(opt => {
                if (opt.value) {
                    const match = opt.text.match(/(\d+(?:[\.,]\d+)?)%/);
                    window.taxRatesMap[opt.value] = match ? parseFloat(match[1].replace(',', '.')) / 100 : 0;
                }
            });
        }
        
        // Price Calculator component (for top price box)
        Alpine.data('priceCalculator', () => ({
            hasEnrollmentFee: {{ form.has_enrollment_fee.value|yesno:'true,false' }},
            enrollmentFee: {{ form.enrollment_fee.value|default:'0' }},
            enrollmentFeeDisplay: '0.00',
            totalFirstPayment: '0.00',
            
            init() {
                this.calculate();
                
                // Listen to all relevant changes
                const enrollmentCheckbox = document.querySelector('[name="has_enrollment_fee"]');
                const enrollmentInput = document.querySelector('[name="enrollment_fee"]');
                const enrollmentTaxSelect = document.querySelector('[name="enrollment_fee_tax_rate"]');
                const enrollmentStrategySelect = document.querySelector('[name="enrollment_fee_price_strategy"]');
                const basePriceInput = document.querySelector('[name="base_price"]');
                const taxRateSelect = document.querySelector('[name="tax_rate"]');
                const strategySelect = document.querySelector('[name="price_strategy"]');
                
                // Watch checkbox changes
                if (enrollmentCheckbox) {
                    enrollmentCheckbox.addEventListener('change', () => {
                        this.hasEnrollmentFee = enrollmentCheckbox.checked;
                        this.calculate();
                    });
                }
                
                // Watch all inputs
                [enrollmentInput, enrollmentTaxSelect, enrollmentStrategySelect, basePriceInput, taxRateSelect, strategySelect].forEach(el => {
                    if (el) {
                        el.addEventListener('input', () => this.calculate());
                        el.addEventListener('change', () => this.calculate());
                    }
                });
            },
            
            calculate() {
                const enrollmentInput = document.querySelector('[name="enrollment_fee"]');
                const enrollmentTaxSelect = document.querySelector('[name="enrollment_fee_tax_rate"]');
                const enrollmentStrategySelect = document.querySelector('[name="enrollment_fee_price_strategy"]');
                const finalPriceEl = document.getElementById('finalPriceDisplay');
                
                const enrollmentBase = parseFloat(enrollmentInput?.value) || 0;
                const enrollmentTaxId = enrollmentTaxSelect?.value;
                const enrollmentStrategy = enrollmentStrategySelect?.value || 'TAX_INCLUDED';
                const enrollmentTaxRate = window.taxRatesMap[enrollmentTaxId] || 0;
                
                // Calculate enrollment fee final price
                let enrollmentFinal = enrollmentBase;
                if (enrollmentStrategy === 'TAX_EXCLUDED' && enrollmentTaxRate > 0) {
                    enrollmentFinal = enrollmentBase * (1 + enrollmentTaxRate);
                }
                
                this.enrollmentFee = enrollmentBase;
                this.enrollmentFeeDisplay = enrollmentFinal.toFixed(2);
                
                // Get cuota final price
                const cuotaFinal = parseFloat(finalPriceEl?.textContent) || 0;
                this.totalFirstPayment = (cuotaFinal + enrollmentFinal).toFixed(2);
            }
        }));
        
        // Enrollment Fee Section component
        Alpine.data('enrollmentFeeSection', () => ({
            hasEnrollmentFee: {{ form.has_enrollment_fee.value|yesno:'true,false' }},
            enrollmentFeeDisplay: '0.00',
            
            init() {
                this.calculate();
                
                const enrollmentInput = document.querySelector('[name="enrollment_fee"]');
                const enrollmentTaxSelect = document.querySelector('[name="enrollment_fee_tax_rate"]');
                const enrollmentStrategySelect = document.querySelector('[name="enrollment_fee_price_strategy"]');
                
                [enrollmentInput, enrollmentTaxSelect, enrollmentStrategySelect].forEach(el => {
                    if (el) {
                        el.addEventListener('input', () => this.calculate());
                        el.addEventListener('change', () => this.calculate());
                    }
                });
            },
            
            calculate() {
                const enrollmentInput = document.querySelector('[name="enrollment_fee"]');
                const enrollmentTaxSelect = document.querySelector('[name="enrollment_fee_tax_rate"]');
                const enrollmentStrategySelect = document.querySelector('[name="enrollment_fee_price_strategy"]');
                
                const enrollmentBase = parseFloat(enrollmentInput?.value) || 0;
                const enrollmentTaxId = enrollmentTaxSelect?.value;
                const enrollmentStrategy = enrollmentStrategySelect?.value || 'TAX_INCLUDED';
                const enrollmentTaxRate = window.taxRatesMap[enrollmentTaxId] || 0;
                
                // Calculate enrollment fee final price
                let enrollmentFinal = enrollmentBase;
                if (enrollmentStrategy === 'TAX_EXCLUDED' && enrollmentTaxRate > 0) {
                    enrollmentFinal = enrollmentBase * (1 + enrollmentTaxRate);
                }
                
                this.enrollmentFeeDisplay = enrollmentFinal.toFixed(2);
            },
            
            updatePriceCalculator() {
                // Trigger recalculation on the price calculator
                window.dispatchEvent(new CustomEvent('enrollment-fee-changed'));
            }
        }));
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- TAX RATES DATA ---
        // Create a map of TaxRateID -> RatePercent from the select options
        // We can't easily rely on text parsing. Better if we had a data object.
        // But since we are rendering the select options via Django form widget, we can try to parse once on load 
        // OR better: iterate over the options and build a map.
        const taxRatesMap = {};
        const taxSelect = document.querySelector('[name="tax_rate"]');
        if (taxSelect) {
            Array.from(taxSelect.options).forEach(opt => {
                if (opt.value) {
                    // Try to find percentage in text e.g. "IVA (21%)" or "IVA 21%"
                    // If not found, default to 0. 
                    const match = opt.text.match(/(\d+(?:[\.,]\d+)?)%/);
                    if (match) {
                        taxRatesMap[opt.value] = parseFloat(match[1].replace(',', '.')) / 100;
                    } else {
                        taxRatesMap[opt.value] = 0;
                    }
                }
            });
        }

        // --- FORMSET LOGIC ---
        const addBtn = document.getElementById('add-rule-btn');
        const tbody = document.getElementById('access-rules-body');
        const emptyRowTemplate = document.getElementById('empty-form-row').firstElementChild;
        const totalFormsInput = document.getElementById('id_access_rules-TOTAL_FORMS');

        // Helper to attach event listeners to a row
        function attachRowEvents(row) {
            const deleteBtn = row.querySelector('.delete-row-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function () {
                    const deleteInput = row.querySelector('input[name$="-DELETE"]');
                    if (deleteInput) {
                        // For existing rows (with ID)
                        deleteInput.checked = true;
                        // Usually we hide the row
                        row.classList.add('hidden');
                        row.style.display = 'none';
                    } else {
                        // For dynamic rows (check if it has an ID field with value)
                        const idInput = row.querySelector('input[name$="-id"]');
                        if (idInput && idInput.value) {
                            // Has DB ID -> Soft Delete
                            row.style.display = 'none';
                            // Assuming there's a DELETE input for it too if it has ID?
                            // Actually django formsets usually render DELETE input for all bound forms.
                            // If it's a new unsaved row (but has form errors), it might appear bound but not have DB ID.
                        } else {
                            row.remove();
                        }
                    }
                });
            }
        }

        if (addBtn) {
            addBtn.addEventListener('click', function () {
                const formIdx = parseInt(totalFormsInput.value);
                const newRow = emptyRowTemplate.cloneNode(true);
                newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formIdx);

                // Attach events
                attachRowEvents(newRow);

                tbody.appendChild(newRow);
                totalFormsInput.value = formIdx + 1;
            });
        }

        // Attach to existing rows
        document.querySelectorAll('#access-rules-body .rule-row').forEach(row => {
            attachRowEvents(row);
        });

        // --- PRICE CALCULATION LOGIC ---
        const basePriceInput = document.querySelector('[name="base_price"]');
        const strategySelect = document.querySelector('[name="price_strategy"]');
        const finalPriceDisplay = document.getElementById('finalPriceDisplay');

        function calculatePrice() {
            const basePrice = parseFloat(basePriceInput.value) || 0;
            const strategy = strategySelect.value;
            let rate = 0;

            if (taxSelect && taxSelect.value) {
                rate = taxRatesMap[taxSelect.value] || 0;
            }

            let finalPrice = basePrice;
            if (strategy === 'TAX_EXCLUDED') {
                finalPrice = basePrice * (1 + rate);
            }

            finalPriceDisplay.textContent = finalPrice.toFixed(2);
        }

        if (basePriceInput) basePriceInput.addEventListener('input', calculatePrice);
        if (taxSelect) taxSelect.addEventListener('change', calculatePrice);
        if (strategySelect) strategySelect.addEventListener('change', calculatePrice);

        // Init
        calculatePrice();
    });
</script>
{% endblock %}