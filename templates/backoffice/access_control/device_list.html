{% extends "backoffice/base.html" %}

{% block title %}Dispositivos de Acceso{% endblock %}

{% block breadcrumb %}
<a href="{% url 'access_control:dashboard' %}" class="hover:underline">Control de Acceso</a> > Dispositivos
{% endblock %}

{% block page_title %}
<div class="flex items-center gap-3">
    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
        </svg>
    </div>
    <div>
        <h1 class="text-xl font-bold text-slate-800">Dispositivos de Acceso</h1>
        <p class="text-sm text-slate-500">{{ total_devices }} dispositivo{{ total_devices|pluralize:"s" }} configurado{{ total_devices|pluralize:"s" }}</p>
    </div>
</div>
{% endblock %}

{% block page_actions %}
<div class="flex items-center gap-3">
    <a href="{% url 'access_control:dashboard' %}" class="btn-brand-outline px-4 py-2 text-sm">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Dashboard
    </a>
    <a href="{% url 'access_control:device_create' %}" class="btn-brand px-4 py-2 text-sm">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Nuevo Dispositivo
    </a>
</div>
{% endblock %}

{% block content %}
<div x-data="deviceManager()" class="space-y-6">
    <!-- Resumen rápido -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="text-2xl font-bold text-slate-800">{{ total_devices }}</div>
            <div class="text-sm text-slate-500">Total dispositivos</div>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="text-2xl font-bold text-green-600">{{ online_devices }}</div>
            <div class="text-sm text-slate-500">En línea</div>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="text-2xl font-bold text-red-600">{{ offline_devices }}</div>
            <div class="text-sm text-slate-500">Desconectados</div>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="text-2xl font-bold text-amber-600">{{ warning_devices }}</div>
            <div class="text-sm text-slate-500">Con alertas</div>
        </div>
    </div>

    <!-- Barra de herramientas -->
    <div class="bg-white rounded-xl border border-slate-200 p-4">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <!-- Búsqueda y filtros -->
            <div class="flex flex-col sm:flex-row gap-3 flex-1">
                <!-- Búsqueda -->
                <div class="relative flex-1 max-w-sm">
                    <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" 
                           x-model="searchQuery" 
                           @input="filterDevices()"
                           placeholder="Buscar por nombre o ubicación..." 
                           class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-[var(--brand-color)]/20 focus:border-[var(--brand-color)]">
                </div>
                
                <!-- Filtro por tipo -->
                <select x-model="filterType" @change="filterDevices()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white">
                    <option value="">Todos los tipos</option>
                    <option value="TURNSTILE">Tornos</option>
                    <option value="DOOR">Puertas</option>
                    <option value="RFID_READER">Lectores RFID</option>
                    <option value="QR_SCANNER">Escáneres QR</option>
                    <option value="BIOMETRIC">Biométricos</option>
                </select>
                
                <!-- Filtro por estado -->
                <select x-model="filterStatus" @change="filterDevices()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white">
                    <option value="">Todos los estados</option>
                    <option value="online">En línea</option>
                    <option value="offline">Desconectados</option>
                </select>
                
                <!-- Filtro por zona -->
                <select x-model="filterZone" @change="filterDevices()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white">
                    <option value="">Todas las zonas</option>
                    {% for zone in zones %}
                    <option value="{{ zone.id }}">{{ zone.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Acciones y vista -->
            <div class="flex items-center gap-3">
                <!-- Acciones masivas -->
                <div x-show="selectedDevices.length > 0" x-transition class="flex items-center gap-2">
                    <span class="text-sm text-slate-600" x-text="selectedDevices.length + ' seleccionado' + (selectedDevices.length > 1 ? 's' : '')"></span>
                    <button @click="bulkAction('test')" class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                        Probar
                    </button>
                    <button @click="bulkAction('enable')" class="px-3 py-1.5 text-xs font-medium text-green-600 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                        Activar
                    </button>
                    <button @click="bulkAction('disable')" class="px-3 py-1.5 text-xs font-medium text-amber-600 bg-amber-50 hover:bg-amber-100 rounded-lg transition-colors">
                        Desactivar
                    </button>
                </div>
                
                <!-- Toggle vista -->
                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden">
                    <button @click="viewMode = 'grid'" 
                            :class="viewMode === 'grid' ? 'bg-slate-100 text-slate-700' : 'text-slate-400 hover:bg-slate-50'"
                            class="p-2 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                    </button>
                    <button @click="viewMode = 'list'" 
                            :class="viewMode === 'list' ? 'bg-slate-100 text-slate-700' : 'text-slate-400 hover:bg-slate-50'"
                            class="p-2 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vista Grid -->
    <div x-show="viewMode === 'grid'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for device in devices %}
        <div class="device-card bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-shadow"
             data-id="{{ device.id }}"
             data-name="{{ device.name|lower }}"
             data-type="{{ device.device_type }}"
             data-status="{% if device.is_online %}online{% else %}offline{% endif %}"
             data-zone="{{ device.zone.id|default:'' }}"
             data-location="{{ device.location|lower|default:'' }}">
            <!-- Header con checkbox y estado -->
            <div class="p-4 border-b border-slate-100">
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" 
                               class="device-checkbox w-4 h-4 rounded border-slate-300 text-[var(--brand-color)] focus:ring-[var(--brand-color)]"
                               :checked="selectedDevices.includes({{ device.id }})"
                               @change="toggleDevice({{ device.id }})">
                        <!-- Icono según tipo -->
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center
                            {% if device.device_type == 'TURNSTILE' %}bg-purple-100
                            {% elif device.device_type == 'DOOR' %}bg-blue-100
                            {% elif device.device_type == 'RFID_READER' %}bg-green-100
                            {% elif device.device_type == 'QR_SCANNER' %}bg-amber-100
                            {% elif device.device_type == 'BIOMETRIC' %}bg-pink-100
                            {% else %}bg-slate-100{% endif %}">
                            {% if device.device_type == 'TURNSTILE' %}
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                            </svg>
                            {% elif device.device_type == 'DOOR' %}
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
                            </svg>
                            {% elif device.device_type == 'RFID_READER' %}
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                            </svg>
                            {% elif device.device_type == 'QR_SCANNER' %}
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                            </svg>
                            {% elif device.device_type == 'BIOMETRIC' %}
                            <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"></path>
                            </svg>
                            {% else %}
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                            </svg>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Estado online/offline -->
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full {% if device.is_online %}bg-green-500 animate-pulse{% else %}bg-red-500{% endif %}"></span>
                        <span class="text-xs {% if device.is_online %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if device.is_online %}Online{% else %}Offline{% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h3 class="font-semibold text-slate-800 truncate">{{ device.name }}</h3>
                    <p class="text-xs text-slate-500">{{ device.get_device_type_display }}</p>
                </div>
            </div>
            
            <!-- Detalles compactos -->
            <div class="p-4 space-y-2 text-sm">
                {% if device.location %}
                <div class="flex items-center gap-2 text-slate-600">
                    <svg class="w-3.5 h-3.5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <span class="truncate">{{ device.location }}</span>
                </div>
                {% endif %}
                
                {% if device.zone %}
                <div class="flex items-center gap-2 text-slate-600">
                    <svg class="w-3.5 h-3.5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span class="truncate">{{ device.zone.name }}</span>
                </div>
                {% endif %}
                
                <div class="flex items-center justify-between pt-2 mt-2 border-t border-slate-100">
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-600">{{ device.today_entries|default:0 }}</div>
                        <div class="text-xs text-slate-400">Entradas</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-orange-600">{{ device.today_exits|default:0 }}</div>
                        <div class="text-xs text-slate-400">Salidas</div>
                    </div>
                </div>
            </div>
            
            <!-- Acciones -->
            <div class="px-4 py-3 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                <a href="{% url 'access_control:device_edit' device.id %}" class="text-xs text-[var(--brand-color)] hover:underline">
                    Editar
                </a>
                <button @click="testDevice({{ device.id }})" class="text-xs text-slate-500 hover:text-slate-700">
                    Probar
                </button>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full">
            <div class="bg-white rounded-2xl border border-slate-200 p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">No hay dispositivos configurados</h3>
                <p class="text-slate-500 mb-6">Añade tu primer dispositivo de control de acceso para empezar.</p>
                <a href="{% url 'access_control:device_create' %}" class="inline-flex items-center justify-center gap-2 bg-[var(--brand-color)] hover:bg-[var(--brand-color-dark)] text-white font-semibold px-6 py-3 rounded-xl transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Añadir Dispositivo
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Vista Lista -->
    <div x-show="viewMode === 'list'" class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-4 py-3 text-left">
                            <input type="checkbox" 
                                   @change="toggleAll($event.target.checked)"
                                   class="w-4 h-4 rounded border-slate-300 text-[var(--brand-color)] focus:ring-[var(--brand-color)]">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Dispositivo</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tipo</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Ubicación</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Zona</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Estado</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Hoy</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Última conexión</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for device in devices %}
                    <tr class="device-row hover:bg-slate-50 transition-colors"
                        data-id="{{ device.id }}"
                        data-name="{{ device.name|lower }}"
                        data-type="{{ device.device_type }}"
                        data-status="{% if device.is_online %}online{% else %}offline{% endif %}"
                        data-zone="{{ device.zone.id|default:'' }}"
                        data-location="{{ device.location|lower|default:'' }}">
                        <td class="px-4 py-3">
                            <input type="checkbox" 
                                   class="device-checkbox w-4 h-4 rounded border-slate-300 text-[var(--brand-color)] focus:ring-[var(--brand-color)]"
                                   :checked="selectedDevices.includes({{ device.id }})"
                                   @change="toggleDevice({{ device.id }})">
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center
                                    {% if device.device_type == 'TURNSTILE' %}bg-purple-100
                                    {% elif device.device_type == 'DOOR' %}bg-blue-100
                                    {% elif device.device_type == 'RFID_READER' %}bg-green-100
                                    {% elif device.device_type == 'QR_SCANNER' %}bg-amber-100
                                    {% elif device.device_type == 'BIOMETRIC' %}bg-pink-100
                                    {% else %}bg-slate-100{% endif %}">
                                    {% if device.device_type == 'TURNSTILE' %}
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                                    </svg>
                                    {% elif device.device_type == 'DOOR' %}
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12"></path>
                                    </svg>
                                    {% elif device.device_type == 'RFID_READER' %}
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01"></path>
                                    </svg>
                                    {% elif device.device_type == 'QR_SCANNER' %}
                                    <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4"></path>
                                    </svg>
                                    {% elif device.device_type == 'BIOMETRIC' %}
                                    <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571"></path>
                                    </svg>
                                    {% else %}
                                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2"></path>
                                    </svg>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="font-medium text-slate-800">{{ device.name }}</div>
                                    <div class="text-xs text-slate-400">ID: {{ device.device_id|default:device.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-600">{{ device.get_device_type_display }}</td>
                        <td class="px-4 py-3 text-sm text-slate-600">{{ device.location|default:"-" }}</td>
                        <td class="px-4 py-3 text-sm text-slate-600">{{ device.zone.name|default:"-" }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if device.is_online %}
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                Online
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                                Offline
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-green-600 font-medium">{{ device.today_entries|default:0 }}</span>
                            <span class="text-slate-400">/</span>
                            <span class="text-orange-600 font-medium">{{ device.today_exits|default:0 }}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-xs text-slate-500">
                            {% if device.last_heartbeat %}
                            {{ device.last_heartbeat|timesince }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-1">
                                <button @click="testDevice({{ device.id }})" 
                                        class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" 
                                        title="Probar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                                <a href="{% url 'access_control:device_edit' device.id %}" 
                                   class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" 
                                   title="Editar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-4 py-12 text-center">
                            <svg class="w-12 h-12 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                            </svg>
                            <h3 class="font-semibold text-slate-800 mb-1">No hay dispositivos configurados</h3>
                            <p class="text-sm text-slate-500 mb-4">Añade tu primer dispositivo de control de acceso.</p>
                            <a href="{% url 'access_control:device_create' %}" class="inline-flex items-center justify-center gap-2 bg-[var(--brand-color)] hover:bg-[var(--brand-color-dark)] text-white font-semibold px-5 py-2.5 rounded-xl text-sm transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Añadir Dispositivo
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Contador de filtrados -->
    <div x-show="filteredCount !== totalCount" class="text-center text-sm text-slate-500">
        Mostrando <span x-text="filteredCount" class="font-medium"></span> de <span x-text="totalCount" class="font-medium"></span> dispositivos
    </div>
</div>

<script>
function deviceManager() {
    return {
        viewMode: 'grid',
        searchQuery: '',
        filterType: '',
        filterStatus: '',
        filterZone: '',
        selectedDevices: [],
        totalCount: {{ devices|length }},
        filteredCount: {{ devices|length }},
        
        filterDevices() {
            const cards = document.querySelectorAll('.device-card');
            const rows = document.querySelectorAll('.device-row');
            let count = 0;
            
            [...cards, ...rows].forEach(el => {
                const name = el.dataset.name || '';
                const location = el.dataset.location || '';
                const type = el.dataset.type || '';
                const status = el.dataset.status || '';
                const zone = el.dataset.zone || '';
                
                let show = true;
                
                // Búsqueda
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    if (!name.includes(query) && !location.includes(query)) {
                        show = false;
                    }
                }
                
                // Filtro tipo
                if (this.filterType && type !== this.filterType) {
                    show = false;
                }
                
                // Filtro estado
                if (this.filterStatus && status !== this.filterStatus) {
                    show = false;
                }
                
                // Filtro zona
                if (this.filterZone && zone !== this.filterZone) {
                    show = false;
                }
                
                el.style.display = show ? '' : 'none';
                if (show) count++;
            });
            
            // Dividir por 2 porque hay cards Y rows
            this.filteredCount = count / 2;
        },
        
        toggleDevice(id) {
            const idx = this.selectedDevices.indexOf(id);
            if (idx > -1) {
                this.selectedDevices.splice(idx, 1);
            } else {
                this.selectedDevices.push(id);
            }
        },
        
        toggleAll(checked) {
            if (checked) {
                this.selectedDevices = [...document.querySelectorAll('.device-card:not([style*="display: none"])')].map(el => parseInt(el.dataset.id));
            } else {
                this.selectedDevices = [];
            }
        },
        
        async testDevice(deviceId) {
            if (confirm('¿Enviar comando de prueba al dispositivo?')) {
                try {
                    const response = await fetch(`/access/api/device/${deviceId}/test/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    alert(data.success ? 'Comando de prueba enviado correctamente' : ('Error: ' + (data.error || 'No se pudo enviar el comando')));
                } catch (error) {
                    alert('Error de conexión');
                }
            }
        },
        
        async bulkAction(action) {
            const actionNames = {
                'test': 'probar',
                'enable': 'activar',
                'disable': 'desactivar'
            };
            
            if (!confirm(`¿${actionNames[action].charAt(0).toUpperCase() + actionNames[action].slice(1)} ${this.selectedDevices.length} dispositivo(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch('{% url "access_control:api_device_bulk" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        device_ids: this.selectedDevices
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message || 'Acción completada');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo completar la acción'));
                }
            } catch (error) {
                alert('Error de conexión');
            }
        }
    };
}
</script>
{% endblock %}
