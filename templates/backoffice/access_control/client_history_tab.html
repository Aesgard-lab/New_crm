{% load static %}
{# Pestaña de historial de accesos para incluir en la ficha del cliente #}

<div class="space-y-6">
    <!-- Resumen de accesos -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-slate-50 rounded-xl p-4">
            <div class="text-2xl font-bold text-slate-800">{{ access_stats.total_visits|default:0 }}</div>
            <div class="text-sm text-slate-500">Visitas totales</div>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
            <div class="text-2xl font-bold text-green-600">{{ access_stats.this_month|default:0 }}</div>
            <div class="text-sm text-slate-500">Este mes</div>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
            <div class="text-2xl font-bold text-blue-600">{{ access_stats.avg_duration|default:"-" }}</div>
            <div class="text-sm text-slate-500">Duración promedio</div>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
            <div class="text-sm text-slate-500 mb-1">Última visita</div>
            <div class="font-medium text-slate-800">
                {% if access_stats.last_visit %}
                {{ access_stats.last_visit|date:"d/m/Y H:i" }}
                {% else %}
                Sin visitas
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Credenciales del cliente -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                </svg>
                Credenciales de Acceso
            </h3>
            <button type="button" 
                    onclick="openCredentialModal()"
                    class="btn-brand-outline px-3 py-1.5 text-sm">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Añadir Credencial
            </button>
        </div>
        
        <div class="divide-y divide-slate-100">
            {% for credential in credentials %}
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <!-- Icono según tipo -->
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center
                        {% if credential.credential_type == 'RFID' %}bg-green-100
                        {% elif credential.credential_type == 'QR_DYNAMIC' %}bg-purple-100
                        {% elif credential.credential_type == 'PIN' %}bg-blue-100
                        {% elif credential.credential_type == 'FINGERPRINT' %}bg-pink-100
                        {% elif credential.credential_type == 'FACE' %}bg-amber-100
                        {% else %}bg-slate-100{% endif %}">
                        {% if credential.credential_type == 'RFID' %}
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                        </svg>
                        {% elif credential.credential_type == 'QR_DYNAMIC' %}
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        {% elif credential.credential_type == 'PIN' %}
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        {% elif credential.credential_type == 'FINGERPRINT' %}
                        <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    
                    <div>
                        <div class="font-medium text-slate-800">{{ credential.get_credential_type_display }}</div>
                        <div class="text-sm text-slate-500">
                            {% if credential.credential_type == 'RFID' %}
                            Tarjeta: {{ credential.credential_value|slice:":8" }}...
                            {% elif credential.credential_type == 'PIN' %}
                            PIN: ****
                            {% elif credential.credential_type == 'QR_DYNAMIC' %}
                            QR dinámico activo
                            {% else %}
                            Registrado
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Estado -->
                    {% if credential.is_active %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        Activo
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        Inactivo
                    </span>
                    {% endif %}
                    
                    <!-- Acciones -->
                    <div class="flex items-center gap-1">
                        {% if credential.credential_type == 'QR_DYNAMIC' %}
                        <button onclick="showQR({{ credential.id }})" 
                                class="p-2 text-slate-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                                title="Mostrar QR">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                            </svg>
                        </button>
                        {% endif %}
                        <button onclick="toggleCredential({{ credential.id }})" 
                                class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                title="{% if credential.is_active %}Desactivar{% else %}Activar{% endif %}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                            </svg>
                        </button>
                        <button onclick="deleteCredential({{ credential.id }})" 
                                class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Eliminar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="p-8 text-center text-slate-500">
                <svg class="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                </svg>
                <p>Este cliente no tiene credenciales de acceso configuradas</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Historial de accesos recientes -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Historial de Accesos
            </h3>
            {% if access_logs %}
            <a href="{% url 'access_control:log_list' %}?client={{ client.id }}" class="text-sm text-[var(--brand-color)] hover:underline">
                Ver todo el historial
            </a>
            {% endif %}
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Fecha/Hora</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tipo</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Dispositivo</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Credencial</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Estado</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for log in access_logs %}
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-slate-800">{{ log.timestamp|date:"d/m/Y" }}</div>
                            <div class="text-xs text-slate-500">{{ log.timestamp|time:"H:i:s" }}</div>
                        </td>
                        <td class="px-6 py-4">
                            {% if log.direction == 'ENTRY' %}
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14"></path>
                                </svg>
                                Entrada
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                                </svg>
                                Salida
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm text-slate-700">{{ log.device.name|default:"-" }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm text-slate-700">{{ log.get_credential_type_display|default:"-" }}</span>
                        </td>
                        <td class="px-6 py-4">
                            {% if log.status == 'GRANTED' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Concedido
                            </span>
                            {% elif log.status == 'DENIED' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Denegado
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                {{ log.get_status_display }}
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-slate-500">
                            No hay registros de acceso para este cliente
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gráfico de visitas (últimos 30 días) -->
    {% if visit_chart_data %}
    <div class="bg-white rounded-xl border border-slate-200 p-6">
        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Visitas - Últimos 30 días
        </h3>
        <canvas id="clientAccessChart" height="100"></canvas>
    </div>
    
    <script>
    const visitData = {{ visit_chart_data|safe }};
    const ctx = document.getElementById('clientAccessChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: visitData.map(d => d.date),
            datasets: [{
                label: 'Visitas',
                data: visitData.map(d => d.count),
                backgroundColor: 'rgba(99, 102, 241, 0.5)',
                borderColor: 'rgb(99, 102, 241)',
                borderWidth: 1,
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
    </script>
    {% endif %}
</div>

<script>
function openCredentialModal() {
    // Abrir modal para añadir credencial
    // Implementar según el sistema de modales del proyecto
    alert('Función de añadir credencial - implementar modal');
}

function showQR(credentialId) {
    // Mostrar QR dinámico del cliente
    window.open('/api/access/credential/' + credentialId + '/qr/', 'qr_window', 'width=400,height=500');
}

function toggleCredential(credentialId) {
    if (confirm('¿Cambiar el estado de esta credencial?')) {
        fetch('/api/access/credential/' + credentialId + '/toggle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'No se pudo cambiar el estado'));
            }
        });
    }
}

function deleteCredential(credentialId) {
    if (confirm('¿Eliminar esta credencial? Esta acción no se puede deshacer.')) {
        fetch('/api/access/credential/' + credentialId + '/delete/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'No se pudo eliminar'));
            }
        });
    }
}
</script>
