{% extends "backoffice/base.html" %}
{% load i18n %}
{% load sanitize_tags %}

{% block title %}{% trans "Informe de Fichajes" %} - {{ request.gym.name }}{% endblock %}

{% block extra_css %}
{% include "backoffice/analytics/partials/_analytics_css.html" %}
<style>
    /* Specific styles for Shift Report */
    .alert-card {
        background: linear-gradient(to right, #fffbeb, #fff7ed);
        border: 1px solid #fde68a;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .alert-icon {
        width: 48px;
        height: 48px;
        background: #fef3c7;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #d97706;
        flex-shrink: 0;
    }

    .alert-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fef3c7;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #b45309;
        font-weight: 700;
        overflow: hidden;
    }

    .alert-item {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid #fef3c7;
        border-radius: 12px;
        padding: 0.75rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stats-kpi-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="analytics-container">

        <!-- Alertas de empleados sin fichar hoy -->
        {% if staff_without_checkin_today %}
        <div class="alert-card">
            <div class="flex items-start gap-4">
                <div class="alert-icon">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-amber-900 mb-3 text-lg">
                        ‚ö†Ô∏è {{ staff_without_checkin_today|length }} empleado{{ staff_without_checkin_today|pluralize:"s"
                        }} sin fichar hoy
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {% for item in staff_without_checkin_today %}
                        <div class="alert-item">
                            <div class="alert-avatar">
                                {% if item.staff.photo %}
                                <img src="{{ item.staff.photo.url }}" class="w-full h-full object-cover">
                                {% else %}
                                {{ item.staff.user.first_name.0 }}{{ item.staff.user.last_name.0 }}
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-slate-900 truncate">
                                    {{ item.staff.user.first_name }} {{ item.staff.user.last_name }}
                                </div>
                                <div class="text-xs text-amber-700">
                                    Esperado: {{ item.expected_time|time:"H:i" }}
                                    {% if item.minutes_late > 0 %}
                                    <span class="text-red-600 font-bold">(+{{ item.minutes_late }} min)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Header -->
        <div class="analytics-header">
            <div>
                <h1 class="analytics-title">
                    <span class="icon-box"
                        style="width: 40px; height: 40px; font-size: 1.25rem; margin-bottom: 0;">üìã</span>
                    {% trans "Informe de Fichajes" %}
                </h1>
                <p class="analytics-subtitle">{% trans "Control de asistencia y alertas del equipo" %}</p>
            </div>

            <!-- Stats Mini -->
            <div class="flex gap-4 items-center">
                <div class="text-right px-4 border-r border-slate-200">
                    <div class="text-xs text-slate-500 uppercase font-bold">Total Fichajes</div>
                    <div class="text-2xl font-extrabold text-slate-800">{{ stats.total_shifts }}</div>
                </div>
                <div class="text-right px-4 border-r border-slate-200">
                    <div class="text-xs text-slate-500 uppercase font-bold">Horas Totales</div>
                    <div class="text-2xl font-extrabold text-[var(--brand-color)]">{{ stats.total_hours }}h</div>
                </div>
                <div class="text-right pl-4">
                    <div class="text-xs text-slate-500 uppercase font-bold">Alertas</div>
                    <div
                        class="text-2xl font-extrabold {% if stats.pending_alerts_count > 0 %}text-amber-500{% else %}text-emerald-500{% endif %}">
                        {{ stats.pending_alerts_count }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <form method="get" class="analytics-filters">
            <div class="filter-group">
                <label class="filter-label">{% trans "Desde" %}</label>
                <input type="date" name="start_date" class="filter-input" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="filter-group">
                <label class="filter-label">{% trans "Hasta" %}</label>
                <input type="date" name="end_date" class="filter-input" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="filter-group" style="flex: 2;">
                <label class="filter-label">{% trans "Empleado" %}</label>
                <select name="staff" class="filter-input">
                    <option value="">{% trans "Todos los empleados" %}</option>
                    {% for member in staff_members %}
                    {% with mpk=member.pk|stringformat:"i" %}
                    <option value="{{ member.pk }}" {% if selected_staff == mpk %}selected{% endif %}>
                        {{ member.user.first_name }} {{ member.user.last_name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" class="btn-brand"
                    style="height: 42px; padding: 0 20px; display: flex; align-items: center; gap: 8px;">
                    <span>üîç</span> {% trans "Filtrar" %}
                </button>
            </div>
        </form>

        <!-- Alertas pendientes -->
        {% if pending_alerts %}
        <div class="analytics-card border-l-4 border-l-red-500">
            <h3 class="font-bold text-red-800 mb-4 flex items-center gap-2 text-lg">
                <span
                    class="icon-box bg-red-100 text-red-600 rounded-lg w-8 h-8 flex items-center justify-center text-sm">‚ö†Ô∏è</span>
                {% trans "Alertas de Fichaje Pendientes" %} ({{ pending_alerts|length }})
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for alert in pending_alerts|slice:":10" %}
                <div
                    class="bg-red-50 rounded-xl p-4 border border-red-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3 w-full">
                        <div
                            class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-700 font-bold shadow-sm">
                            {{ alert.staff.user.first_name.0 }}{{ alert.staff.user.last_name.0 }}
                        </div>
                        <div>
                            <div class="font-bold text-slate-800">
                                {{ alert.staff.user.first_name }} {{ alert.staff.user.last_name }}
                            </div>
                            <div class="text-sm text-slate-600">
                                {{ alert.date|date:"d/m/Y" }} -
                                <span
                                    class="{% if alert.alert_type == 'NO_CHECKIN' %}text-red-600{% else %}text-amber-600{% endif %} font-bold text-xs uppercase">
                                    {{ alert.get_alert_type_display }}
                                </span>
                                {% if alert.expected_time %} ¬∑ <span class="text-xs text-slate-500">Esp: {{
                                    alert.expected_time|time:"H:i" }}</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    <form method="post" action="{% url 'resolve_alert' alert.pk %}"
                        class="flex items-center gap-2 w-full sm:w-auto">
                        {% csrf_token %}
                        <input type="text" name="notes" placeholder="Motivo"
                            class="text-sm rounded-lg border-slate-200 py-2 px-3 focus:ring-2 focus:ring-red-200 focus:border-red-300 w-full sm:w-32">
                        <button type="submit"
                            class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-3 py-2 rounded-lg text-sm font-bold transition-colors shadow-sm">
                            ‚úì
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Historial de Fichajes -->
        <div class="analytics-card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">{% trans "Historial de Fichajes" %}</h3>

                <div class="relative group">
                    <button class="btn-secondary text-sm py-2 px-4">
                        üì• {% trans "Exportar" %}
                    </button>
                    <div
                        class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-slate-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10 p-1">
                        <a href="{% url 'shift_export_excel' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}{% if selected_staff %}&staff={{ selected_staff }}{% endif %}"
                            class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                            <span class="text-green-600">üìä</span> Excel (.xlsx)
                        </a>
                        <a href="{% url 'shift_export_pdf' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}{% if selected_staff %}&staff={{ selected_staff }}{% endif %}"
                            class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                            <span class="text-red-500">üìÑ</span> PDF
                        </a>
                    </div>
                </div>
            </div>

            <div class="analytics-table-container">
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>{% trans "Fecha" %}</th>
                            <th>{% trans "Empleado" %}</th>
                            <th>{% trans "Entrada" %}</th>
                            <th>{% trans "Salida" %}</th>
                            <th>{% trans "Horas" %}</th>
                            <th>{% trans "M√©todo" %}</th>
                            <th class="text-center">{% trans "Estado" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shift in shifts %}
                        <tr>
                            <td>
                                <div class="font-bold text-slate-700">{{ shift.start_time|date:"d/m/Y" }}</div>
                                <div class="text-xs text-slate-400">{{ shift.start_time|date:"l" }}</div>
                            </td>
                            <td>
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-full bg-slate-100/50 flex items-center justify-center text-slate-600 font-bold text-xs overflow-hidden border border-slate-100">
                                        {% if shift.staff.photo %}
                                        <img src="{{ shift.staff.photo.url }}" class="w-full h-full object-cover">
                                        {% else %}
                                        {{ shift.staff.user.first_name.0 }}{{ shift.staff.user.last_name.0 }}
                                        {% endif %}
                                    </div>
                                    <span class="font-semibold text-slate-700">
                                        {{ shift.staff.user.first_name }} {{ shift.staff.user.last_name }}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span
                                    class="font-mono font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded text-xs">{{
                                    shift.start_time|time:"H:i" }}</span>
                            </td>
                            <td>
                                {% if shift.end_time %}
                                <span
                                    class="font-mono font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded text-xs">{{
                                    shift.end_time|time:"H:i" }}</span>
                                {% else %}
                                <span class="text-emerald-500 font-bold text-xs animate-pulse">En curso...</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if shift.end_time %}
                                <span class="font-bold text-slate-800">{{ shift.duration_hours }}h</span>
                                {% else %}
                                <span class="text-slate-300">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if shift.method == 'TABLET' %}bg-blue-100 text-blue-700
                                    {% elif shift.method == 'MOBILE' %}bg-purple-100 text-purple-700
                                    {% elif shift.method == 'MANUAL' %}bg-amber-100 text-amber-700
                                    {% else %}bg-slate-100 text-slate-700{% endif %}">
                                    {{ shift.get_method_display }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if shift.end_time %}
                                <span class="badge bg-slate-100 text-slate-500">
                                    {% trans "Cerrado" %}
                                </span>
                                {% else %}
                                <span class="badge bg-emerald-100 text-emerald-700 animate-pulse">
                                    {% trans "Activo" %}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-12 text-slate-400">
                                <div class="text-4xl mb-3">üì≠</div>
                                <p>{% trans "No hay fichajes en el per√≠odo seleccionado." %}</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}