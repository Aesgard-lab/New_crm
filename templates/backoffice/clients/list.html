{% extends "backoffice/base.html" %}
{% load gym_tags %}
{% load i18n %}

{% block page_title %}{% trans "Clientes" %}{% endblock %}

{% block content %}
<div class="bg-white border border-slate-200 rounded-3xl p-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-lg font-semibold">{% trans "Listado de Clientes" %}</h2>
      <div class="flex items-center gap-2 text-sm text-slate-500">
        <span>{% trans "Gestiona los socios de este gimnasio" %}</span>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">
          {{ paginator.count }} {% trans "resultado" %}{{ paginator.count|pluralize:"s" }}
        </span>
      </div>
    </div>

    <div class="flex gap-2">
      {% has_gym_perm 'clients.create' as can_create %}
      {% if can_create %}
      <div class="flex gap-2">
        <a href="{% url 'client_import' %}"
          class="bg-indigo-50 text-indigo-600 border border-indigo-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-indigo-100 transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          {% trans "Importar CSV" %}
        </a>
        
        <!-- Dropdown Exportar -->
        <div class="relative group">
          <button class="bg-green-50 text-green-600 border border-green-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-green-100 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            {% trans "Descargar" %}
            <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
            </svg>
          </button>
          
          <div class="absolute right-0 mt-2 w-40 bg-white rounded-xl shadow-lg border border-slate-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
            <a href="{% url 'client_export_excel' %}" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 first:rounded-t-xl flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a2 2 0 012-2h10a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V4zm11-1a1 1 0 11-2 0 1 1 0 012 0z"/>
              </svg>
              {% trans "Descargar Excel" %}
            </a>
            <a href="{% url 'client_export_pdf' %}" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 last:rounded-b-xl flex items-center gap-2 border-t border-slate-100">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 10-2 0v2a1 1 0 01-1 1H6a1 1 0 110-2V4zm2 3a1 1 0 000 2h4a1 1 0 000-2H6z"/>
              </svg>
              {% trans "Descargar PDF" %}
            </a>
          </div>
        </div>
        
        <a href="{% url 'client_create' %}"
          class="bg-white text-slate-500 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors">
          + {% trans "Nuevo Cliente" %}
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  <form method="get" class="bg-slate-50 border border-slate-200 rounded-2xl p-4 mb-6">
    <!-- OrdenaciÃ³n -->
    <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-200">
      <div class="flex items-center gap-2">
        <label class="text-xs font-bold text-slate-600">{% trans "Ordenar por" %}:</label>
        <select name="sort" onchange="this.form.submit()"
          class="rounded-lg border-slate-200 text-sm py-1 px-2 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="-created_at" {% if filters.sort == '-created_at' %}selected{% endif %}>{% trans "MÃ¡s recientes" %}</option>
          <option value="created_at" {% if filters.sort == 'created_at' %}selected{% endif %}>{% trans "MÃ¡s antiguos" %}</option>
          <option value="name" {% if filters.sort == 'name' %}selected{% endif %}>{% trans "Nombre A-Z" %}</option>
          <option value="-name" {% if filters.sort == '-name' %}selected{% endif %}>{% trans "Nombre Z-A" %}</option>
          <option value="-last_visit" {% if filters.sort == '-last_visit' %}selected{% endif %}>{% trans "Ãšltima visita (reciente)" %}</option>
          <option value="last_visit" {% if filters.sort == 'last_visit' %}selected{% endif %}>{% trans "Ãšltima visita (antigua)" %}</option>
        </select>
      </div>
      <div class="text-xs text-slate-500">
        <span class="font-medium">{{ paginator.count }}</span> {% trans "clientes encontrados" %}
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Buscar" %}</label>
        <input type="text" name="q" value="{{ filters.q }}" placeholder="{% trans "Nombre, email, telÃ©fono" %}"
          class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500" />
      </div>
      
      <!-- Estado (Multi-select con checkboxes) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Estado" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.statuses %}{{ filters.statuses|length }} seleccionado{{ filters.statuses|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="status" value="ACTIVE" 
              {% if 'ACTIVE' in filters.statuses %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            {% trans "Activo" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="status" value="LEAD" 
              {% if 'LEAD' in filters.statuses %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
            Lead
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="status" value="INACTIVE" 
              {% if 'INACTIVE' in filters.statuses %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-slate-400"></span>
            {% trans "Inactivo" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="status" value="PAUSED" 
              {% if 'PAUSED' in filters.statuses %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-amber-500"></span>
            {% trans "Excedencia" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="status" value="BLOCKED" 
              {% if 'BLOCKED' in filters.statuses %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            {% trans "Bloqueado" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="status" value="UNPAID" 
              {% if 'UNPAID' in filters.statuses %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-rose-600"></span>
            {% trans "Impagado" %}
          </label>
        </div>
      </div>
      
      <!-- Tipo de cliente (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Tipo de cliente" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.companies %}{{ filters.companies|length }} seleccionado{{ filters.companies|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="company" value="company" 
              {% if 'company' in filters.companies %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-purple-500"></span>
            {% trans "Empresas" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="company" value="individual" 
              {% if 'individual' in filters.companies %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-cyan-500"></span>
            {% trans "Particulares" %}
          </label>
        </div>
      </div>

      <!-- Filtros avanzados -->
      <!-- Tipo de cuota (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Tipo de cuota" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.membership_plans %}{{ filters.membership_plans|length }} seleccionada{{ filters.membership_plans|length|pluralize }}{% else %}{% trans "Todas" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1 max-h-48 overflow-y-auto">
          {% for plan in membership_plans %}
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="membership_plan" value="{{ plan.id }}" 
              {% if plan.id|stringformat:'s' in filters.membership_plans %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
            {{ plan.name }}
          </label>
          {% empty %}
          <p class="text-sm text-slate-400 px-2 py-1">{% trans "Sin cuotas configuradas" %}</p>
          {% endfor %}
        </div>
      </div>
      <!-- Servicio (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Servicio" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.services %}{{ filters.services|length }} seleccionado{{ filters.services|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1 max-h-48 overflow-y-auto">
          {% for service in services %}
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="service" value="{{ service.id }}" 
              {% if service.id|stringformat:'s' in filters.services %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            {{ service.name }}
          </label>
          {% empty %}
          <p class="text-sm text-slate-400 px-2 py-1">{% trans "Sin servicios configurados" %}</p>
          {% endfor %}
        </div>
      </div>
      <!-- Producto (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Producto" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.products %}{{ filters.products|length }} seleccionado{{ filters.products|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1 max-h-48 overflow-y-auto">
          {% for product in products %}
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="product" value="{{ product.id }}" 
              {% if product.id|stringformat:'s' in filters.products %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-amber-500"></span>
            {{ product.name }}
          </label>
          {% empty %}
          <p class="text-sm text-slate-400 px-2 py-1">{% trans "Sin productos configurados" %}</p>
          {% endfor %}
        </div>
      </div>
      <!-- Origen de alta (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Origen de alta" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.created_froms %}{{ filters.created_froms|length }} seleccionado{{ filters.created_froms|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="created_from" value="app" 
              {% if 'app' in filters.created_froms %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
            App
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="created_from" value="backoffice" 
              {% if 'backoffice' in filters.created_froms %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-orange-500"></span>
            Backoffice
          </label>
        </div>
      </div>
      
      <!-- Pasarela Pago (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Pasarela Pago" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.gateways %}{{ filters.gateways|length }} seleccionada{{ filters.gateways|length|pluralize }}{% else %}{% trans "Todas" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gateway" value="stripe" 
              {% if 'stripe' in filters.gateways %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-purple-500"></span>
            Stripe
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gateway" value="redsys" 
              {% if 'redsys' in filters.gateways %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            Redsys
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gateway" value="auto" 
              {% if 'auto' in filters.gateways %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-slate-400"></span>
            Auto (sin preferencia)
          </label>
        </div>
      </div>
      
      <!-- GÃ©nero (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "GÃ©nero" %}</label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.genders %}{{ filters.genders|length }} seleccionado{{ filters.genders|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gender" value="M" 
              {% if 'M' in filters.genders %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            {% trans "Masculino" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gender" value="F" 
              {% if 'F' in filters.genders %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            {% trans "Femenino" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gender" value="O" 
              {% if 'O' in filters.genders %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            {% trans "Otro" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="gender" value="X" 
              {% if 'X' in filters.genders %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            {% trans "No especificado" %}
          </label>
        </div>
      </div>
      
      <div>
        <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Edad" %}</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="number" name="age_min" min="0" max="120" value="{{ filters.age_min }}" placeholder="{% trans "Desde" %}" class="w-full rounded-xl border-slate-200 text-xs" />
          <input type="number" name="age_max" min="0" max="120" value="{{ filters.age_max }}" placeholder="{% trans "Hasta" %}" class="w-full rounded-xl border-slate-200 text-xs" />
        </div>
      </div>
      
      <!-- Tiene App (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">
          <span class="inline-flex items-center gap-1">
            ðŸ“± {% trans "Tiene App" %}
          </span>
        </label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.has_app %}{{ filters.has_app|length }} seleccionado{{ filters.has_app|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="has_app" value="yes" 
              {% if 'yes' in filters.has_app %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            {% trans "SÃ­, usa la App" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="has_app" value="no" 
              {% if 'no' in filters.has_app %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-slate-400"></span>
            {% trans "No usa la App" %}
          </label>
        </div>
      </div>
      
      {% if wallet_enabled %}
      <!-- Saldo Monedero (Multi-select) -->
      <div x-data="{ open: false }" class="relative">
        <label class="block text-xs font-bold text-slate-600 mb-2">
          <span class="inline-flex items-center gap-1">
            ðŸ’° {% trans "Saldo Monedero" %}
          </span>
        </label>
        <button type="button" @click="open = !open" 
          class="w-full rounded-xl border border-slate-200 bg-white text-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 text-left flex items-center justify-between">
          <span class="text-slate-600">
            {% if filters.wallet_balances %}{{ filters.wallet_balances|length }} seleccionado{{ filters.wallet_balances|length|pluralize }}{% else %}{% trans "Todos" %}{% endif %}
          </span>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" x-cloak
          class="absolute z-20 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg p-2 space-y-1">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="wallet_balance" value="positive" 
              {% if 'positive' in filters.wallet_balances %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            {% trans "Saldo positivo" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="wallet_balance" value="negative" 
              {% if 'negative' in filters.wallet_balances %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            {% trans "Saldo negativo (fiado)" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="wallet_balance" value="zero" 
              {% if 'zero' in filters.wallet_balances %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-slate-400"></span>
            {% trans "Saldo cero" %}
          </label>
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer text-sm">
            <input type="checkbox" name="wallet_balance" value="no_wallet" 
              {% if 'no_wallet' in filters.wallet_balances %}checked{% endif %}
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="w-2 h-2 rounded-full bg-gray-300"></span>
            {% trans "Sin monedero" %}
          </label>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Filtros de Fecha y Engagement -->
    <div class="mt-4 pt-4 border-t border-slate-200">
      <div x-data="{ showAdvanced: false }">
        <button type="button" @click="showAdvanced = !showAdvanced" 
          class="flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors mb-3">
          <svg class="w-4 h-4 transition-transform" :class="showAdvanced ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          {% trans "Filtros avanzados (fechas y engagement)" %}
        </button>
        
        <div x-show="showAdvanced" x-cloak class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Fecha de alta desde -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              {% trans "Alta desde" %}
            </label>
            <input type="date" name="date_from" value="{{ filters.date_from }}"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- Fecha de alta hasta -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              {% trans "Alta hasta" %}
            </label>
            <input type="date" name="date_to" value="{{ filters.date_to }}"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- DÃ­as sin asistir -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              {% trans "DÃ­as sin asistir" %}
            </label>
            <input type="number" name="days_no_visit" value="{{ filters.days_no_visit }}" min="1" placeholder="ej: 30"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- DÃ­as sin reservar -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
              </svg>
              {% trans "DÃ­as sin reservar" %}
            </label>
            <input type="number" name="days_no_booking" value="{{ filters.days_no_booking }}" min="1" placeholder="ej: 14"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- MembresÃ­a expira en X dÃ­as -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
              </svg>
              {% trans "Cuota expira en (dÃ­as)" %}
            </label>
            <input type="number" name="membership_expires_days" value="{{ filters.membership_expires_days }}" min="1" placeholder="ej: 7"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- Fecha de baja desde -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
              {% trans "Baja desde" %}
            </label>
            <input type="date" name="cancelled_from" value="{{ filters.cancelled_from }}"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- Fecha de baja hasta -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
              {% trans "Baja hasta" %}
            </label>
            <input type="date" name="cancelled_to" value="{{ filters.cancelled_to }}"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          
          <!-- Excedencia activa -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              {% trans "Excedencia" %}
            </label>
            <select name="has_active_pause"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
              <option value="" {% if not filters.has_active_pause %}selected{% endif %}>{% trans "Todos" %}</option>
              <option value="yes" {% if filters.has_active_pause == 'yes' %}selected{% endif %}>{% trans "Con excedencia activa" %}</option>
              <option value="no" {% if filters.has_active_pause == 'no' %}selected{% endif %}>{% trans "Sin excedencia" %}</option>
            </select>
          </div>
          
          <!-- No-shows (reserva pero no asiste) -->
          <div>
            <label class="block text-xs font-bold text-slate-600 mb-2">
              <svg class="w-3.5 h-3.5 inline mr-1 text-rose-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>
              </svg>
              {% trans "No-shows (mÃ­n.)" %}
            </label>
            <input type="number" name="min_no_shows" value="{{ filters.min_no_shows }}" min="1" placeholder="ej: 3"
              class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <label class="block text-xs font-bold text-slate-600 mb-2">{% trans "Etiquetas" %}</label>
      <div class="flex flex-wrap gap-2">
        {% for tag in tags %}
        <label
          class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer text-sm">
          <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in filters.selected_tags %}checked{% endif %}
            class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
          <span class="w-2 h-2 rounded-full" style="background-color: {{ tag.color|default:'#94a3b8' }}"></span>
          <span class="font-medium text-slate-700">{{ tag.name }}</span>
        </label>
        {% empty %}
        <p class="text-sm text-slate-400">{% trans "Sin etiquetas configuradas" %}</p>
        {% endfor %}
      </div>
    </div>

    {% if custom_fields %}
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
      {% for field in custom_fields %}
      <div>
        <label class="block text-xs font-bold text-slate-600 mb-2">{{ field.name }}</label>
        {% if field.field_type == 'TOGGLE' %}
          <select name="cf_{{ field.slug }}"
            class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Todos</option>
            <option value="true" {% if field.selected_value == 'true' %}selected{% endif %}>SÃ­</option>
            <option value="false" {% if field.selected_value == 'false' %}selected{% endif %}>No</option>
          </select>
        {% else %}
          <select name="cf_{{ field.slug }}"
            class="w-full rounded-xl border-slate-200 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Todos</option>
            {% for option in field.options.all %}
            <option value="{{ option.value }}" {% if field.selected_value == option.value %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="flex justify-end gap-2 mt-4 border-t border-slate-100 pt-4">
      <a href="{% url 'clients' %}"
        class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors">
        {% trans "Limpiar" %}
      </a>
      <button type="submit"
        class="px-5 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold shadow-sm hover:bg-indigo-700 transition-colors">
        {% trans "Aplicar filtros" %}
      </button>
    </div>
  </form>

  {% if clients %}
  <div class="overflow-x-auto">
    <table class="w-full text-left text-sm text-slate-500">
      <thead class="text-xs uppercase bg-slate-50 text-slate-700">
        <tr>
          <th scope="col" class="px-6 py-3 rounded-l-xl">{% trans "Cliente" %}</th>
          <th scope="col" class="px-6 py-3">{% trans "Estado" %}</th>
          <th scope="col" class="px-6 py-3">{% trans "Pasarela" %}</th>
          <th scope="col" class="px-6 py-3">{% trans "Etiquetas" %}</th>
          <th scope="col" class="px-6 py-3">{% trans "Campos" %}</th>
          <th scope="col" class="px-6 py-3 rounded-r-xl">{% trans "Email / Tlf" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for client in clients %}
        <tr class="bg-white border-b hover:bg-slate-50 transition-colors last:border-b-0">
          <!-- Nombre y Foto -->
          <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap flex items-center gap-3">
            {% if client.photo %}
            <img class="w-10 h-10 rounded-full object-cover" src="{{ client.photo.url }}" alt="{{ client.first_name }}">
            {% else %}
            <div
              class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xs font-bold uppercase">
              {% with fn=client.first_name|default_if_none:"" ln=client.last_name|default_if_none:"" %}
                {% if fn or ln %}
                  {{ fn|first }}{{ ln|first }}
                {% else %}
                  CL
                {% endif %}
              {% endwith %}
            </div>
            {% endif %}

            <div>
              <div class="flex items-center gap-1">
                {% if client.wallet %}
                  {% if client.wallet.balance > 0 %}
                  <span class="text-emerald-500" title="Saldo: {{ client.wallet.balance|floatformat:2 }} â‚¬">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                      <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                    </svg>
                  </span>
                  {% elif client.wallet.balance < 0 %}
                  <span class="text-red-500" title="Saldo: {{ client.wallet.balance|floatformat:2 }} â‚¬ (fiado)">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                      <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                    </svg>
                  </span>
                  {% endif %}
                {% endif %}
                <a href="{% url 'client_detail' client.id %}"
                  class="font-semibold hover:text-[var(--brand-color)] transition-colors">
                  {% with fn=client.first_name|default_if_none:"" ln=client.last_name|default_if_none:"" %}
                    {% if fn or ln %}
                      {{ fn }}{% if fn and ln %} {% endif %}{{ ln }}
                    {% else %}
                      {% trans "Cliente sin nombre" %}
                    {% endif %}
                  {% endwith %}
                </a>
              </div>
              <div class="text-xs text-slate-400 font-normal">
                DNI: {{ client.dni|default:"--" }}
                {% if client.has_portal_access %}
                <span class="inline-flex items-center gap-1 ml-2 px-1.5 py-0.5 rounded text-[10px] bg-green-100 text-green-700 border border-green-300" title="Tiene acceso al portal">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                  </svg>
                  App
                </span>
                {% endif %}
              </div>
              {% if client.is_company_client %}
              <div class="mt-1 inline-flex items-center gap-1 px-2 py-0.5 rounded-lg text-[10px] font-bold bg-amber-50 text-amber-700 border border-amber-200">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7l9-4 9 4-9 4-9-4zm0 6l9 4 9-4" />
                </svg>
                {% trans "Empresa" %}
              </div>
              {% endif %}
            </div>
          </td>

          <!-- Estado -->
          <td class="px-6 py-4">
            {% if client.status == 'ACTIVE' %}
            <span
              class="bg-emerald-100 text-emerald-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full border border-emerald-200">{% trans "Activo" %}</span>
            {% elif client.status == 'LEAD' %}
            <span
              class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full border border-blue-200">{% trans "Prospecto" %}</span>
            {% elif client.status == 'INACTIVE' %}
            <span
              class="bg-slate-100 text-slate-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full border border-slate-200">{% trans "Inactivo" %}</span>
            {% elif client.status == 'BLOCKED' %}
            <span
              class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full border border-red-200">{% trans "Bloqueado" %}</span>
            {% elif client.status == 'PAUSED' %}
            <span
              class="bg-amber-100 text-amber-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full border border-amber-200">{% trans "Excedencia" %}</span>
            {% endif %}
          </td>

          <!-- Pasarela Preferida -->
          <td class="px-6 py-4">
            {% if client.preferred_gateway == 'STRIPE' or client.stripe_customer_id %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-purple-100 text-purple-700 text-[10px] font-bold">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.165 0 9.667 0 7.589.654 6.104 1.872 4.56 3.147 3.757 4.992 3.757 7.218c0 4.039 2.467 5.76 6.476 7.219 2.585.92 3.445 1.574 3.445 2.583 0 .98-.84 1.545-2.354 1.545-1.875 0-4.965-.921-6.99-2.109l-.9 5.555C5.175 22.99 8.385 24 11.714 24c2.641 0 4.843-.624 6.328-1.813 1.664-1.305 2.525-3.236 2.525-5.732 0-4.128-2.524-5.851-6.591-7.305z"/></svg>
              Stripe
            </span>
            {% elif client.preferred_gateway == 'REDSYS' or client.redsys_tokens.exists %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-red-100 text-red-700 text-[10px] font-bold">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
              Redsys
            </span>
            {% else %}
            <span class="text-[10px] text-slate-400 px-2 py-1">Auto</span>
            {% endif %}
          </td>

          <!-- Tags -->
          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              {% for tag in client.tags.all %}
              <span class="text-[10px] px-2 py-0.5 rounded-md border"
                style="background-color: {{ tag.color }}20; border-color: {{ tag.color }}40; color: {{ tag.color }}">
                {{ tag.name }}
              </span>
              {% empty %}
              <span class="text-xs text-slate-400">-</span>
              {% endfor %}
            </div>
          </td>

          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              {% for slug, value in client.custom_field_values.items %}
              <span class="text-[10px] px-2 py-0.5 rounded-md border bg-slate-50 border-slate-200 text-slate-700">
                {{ value }}
              </span>
              {% empty %}
              <span class="text-xs text-slate-400">-</span>
              {% endfor %}
            </div>
          </td>

          <!-- Contacto -->
          <td class="px-6 py-4">
            <div class="flex flex-col">
              <span>{{ client.email|default:"" }}</span>
              <div class="flex items-center gap-2">
                <span class="text-xs text-slate-400">{{ client.phone_number }}</span>
                {% if client.phone_number %}
                <a href="https://wa.me/{{ client.phone_number|cut:' '|cut:'+'|cut:'-' }}" 
                   target="_blank"
                   title="WhatsApp a {{ client.first_name }}"
                   class="inline-flex items-center justify-center w-6 h-6 rounded-lg bg-green-500 hover:bg-green-600 text-white transition-colors" onclick="event.stopPropagation()">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                </a>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PaginaciÃ³n -->
  {% if page_obj.has_other_pages %}
  <div class="flex items-center justify-between px-4 py-3 bg-white border-t border-slate-200 rounded-b-2xl">
    <div class="text-sm text-slate-600">
      {% trans "Mostrando" %} {{ page_obj.start_index }} - {{ page_obj.end_index }} {% trans "de" %} {{ paginator.count }} {% trans "clientes" %}
    </div>
    <div class="flex gap-1">
      {% if page_obj.has_previous %}
      <a href="?{% for key, values in request.GET.lists %}{% if key != 'page' %}{% for val in values %}&{{ key }}={{ val }}{% endfor %}{% endif %}{% endfor %}&page={{ page_obj.previous_page_number }}"
         class="px-3 py-1.5 text-sm rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
        &laquo; {% trans "Anterior" %}
      </a>
      {% endif %}
      
      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
        <span class="px-3 py-1.5 text-sm rounded-lg bg-[var(--brand-color)] text-white font-medium">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?{% for key, values in request.GET.lists %}{% if key != 'page' %}{% for val in values %}&{{ key }}={{ val }}{% endfor %}{% endif %}{% endfor %}&page={{ num }}"
           class="px-3 py-1.5 text-sm rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">{{ num }}</a>
        {% endif %}
      {% endfor %}
      
      {% if page_obj.has_next %}
      <a href="?{% for key, values in request.GET.lists %}{% if key != 'page' %}{% for val in values %}&{{ key }}={{ val }}{% endfor %}{% endif %}{% endfor %}&page={{ page_obj.next_page_number }}"
         class="px-3 py-1.5 text-sm rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
        {% trans "Siguiente" %} &raquo;
      </a>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {% else %}
  <div class="p-12 text-center text-slate-500 border-2 border-dashed border-slate-100 rounded-2xl">
    <svg class="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
      </path>
    </svg>
    <h3 class="text-lg font-medium text-slate-900">{% trans "No hay clientes aÃºn" %}</h3>
    <p class="mt-1 text-sm text-slate-500">{% trans "Empieza registrando un nuevo socio o prospecto." %}</p>

    {% if can_create %}
    <div class="mt-6">
      <a href="{% url 'client_create' %}"
        class="bg-white text-slate-500 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors shadow-sm inline-block">
        {% trans "Crear primer cliente" %}
      </a>
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}