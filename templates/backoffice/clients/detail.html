{% extends "backoffice/base.html" %}

{% block page_title %}Ficha de Cliente{% endblock %}

{% block header_right %}
<a href="{% url 'clients' %}" class="text-sm font-medium text-slate-500 hover:text-slate-800 mr-4">
    Volver
</a>
<!-- Acciones -->
<a href="{% url 'client_edit' client.id %}"
    class="bg-white text-slate-500 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors shadow-sm">
    Editar
</a>
<a href="{% url 'pos_home' %}?client_id={{ client.id }}"
    class="bg-[var(--brand-color)] text-white border border-transparent px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
        </path>
    </svg>
    Cobrar
</a>
<button
    class="bg-white text-slate-500 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors shadow-sm">
    Check-in
</button>
{% endblock %}

{% block content %}
<div x-data="clientDetail">

    <!-- Modal de Alertas Emergentes -->
    <div x-show="showAlerts && alerts.length > 0 && clientReady" x-transition.opacity
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm" x-cloak style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in duration-200">
            <!-- Header -->
            <div class="p-6 bg-red-50 border-b border-red-100 flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-red-100 text-red-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-slate-900">‚ö†Ô∏è ALERTAS IMPORTANTES</h3>
                    <p class="text-xs text-slate-600">Revisa estas notas antes de proceder</p>
                </div>
                <button @click="showAlerts = false" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Alerts List -->
            <div class="p-6 space-y-3 max-h-96 overflow-y-auto">
                <template x-for="alert in alerts" :key="alert.id">
                    <div class="p-4 rounded-xl border-2 border-red-200 bg-red-50" :class="{
                            'border-red-300 bg-red-50': alert.type === 'DANGER',
                            'border-yellow-300 bg-yellow-50': alert.type === 'WARNING',
                            'border-amber-300 bg-amber-50': alert.type === 'VIP'
                        }">
                        <div class="flex items-start gap-3">
                            <div class="mt-0.5 flex-shrink-0">
                                <span x-show="alert.type === 'DANGER'" class="text-xl">üî•</span>
                                <span x-show="alert.type === 'WARNING'" class="text-xl">‚ö†Ô∏è</span>
                                <span x-show="alert.type === 'VIP'" class="text-xl">‚≠ê</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-slate-900" x-text="alert.text"></p>
                                <p class="text-xs text-slate-500 mt-1" x-text="`Por: ${alert.author} ‚Ä¢ ${alert.date}`">
                                </p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Footer -->
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-center gap-3">
                <button @click="showAlerts = false"
                    class="px-6 py-2 rounded-lg bg-red-600 text-white text-sm font-bold hover:bg-red-700 transition-colors">
                    He le√≠do las alertas
                </button>
            </div>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="space-y-6" x-data="{ activeTab: 'general' }">
        
        <!-- Cabecera del Cliente - Dise√±o Horizontal -->
        <div class="bg-white border border-slate-200 rounded-2xl p-6">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Foto y Estado -->
                <div class="flex items-center gap-4 md:border-r md:border-slate-100 md:pr-6">
                    <div class="relative flex-shrink-0">
                        {% if client.photo %}
                        <img class="w-20 h-20 rounded-2xl object-cover border-2 border-slate-100"
                            src="{{ client.photo.url }}">
                        {% else %}
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-400 text-2xl font-bold uppercase">
                            {{ client.first_name|slice:":2" }}
                        </div>
                        {% endif %}
                        <div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full border-3 border-white
                            {% if client.status == 'ACTIVE' %}bg-emerald-500
                            {% elif client.status == 'INACTIVE' %}bg-slate-400
                            {% elif client.status == 'BLOCKED' %}bg-red-500
                            {% else %}bg-blue-500{% endif %}">
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                            <a href="{% url 'client_edit' client.id %}" class="hover:text-[var(--brand-color)] transition-colors">
                                {{ client.first_name }} {{ client.last_name }}
                            </a>
                            {% if client.has_portal_access %}
                            <span class="px-2 py-0.5 text-[10px] font-medium bg-green-100 text-green-700 rounded-full">Portal</span>
                            {% endif %}
                        </h2>
                        <p class="text-sm text-slate-500">{{ client.email|default:"Sin email" }}</p>
                        <div class="flex items-center gap-2 mt-2">
                            {% for tag in client.tags.all %}
                            <span class="text-[10px] px-2 py-0.5 rounded-md border"
                                style="background-color: {{ tag.color }}15; border-color: {{ tag.color }}40; color: {{ tag.color }};">
                                {{ tag.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Datos de Contacto - Grid Horizontal -->
                <div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide block">Tel√©fono</span>
                        <div class="flex items-center gap-1.5">
                            <span class="text-sm font-medium text-slate-700">{{ client.phone_number|default:"--" }}</span>
                            {% if client.phone_number %}
                            <a href="https://wa.me/{{ client.phone_number|cut:' '|cut:'+'|cut:'-' }}" target="_blank"
                               class="w-5 h-5 rounded bg-green-500 hover:bg-green-600 text-white flex items-center justify-center">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide block">DNI</span>
                        <span class="text-sm font-medium text-slate-700">{{ client.dni|default:"--" }}</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide block">Nacimiento</span>
                        <span class="text-sm font-medium text-slate-700">{{ client.birth_date|date:"d/m/Y"|default:"--" }}</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide block">Tipo</span>
                        <span class="text-sm font-medium text-slate-700">{% if client.is_company_client %}Empresa{% else %}Particular{% endif %}</span>
                    </div>
                    {% if client.address %}
                    <div class="col-span-2">
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide block">Direcci√≥n</span>
                        <span class="text-sm font-medium text-slate-700">{{ client.address }}</span>
                    </div>
                    {% endif %}
                    {% for field in custom_fields %}
                    {% if field.display_value %}
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-wide block">{{ field.name }}</span>
                        <span class="text-sm font-medium text-slate-700">{{ field.display_value }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <!-- Acciones R√°pidas -->
                <div class="flex md:flex-col gap-2 md:border-l md:border-slate-100 md:pl-6">
                    <button @click="toggleEmailNotifications()"
                        :class="emailNotifications ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-100 text-slate-400 border-slate-200'"
                        class="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs border font-medium transition-all hover:scale-105">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span x-text="emailNotifications ? 'Emails ON' : 'Emails OFF'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Grid de 2 columnas: Notas + Pesta√±as de Contenido -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Columna Notas (1/4) -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-slate-200 rounded-2xl p-4 sticky top-4">
                    <h3 class="text-xs font-bold text-slate-900 uppercase tracking-wider mb-3 flex items-center justify-between">
                        Notas
                        <span class="text-slate-400 font-normal">{{ notes|length }}</span>
                    </h3>
                    <div class="space-y-2 max-h-[400px] overflow-y-auto mb-3 pr-1">
                        {% for note in notes %}
                        <div class="p-2 rounded-lg border text-xs relative group
                            {% if note.type == 'VIP' %}bg-amber-50 border-amber-200
                            {% elif note.type == 'WARNING' %}bg-yellow-50 border-yellow-200
                            {% elif note.type == 'DANGER' %}bg-red-50 border-red-200
                            {% else %}bg-slate-50 border-slate-100{% endif %}">
                            <p class="{% if note.type == 'DANGER' %}text-red-800{% else %}text-slate-600{% endif %}">
                                {% if note.type == 'VIP' %}‚≠ê{% endif %}{% if note.type == 'DANGER' %}üî•{% endif %}
                                {{ note.text|truncatewords:15 }}
                            </p>
                            <div class="text-[10px] text-slate-400 mt-1 flex justify-between items-center">
                                <span>{{ note.author.first_name|default:"Staff" }} ¬∑ {{ note.created_at|date:"d/m" }}</span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100">
                                    <a href="{% url 'client_edit_note' note.id %}" class="text-slate-400 hover:text-[var(--brand-color)]">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </a>
                                    <form action="{% url 'client_delete_note' note.id %}" method="post" onsubmit="return confirm('¬øBorrar?');" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-400 hover:text-red-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-slate-400 text-xs py-4">Sin notas</p>
                        {% endfor %}
                    </div>
                    <!-- Formulario A√±adir Nota -->
                    <form action="{% url 'client_add_note' client.id %}" method="post" class="border-t border-slate-100 pt-3">
                        {% csrf_token %}
                        <div class="mb-2">{{ note_form.type }}</div>
                        {{ note_form.text }}
                        <div class="flex items-center justify-between mt-2">
                            <label class="flex items-center text-[10px] text-slate-500 gap-1">{{ note_form.is_popup }} Popup</label>
                            <button type="submit" class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-medium hover:bg-slate-200">A√±adir</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Columna Contenido (3/4) -->
            <div class="lg:col-span-3">
            
            <!-- Navegaci√≥n de Pesta√±as -->
            <div class="bg-white border border-slate-200 rounded-2xl mb-6 overflow-hidden">
                <div class="flex overflow-x-auto scrollbar-hide">
                    <button @click="activeTab = 'general'"
                        :class="activeTab === 'general' ? 'border-b-2 border-[var(--brand-color)] text-[var(--brand-color)] bg-slate-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'"
                        class="flex-1 min-w-[100px] px-3 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="hidden sm:inline">General</span>
                        {% if client.documents.count > 0 %}
                        <span class="ml-1 px-1.5 py-0.5 text-[10px] font-bold rounded-full bg-slate-200 text-slate-600">{{ client.documents.count }}</span>
                        {% endif %}
                    </button>
                    <button @click="activeTab = 'memberships'"
                        :class="activeTab === 'memberships' ? 'border-b-2 border-[var(--brand-color)] text-[var(--brand-color)] bg-slate-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'"
                        class="flex-1 min-w-[100px] px-3 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        <span class="hidden sm:inline">Membres√≠as</span>
                        {% if memberships %}
                        <span class="ml-1 px-1.5 py-0.5 text-[10px] font-bold rounded-full bg-emerald-100 text-emerald-700">{{ memberships|length }}</span>
                        {% endif %}
                    </button>
                    <button @click="activeTab = 'activity'"
                        :class="activeTab === 'activity' ? 'border-b-2 border-[var(--brand-color)] text-[var(--brand-color)] bg-slate-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'"
                        class="flex-1 min-w-[100px] px-3 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="hidden sm:inline">Actividad</span>
                    </button>
                    <button @click="activeTab = 'training'"
                        :class="activeTab === 'training' ? 'border-b-2 border-[var(--brand-color)] text-[var(--brand-color)] bg-slate-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'"
                        class="flex-1 min-w-[100px] px-3 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        <span class="hidden sm:inline">Entreno</span>
                        {% if client_routines %}
                        <span class="ml-1 px-1.5 py-0.5 text-[10px] font-bold rounded-full bg-indigo-100 text-indigo-700">{{ client_routines|length }}</span>
                        {% endif %}
                    </button>
                    <button @click="activeTab = 'sales'"
                        :class="activeTab === 'sales' ? 'border-b-2 border-[var(--brand-color)] text-[var(--brand-color)] bg-slate-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'"
                        class="flex-1 min-w-[100px] px-3 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span class="hidden sm:inline">Ventas</span>
                        {% if client.orders.count > 0 %}
                        <span class="ml-1 px-1.5 py-0.5 text-[10px] font-bold rounded-full bg-amber-100 text-amber-700">{{ client.orders.count }}</span>
                        {% endif %}
                    </button>
                </div>
            </div>
            
            <!-- Contenido de Pesta√±as -->
            <div class="space-y-6">
                
                <!-- TAB: General -->
                <div x-show="activeTab === 'general'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="space-y-6">

        <!-- Gesti√≥n Documental -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="documentManager()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Documentos y Contratos</h3>
                <div class="flex items-center gap-2">
                    <button @click="showTemplateSelector = !showTemplateSelector"
                        class="text-xs font-medium text-emerald-600 hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Enviar desde Plantilla
                    </button>
                    <button onclick="document.getElementById('add-doc-form').classList.toggle('hidden')"
                        class="text-xs font-medium text-[var(--brand-color)] hover:underline">+ Subir Documento</button>
                </div>
            </div>

            <!-- Template Selector Panel -->
            <div x-show="showTemplateSelector" x-collapse class="bg-emerald-50 p-4 border-b border-emerald-100">
                <form action="{% url 'client_send_document' client.id %}" method="post" class="space-y-3">
                    {% csrf_token %}
                    <label class="block text-sm font-medium text-slate-700">Selecciona una plantilla para enviar al
                        cliente:</label>
                    <div class="flex gap-3">
                        <select name="template_id" required
                            class="flex-1 rounded-xl border-slate-200 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">-- Elegir plantilla --</option>
                            {% for tmpl in document_templates %}
                            <option value="{{ tmpl.id }}">{{ tmpl.name }} ({{ tmpl.get_document_type_display }})
                            </option>
                            {% empty %}
                            <option disabled>No hay plantillas configuradas</option>
                            {% endfor %}
                        </select>
                        <button type="submit"
                            class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-700 transition-colors">
                            Enviar al Cliente
                        </button>
                    </div>
                    <p class="text-xs text-slate-500">
                        El documento se enviar√° al portal y app del cliente para su firma.
                        <a href="{% url 'document_template_list' %}" class="text-emerald-600 hover:underline">Gestionar
                            plantillas ‚Üí</a>
                    </p>
                </form>
            </div>

            <!-- Hidden Form (Upload Custom) -->
            <div id="add-doc-form" class="hidden bg-slate-50 p-4 border-b border-slate-100">
                <form action="{% url 'client_add_document' client.id %}" method="post" enctype="multipart/form-data"
                    class="flex flex-col gap-3">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>{{ document_form.name }}</div>
                        <div>{{ document_form.file }}</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-xs text-slate-600 flex items-center gap-2">
                            {{ document_form.requires_signature }}
                            ¬øRequiere firma?
                        </label>
                        <button type="submit"
                            class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs hover:bg-slate-700">Subir</button>
                    </div>
                </form>
            </div>

            <div class="p-0">
                {% if client.documents.exists %}
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-50">
                        <tr>
                            <th class="px-6 py-3">Documento</th>
                            <th class="px-6 py-3">Estado</th>
                            <th class="px-6 py-3">Enviado</th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for doc in client.documents.all %}
                        <tr class="hover:bg-slate-50">
                            <td class="px-6 py-3">
                                <div class="font-medium text-slate-700">{{ doc.name }}</div>
                                <div class="text-xs text-slate-400">{{ doc.get_document_type_display }}</div>
                            </td>
                            <td class="px-6 py-3">
                                {% if doc.status == 'SIGNED' %}
                                <span class="inline-flex items-center gap-1 text-emerald-600 text-xs font-semibold">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Firmado
                                    {% if doc.signed_at %}
                                    <span class="text-slate-400 font-normal">({{ doc.signed_at|date:"d/m/y" }})</span>
                                    {% endif %}
                                </span>
                                {% elif doc.status == 'PENDING' %}
                                <span class="inline-flex items-center gap-1 text-amber-500 text-xs font-semibold">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Pendiente Firma
                                </span>
                                {% else %}
                                <span class="text-slate-400 text-xs">{{ doc.get_status_display }}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-3">
                                {% if doc.sent_at %}
                                <span class="text-xs text-slate-500">{{ doc.sent_at|date:"d/m/y H:i" }}</span>
                                {% else %}
                                <span class="text-xs text-slate-400">No enviado</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-3 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    {% if doc.file %}
                                    <a href="{{ doc.file.url }}" target="_blank"
                                        class="text-[var(--brand-color)] hover:underline text-xs">Ver PDF</a>
                                    {% endif %}
                                    {% if doc.content and doc.status == 'PENDING' %}
                                    <a href="{% url 'client_sign_insitu' client.id doc.id %}"
                                        class="bg-amber-100 text-amber-700 px-3 py-1 rounded-lg text-xs font-medium hover:bg-amber-200 transition-colors flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                            </path>
                                        </svg>
                                        Firmar Aqu√≠
                                    </a>
                                    {% endif %}
                                    {% if doc.signature_image %}
                                    <a href="{{ doc.signature_image.url }}" target="_blank"
                                        class="text-slate-500 hover:text-slate-700 text-xs">Ver Firma</a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-6">No hay documentos adjuntos.</p>
                {% endif %}
            </div>
        </section>

        <script>
            function documentManager() {
                return {
                    showTemplateSelector: false
                };
            }
        </script>

        <!-- Datos de Salud -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="{ showHealthForm: false, showUploadForm: false }">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-rose-50/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-rose-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-slate-900">Datos de Salud</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="showUploadForm = !showUploadForm" 
                        class="text-xs font-medium text-rose-600 hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Subir Documento
                    </button>
                    <button @click="showHealthForm = !showHealthForm" 
                        class="text-xs font-medium text-rose-600 hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span x-text="showHealthForm ? 'Cancelar' : 'Editar Datos'"></span>
                    </button>
                </div>
            </div>

            <!-- Formulario de subir documento m√©dico -->
            <div x-show="showUploadForm" x-collapse class="bg-rose-50 p-4 border-b border-rose-100">
                <form action="{% url 'client_health_document_upload' client.id %}" method="post" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre del Documento</label>
                            {{ health_document_form.name }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo</label>
                            {{ health_document_form.document_type }}
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Archivo</label>
                            {{ health_document_form.file }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha del Documento</label>
                            {{ health_document_form.document_date }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Caduca</label>
                            {{ health_document_form.expires_at }}
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Notas</label>
                        {{ health_document_form.notes }}
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-rose-700 transition-colors">
                            Subir Documento
                        </button>
                    </div>
                </form>
            </div>

            <!-- Formulario de edici√≥n de datos de salud -->
            <div x-show="showHealthForm" x-collapse class="p-6 border-b border-slate-100">
                <form action="{% url 'client_health_record_update' client.id %}" method="post" class="space-y-4">
                    {% csrf_token %}
                    
                    <!-- Contacto de emergencia -->
                    <div class="bg-red-50 rounded-xl p-4 border border-red-200">
                        <h4 class="text-sm font-bold text-red-800 mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            Contacto de Emergencia
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre</label>
                                {{ health_form.emergency_contact_name }}
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tel√©fono</label>
                                {{ health_form.emergency_contact_phone }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Autorizaci√≥n m√©dica -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl">
                            {{ health_form.has_medical_clearance }}
                            <label class="text-sm text-slate-700">Tiene autorizaci√≥n m√©dica</label>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha de autorizaci√≥n</label>
                            {{ health_form.medical_clearance_date }}
                        </div>
                    </div>
                    
                    <!-- Condiciones m√©dicas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Alergias</label>
                            {{ health_form.allergies }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Condiciones M√©dicas</label>
                            {{ health_form.medical_conditions }}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Medicamentos</label>
                        {{ health_form.medications }}
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Notas Generales de Salud</label>
                        {{ health_form.notes }}
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-rose-600 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-rose-700 transition-colors">
                            Guardar Datos de Salud
                        </button>
                    </div>
                </form>
            </div>

            <!-- Vista resumida de datos de salud -->
            <div class="p-6" x-show="!showHealthForm">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Columna izquierda: Info principal -->
                    <div class="space-y-4">
                        <!-- Contacto de emergencia -->
                        <div class="bg-red-50 rounded-xl p-4 border border-red-100">
                            <h4 class="text-xs font-bold text-red-700 uppercase mb-2">Contacto de Emergencia</h4>
                            {% if health_record.emergency_contact_name %}
                            <p class="text-sm font-medium text-slate-800">{{ health_record.emergency_contact_name }}</p>
                            <p class="text-sm text-slate-600">{{ health_record.emergency_contact_phone|default:"-" }}</p>
                            {% else %}
                            <p class="text-sm text-slate-400 italic">No registrado</p>
                            {% endif %}
                        </div>
                        
                        <!-- Autorizaci√≥n m√©dica -->
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl">
                            {% if health_record.has_medical_clearance %}
                            <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-emerald-700">Autorizaci√≥n m√©dica vigente</p>
                                {% if health_record.medical_clearance_date %}
                                <p class="text-xs text-slate-500">Desde: {{ health_record.medical_clearance_date|date:"d/m/Y" }}</p>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-amber-700">Sin autorizaci√≥n m√©dica</p>
                                <p class="text-xs text-slate-500">Pendiente de documentaci√≥n</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Alergias -->
                        {% if health_record.allergies %}
                        <div class="bg-amber-50 rounded-xl p-4 border border-amber-100">
                            <h4 class="text-xs font-bold text-amber-700 uppercase mb-2 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                Alergias
                            </h4>
                            <p class="text-sm text-slate-700">{{ health_record.allergies }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Columna derecha: Condiciones y medicamentos -->
                    <div class="space-y-4">
                        {% if health_record.medical_conditions %}
                        <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                            <h4 class="text-xs font-bold text-blue-700 uppercase mb-2">Condiciones M√©dicas</h4>
                            <p class="text-sm text-slate-700">{{ health_record.medical_conditions }}</p>
                        </div>
                        {% endif %}
                        
                        {% if health_record.medications %}
                        <div class="bg-purple-50 rounded-xl p-4 border border-purple-100">
                            <h4 class="text-xs font-bold text-purple-700 uppercase mb-2">Medicamentos Actuales</h4>
                            <p class="text-sm text-slate-700">{{ health_record.medications }}</p>
                        </div>
                        {% endif %}
                        
                        {% if health_record.notes %}
                        <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Notas Generales</h4>
                            <p class="text-sm text-slate-700">{{ health_record.notes }}</p>
                        </div>
                        {% endif %}
                        
                        {% if not health_record.medical_conditions and not health_record.medications and not health_record.notes and not health_record.allergies %}
                        <div class="text-center py-6 text-slate-400">
                            <svg class="w-10 h-10 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-sm">No hay datos de salud registrados</p>
                            <button @click="showHealthForm = true" class="text-rose-600 text-xs font-medium hover:underline mt-2">
                                + A√±adir informaci√≥n
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Documentos de salud -->
            {% if health_record.documents.exists %}
            <div class="border-t border-slate-100">
                <div class="px-6 py-3 bg-slate-50 flex items-center gap-2">
                    <svg class="w-4 h-4 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h4 class="text-xs font-bold text-slate-600 uppercase">Documentos M√©dicos</h4>
                </div>
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-50/50">
                        <tr>
                            <th class="px-6 py-3">Documento</th>
                            <th class="px-6 py-3">Tipo</th>
                            <th class="px-6 py-3">Fecha</th>
                            <th class="px-6 py-3">Caduca</th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for doc in health_record.documents.all %}
                        <tr class="hover:bg-slate-50">
                            <td class="px-6 py-3">
                                <div class="font-medium text-slate-700">{{ doc.name }}</div>
                                {% if doc.notes %}
                                <div class="text-xs text-slate-400">{{ doc.notes|truncatewords:10 }}</div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-3">
                                <span class="text-xs px-2 py-1 rounded-full bg-rose-100 text-rose-700">{{ doc.get_document_type_display }}</span>
                            </td>
                            <td class="px-6 py-3">
                                {% if doc.document_date %}
                                <span class="text-xs">{{ doc.document_date|date:"d/m/Y" }}</span>
                                {% else %}
                                <span class="text-xs text-slate-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-3">
                                {% if doc.expires_at %}
                                    {% now "Y-m-d" as today %}
                                    {% if doc.expires_at|date:"Y-m-d" < today %}
                                    <span class="text-xs text-red-600 font-medium">{{ doc.expires_at|date:"d/m/Y" }} ‚ö†Ô∏è</span>
                                    {% else %}
                                    <span class="text-xs text-slate-600">{{ doc.expires_at|date:"d/m/Y" }}</span>
                                    {% endif %}
                                {% else %}
                                <span class="text-xs text-slate-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-3 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <a href="{{ doc.file.url }}" target="_blank" class="text-rose-600 hover:underline text-xs">Ver</a>
                                    <form action="{% url 'client_health_document_delete' doc.id %}" method="post" class="inline" onsubmit="return confirm('¬øEliminar este documento?');">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-500 hover:text-red-700 text-xs">Eliminar</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </section>
                </div>
                <!-- FIN TAB: General -->

                <!-- TAB: Membres√≠as -->
                <div x-show="activeTab === 'memberships'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="space-y-6">

        <!-- M√©todos de Pago (Stripe & Redsys) -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="stripeCardHandler()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">M√©todos de Pago</h3>
                <div class="flex gap-2">
                    <!-- Pasarela Preferida -->
                    <div class="flex items-center gap-2 mr-4 border-r border-slate-200 pr-4">
                        <span class="text-xs text-slate-500">Pasarela:</span>
                        <select 
                            onchange="updatePreferredGateway(this.value)"
                            class="text-xs rounded-lg border-slate-200 py-1 px-2 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                        >
                            <option value="AUTO" {% if client.preferred_gateway == 'AUTO' %}selected{% endif %}>Auto (seg√∫n gimnasio)</option>
                            <option value="STRIPE" {% if client.preferred_gateway == 'STRIPE' %}selected{% endif %}>Stripe</option>
                            <option value="REDSYS" {% if client.preferred_gateway == 'REDSYS' %}selected{% endif %}>Redsys</option>
                        </select>
                        {% if client.preferred_gateway == 'STRIPE' %}
                        <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 text-[10px] font-bold">
                            <svg class="w-2.5 h-2.5" viewBox="0 0 24 24" fill="currentColor"><path d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.165 0 9.667 0 7.589.654 6.104 1.872 4.56 3.147 3.757 4.992 3.757 7.218c0 4.039 2.467 5.76 6.476 7.219 2.585.92 3.445 1.574 3.445 2.583 0 .98-.84 1.545-2.354 1.545-1.875 0-4.965-.921-6.99-2.109l-.9 5.555C5.175 22.99 8.385 24 11.714 24c2.641 0 4.843-.624 6.328-1.813 1.664-1.305 2.525-3.236 2.525-5.732 0-4.128-2.524-5.851-6.591-7.305z"/></svg>
                        </span>
                        {% elif client.preferred_gateway == 'REDSYS' %}
                        <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-red-100 text-red-700 text-[10px] font-bold">
                            <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                        </span>
                        {% endif %}
                    </div>
                    <!-- Stripe Button -->
                    {% if stripe_public_key %}
                    <button @click="openModal()"
                        class="text-xs font-medium text-[var(--brand-color)] hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.16 0 9.613 0 7.559.664 6.132 1.943c-1.408 1.259-2.091 2.924-2.091 4.965 0 3.012 1.916 5.093 5.376 6.37 2.457.904 3.065 1.488 3.065 2.505 0 .972-.787 1.572-2.147 1.572-1.957 0-4.632-1.028-6.495-2.067l-.959 5.485c2.022.75 4.881 1.226 7.425 1.226 2.822 0 4.895-.824 6.22-2.225 1.25-1.328 1.838-3.033 1.838-4.992 0-3.321-2.147-5.467-5.399-6.632" />
                        </svg>
                        Stripe
                    </button>
                    {% endif %}

                    <!-- Redsys Button -->
                    {% if redsys_enabled %}
                    <a href="{% url 'redsys_authorize_start' client.id %}"
                        class="text-xs font-medium text-red-600 hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                        Redsys
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="p-6">
                {% if payment_methods or redsys_tokens %}
                <ul class="space-y-3">
                    <!-- Redsys Tokens -->
                    {% for token in redsys_tokens %}
                    <li class="flex items-center justify-between p-3 border border-red-100 rounded-xl bg-red-50/20">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-lg border border-red-200 text-red-600">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 capitalize">
                                    {{ token.card_brand }} <span class="text-slate-400">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{
                                        token.card_number|slice:"-4:" }}</span>
                                    <span class="text-[10px] bg-red-100 text-red-600 px-1 rounded ml-1">Redsys</span>
                                </div>
                                <div class="text-xs text-slate-400">Expira: {{ token.expiration }}</div>
                            </div>
                        </div>
                        <span
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">Guardada</span>
                    </li>
                    {% endfor %}

                    <!-- Stripe Cards -->
                    {% for pm in payment_methods %}
                    <li class="flex items-center justify-between p-3 border border-slate-100 rounded-xl bg-slate-50/50">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-lg border border-slate-200 text-slate-600">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 capitalize">
                                    {{ pm.card.brand }} <span class="text-slate-400">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ pm.card.last4 }}</span>
                                    <span
                                        class="text-[10px] bg-indigo-100 text-indigo-600 px-1 rounded ml-1">Stripe</span>
                                </div>
                                <div class="text-xs text-slate-400">Expira: {{ pm.card.exp_month }}/{{ pm.card.exp_year
                                    }}</div>
                            </div>
                        </div>
                        <span
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">Guardada</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">No hay tarjetas vinculadas.</p>
                {% endif %}
            </div>

            <!-- Stripe Modal -->
            <div x-show="isOpen" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto"
                aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                        @click="closeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div
                        class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">Vincular Nueva
                                Tarjeta</h3>

                            <!-- Stripe Element Container -->
                            <div id="payment-element" class="mb-4 min-h-[50px]">
                                <!-- Stripe.js injects the Element here -->
                            </div>

                            <div id="error-message" class="text-red-500 text-sm mb-4 hidden"></div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button @click="confirmSetup()" id="submit-button" type="button"
                                class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 bg-slate-900 text-base font-medium text-white hover:bg-slate-800 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                                <span x-show="!isLoading">Guardar Tarjeta</span>
                                <span x-show="isLoading">Procesando...</span>
                            </button>
                            <button @click="closeModal()" type="button"
                                class="mt-3 w-full inline-flex justify-center rounded-xl border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://js.stripe.com/v3/"></script>
            <script>
                function stripeCardHandler() {
                    return {
                        isOpen: false,
                        isLoading: false,
                        stripe: null,
                        elements: null,
                        clientSecret: null,

                        initStripe() {
                            if (!this.stripe) {
                                this.stripe = Stripe('{{ stripe_public_key }}');
                            }
                        },

                        async openModal() {
                            this.isOpen = true;
                            this.initStripe();

                            // Fetch SetupIntent
                            try {
                                const response = await fetch("{% url 'client_get_stripe_setup' client.id %}");
                                const data = await response.json();

                                if (data.error) {
                                    alert('Error: ' + data.error);
                                    this.isOpen = false;
                                    return;
                                }

                                this.clientSecret = data.client_secret;
                                const appearance = { theme: 'stripe' };
                                this.elements = this.stripe.elements({ clientSecret: this.clientSecret, appearance });
                                const paymentElement = this.elements.create('payment');
                                paymentElement.mount('#payment-element');

                            } catch (e) {
                                console.error(e);
                                alert('Error de conexi√≥n con Stripe');
                            }
                        },

                        closeModal() {
                            this.isOpen = false;
                            this.elements = null;
                            document.getElementById('payment-element').innerHTML = ''; // Clean up
                        },

                        async confirmSetup() {
                            if (this.isLoading) return;
                            this.isLoading = true;
                            document.getElementById('error-message').classList.add('hidden');

                            const { error } = await this.stripe.confirmSetup({
                                elements: this.elements,
                                confirmParams: {
                                    return_url: window.location.href, // Reload page on success (redirect)
                                },
                                redirect: 'if_required'
                            });

                            if (error) {
                                const messageContainer = document.querySelector('#error-message');
                                messageContainer.textContent = error.message;
                                messageContainer.classList.remove('hidden');
                                this.isLoading = false;
                            } else {
                                // Success!
                                window.location.reload();
                            }
                        }
                    }
                }
                
                // Function to update preferred payment gateway
                async function updatePreferredGateway(gateway) {
                    try {
                        const response = await fetch("{% url 'client_update_preferred_gateway' client.id %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ gateway: gateway })
                        });
                        const data = await response.json();
                        if (data.success) {
                            // Show subtle confirmation
                            const toast = document.createElement('div');
                            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium z-50';
                            toast.textContent = 'Pasarela actualizada a ' + gateway;
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 3000);
                        } else {
                            alert('Error: ' + (data.error || 'No se pudo actualizar'));
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Error de conexi√≥n');
                    }
                }
            </script>
        </section>

        <!-- Suscripciones -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="membershipActions()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Suscripciones</h3>
                <button class="text-xs font-medium text-[var(--brand-color)] hover:underline">+ Nueva</button>
            </div>
            <div class="p-6">
                {% if memberships %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-400 uppercase">
                            <tr>
                                <th class="pb-3">Plan</th>
                                <th class="pb-3">Fechas</th>
                                <th class="pb-3 text-right">Precio</th>
                                <th class="pb-3 text-center">Estado</th>
                                <th class="pb-3 text-right">Gesti√≥n</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {% for mem in memberships %}
                            <tr class="hover:bg-slate-50 transition-colors cursor-pointer"
                                @click="openEditModal({{ mem.id }}, '{{ mem.name|escapejs }}', '{{ mem.start_date|date:"Y-m-d" }}', '{% if mem.end_date %}{{ mem.end_date|date:"Y-m-d" }}{% endif %}', {{ mem.price }}, '{{ mem.status }}', {{ mem.is_recurring|yesno:"true,false" }}, {{ mem.sessions_total|default:"null" }}, {{ mem.sessions_used|default:"0" }}, '{% if mem.next_billing_date %}{{ mem.next_billing_date|date:"Y-m-d" }}{% endif %}')">
                                <td class="py-3 font-medium text-slate-800 hover:text-[var(--brand-color)]">
                                    {{ mem.name }}
                                    {% if mem.sessions_total %}
                                    <br><span class="text-xs text-slate-500">{{ mem.sessions_used }}/{{ mem.sessions_total }} sesiones</span>
                                    {% endif %}
                                </td>
                                <td class="py-3">
                                    {% if mem.current_period_start and mem.current_period_end %}
                                    {{ mem.current_period_start|date:"d/M/y" }} - {{ mem.current_period_end|date:"d/M/y" }}
                                    {% if mem.next_billing_date and mem.is_recurring %}
                                    <br><span class="text-xs text-slate-500">Pr√≥ximo pago: {{ mem.next_billing_date|date:"d/M/y" }}</span>
                                    {% endif %}
                                    {% else %}
                                    {{ mem.start_date|date:"d/M/y" }} - {{ mem.end_date|date:"d/M/y"|default:"‚àû" }}
                                    {% endif %}
                                </td>
                                <td class="py-3 text-right">{{ mem.price }}‚Ç¨</td>
                                <td class="py-3 text-center">
                                    {% if mem.status == 'ACTIVE' %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800">Activa</span>
                                    {% elif mem.status == 'EXPIRED' %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600">Caducada</span>
                                    {% else %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">{{
                                        mem.get_status_display }}</span>
                                    {% endif %}

                                    {% with active_pause=mem.pauses.all|first %}
                                    {% if active_pause and active_pause.status == 'ACTIVE' %}
                                    <div class="mt-1">
                                        <span
                                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            En Pausa
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="py-3 text-right" @click.stop>
                                    <div class="flex items-center justify-end gap-2">
                                        {% if mem.is_recurring and mem.status == 'ACTIVE' %}
                                        <button type="button" @click="openPauseModal({{ mem.id }}, '{{ mem.name }}')"
                                            class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-purple-200 text-purple-600 hover:bg-purple-50 transition-colors"
                                            title="Pausar membres√≠a">
                                            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Pausar
                                        </button>
                                        {% endif %}
                                        <button type="button"
                                            @click="openEditModal({{ mem.id }}, '{{ mem.name|escapejs }}', '{{ mem.start_date|date:"Y-m-d" }}', '{% if mem.end_date %}{{ mem.end_date|date:"Y-m-d" }}{% endif %}', {{ mem.price }}, '{{ mem.status }}', {{ mem.is_recurring|yesno:"true,false" }}, {{ mem.sessions_total|default:"null" }}, {{ mem.sessions_used|default:"0" }}, '{% if mem.next_billing_date %}{{ mem.next_billing_date|date:"Y-m-d" }}{% endif %}')"
                                            class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-100 transition-colors"
                                            title="Editar esta membres√≠a">
                                            Editar
                                        </button>
                                        <button type="button" @click="chargeMembership({{ mem.id }})"
                                            class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-[var(--brand-color)] text-white hover:bg-[var(--brand-color-hover)] transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                                            :disabled="chargingId === {{ mem.id }}">
                                            <span x-show="chargingId === {{ mem.id }}">Cobrando...</span>
                                            <span x-show="chargingId !== {{ mem.id }}">Cobrar cuota</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">No tiene suscripciones activas ni pasadas.</p>
                {% endif %}
            </div>

            <!-- Modal de Pausa -->
            <div x-show="showPauseModal" x-transition.opacity
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm"
                @click.self="showPauseModal = false" x-cloak>
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
                    <!-- Header -->
                    <div class="p-6 bg-purple-50 border-b border-purple-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-bold text-purple-900">Pausar Membres√≠a</h3>
                        </div>
                        <button @click="showPauseModal = false" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Body -->
                    <form @submit.prevent="submitPause" class="p-6 space-y-4">
                        <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                            <p class="text-sm text-blue-900">
                                <strong x-text="pauseForm.membershipName"></strong>
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Fecha Inicio</label>
                                <input type="date" x-model="pauseForm.start_date" required
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Fecha Fin</label>
                                <input type="date" x-model="pauseForm.end_date" required
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Motivo</label>
                            <textarea x-model="pauseForm.reason" rows="3"
                                class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-purple-500"
                                placeholder="Opcional: motivo de la pausa"></textarea>
                        </div>

                        <div class="bg-slate-50 rounded-xl p-4">
                            <p class="text-xs text-slate-600 mb-2">Duraci√≥n: <span x-text="calculateDays()"
                                    class="font-bold"></span> d√≠as</p>
                            <p class="text-xs text-slate-600">Cargo: <span class="font-bold">0.00‚Ç¨</span></p>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" @click="showPauseModal = false"
                                class="flex-1 px-4 py-3 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="submittingPause"
                                class="flex-1 px-4 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700 disabled:opacity-50">
                                <span x-show="!submittingPause">Confirmar Pausa</span>
                                <span x-show="submittingPause">Procesando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal de Edici√≥n de Membres√≠a -->
            <div x-show="showEditModal" x-transition.opacity
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm"
                @click.self="showEditModal = false" x-cloak>
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden max-h-[90vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="p-6 bg-blue-50 border-b border-blue-100 flex items-center justify-between sticky top-0">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                            <h3 class="text-lg font-bold text-blue-900">Editar Membres√≠a</h3>
                        </div>
                        <button @click="showEditModal = false" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Body -->
                    <form @submit.prevent="submitEdit" class="p-6 space-y-4">
                        <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                            <p class="text-sm text-slate-900 font-bold" x-text="editForm.membershipName"></p>
                            <p class="text-xs text-slate-500 mt-1">Los cambios solo afectan a este cliente, no al plan general</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Fecha Inicio</label>
                                <input type="date" x-model="editForm.start_date" required
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Fecha Fin</label>
                                <input type="date" x-model="editForm.end_date"
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-slate-500 mt-1">Dejar vac√≠o para sin l√≠mite</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Precio (‚Ç¨)</label>
                                <input type="number" step="0.01" x-model="editForm.price" required
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Pr√≥ximo cobro</label>
                                <input type="date" x-model="editForm.next_billing_date"
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-blue-500"
                                    :disabled="!editForm.is_recurring">
                                <p class="text-xs text-slate-500 mt-1" x-show="!editForm.is_recurring">Solo para planes recurrentes</p>
                            </div>
                        </div>

                        <!-- Sesiones (solo si tiene l√≠mite) -->
                        <div class="border border-slate-200 rounded-xl p-4 space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-slate-700">Control de Sesiones</label>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" x-model="editForm.hasSessionLimit"
                                        class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-slate-600">Limitar sesiones</span>
                                </label>
                            </div>
                            <div x-show="editForm.hasSessionLimit" class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Total de sesiones</label>
                                    <input type="number" min="0" x-model="editForm.sessions_total"
                                        class="w-full rounded-lg border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Sesiones usadas</label>
                                    <input type="number" min="0" x-model="editForm.sessions_used"
                                        class="w-full rounded-lg border-slate-200 focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                            </div>
                            <p x-show="editForm.hasSessionLimit" class="text-xs text-slate-500">
                                Restantes: <span class="font-medium" x-text="Math.max(0, (editForm.sessions_total || 0) - (editForm.sessions_used || 0))"></span> sesiones
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Estado</label>
                                <select x-model="editForm.status" required
                                    class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-blue-500">
                                    <option value="ACTIVE">Activa</option>
                                    <option value="PENDING_PAYMENT">Pendiente de Pago</option>
                                    <option value="EXPIRED">Caducada</option>
                                    <option value="CANCELLED">Cancelada</option>
                                    <option value="PENDING">Pendiente</option>
                                    <option value="PAUSED">Pausada</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Tipo</label>
                                <label class="flex items-center gap-2 mt-3">
                                    <input type="checkbox" x-model="editForm.is_recurring"
                                        class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-600">Recurrente (cobro autom√°tico)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Reglas de Acceso -->
                        <div class="border border-slate-200 rounded-xl p-4 space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-slate-700 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                    Reglas de Acceso
                                </label>
                                <span x-show="editForm.loadingData" class="text-xs text-slate-400">Cargando...</span>
                            </div>
                            
                            <!-- Tabla de Reglas -->
                            <div class="overflow-x-auto" x-show="!editForm.loadingData">
                                <table class="w-full text-xs">
                                    <thead class="text-slate-500 uppercase bg-slate-50">
                                        <tr>
                                            <th class="px-2 py-2 text-left">Actividad</th>
                                            <th class="px-2 py-2 text-left">Servicio</th>
                                            <th class="px-2 py-2 w-16">Cant.</th>
                                            <th class="px-2 py-2">Periodo</th>
                                            <th class="px-2 py-2 w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <template x-for="(rule, index) in editForm.accessRules" :key="index">
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-2 py-2">
                                                    <select x-model="rule.activity_category_id" 
                                                        class="w-full text-xs rounded border-slate-200 mb-1"
                                                        @change="rule.activity_id = null">
                                                        <option value="">-- Categor√≠a --</option>
                                                        <template x-for="cat in editForm.activityCategories" :key="cat.id">
                                                            <option :value="cat.id" x-text="cat.name"></option>
                                                        </template>
                                                    </select>
                                                    <select x-model="rule.activity_id" 
                                                        class="w-full text-xs rounded border-slate-200"
                                                        @change="rule.activity_category_id = null">
                                                        <option value="">-- Espec√≠fica --</option>
                                                        <template x-for="act in editForm.activities" :key="act.id">
                                                            <option :value="act.id" x-text="act.name"></option>
                                                        </template>
                                                    </select>
                                                </td>
                                                <td class="px-2 py-2">
                                                    <select x-model="rule.service_category_id" 
                                                        class="w-full text-xs rounded border-slate-200 mb-1"
                                                        @change="rule.service_id = null">
                                                        <option value="">-- Categor√≠a --</option>
                                                        <template x-for="cat in editForm.serviceCategories" :key="cat.id">
                                                            <option :value="cat.id" x-text="cat.name"></option>
                                                        </template>
                                                    </select>
                                                    <select x-model="rule.service_id" 
                                                        class="w-full text-xs rounded border-slate-200"
                                                        @change="rule.service_category_id = null">
                                                        <option value="">-- Espec√≠fico --</option>
                                                        <template x-for="srv in editForm.services" :key="srv.id">
                                                            <option :value="srv.id" x-text="srv.name"></option>
                                                        </template>
                                                    </select>
                                                </td>
                                                <td class="px-2 py-2">
                                                    <input type="number" min="0" x-model="rule.quantity" 
                                                        class="w-full text-xs rounded border-slate-200 text-center"
                                                        placeholder="0=‚àû">
                                                </td>
                                                <td class="px-2 py-2">
                                                    <select x-model="rule.period" class="w-full text-xs rounded border-slate-200">
                                                        <option value="PER_CYCLE">Por Ciclo</option>
                                                        <option value="TOTAL">Total</option>
                                                    </select>
                                                </td>
                                                <td class="px-2 py-2 text-center">
                                                    <button type="button" @click="removeAccessRule(index)" 
                                                        class="text-red-400 hover:text-red-600">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Bot√≥n A√±adir Regla -->
                            <button type="button" @click="addAccessRule()" 
                                class="text-xs font-medium text-[var(--brand-color)] flex items-center gap-1 hover:underline">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                A√±adir regla de acceso
                            </button>
                            
                            <p class="text-[10px] text-slate-500">
                                Define qu√© actividades o servicios puede usar este cliente. Cantidad 0 = ilimitado.
                            </p>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" @click="showEditModal = false"
                                class="flex-1 px-4 py-3 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="submittingEdit"
                                class="flex-1 px-4 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 disabled:opacity-50">
                                <span x-show="!submittingEdit">Guardar Cambios</span>
                                <span x-show="submittingEdit">Guardando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <script>
            function membershipActions() {
                return {
                    chargingId: null,
                    showPauseModal: false,
                    submittingPause: false,
                    showEditModal: false,
                    submittingEdit: false,
                    pauseForm: {
                        membershipId: null,
                        membershipName: '',
                        start_date: '',
                        end_date: '',
                        reason: ''
                    },
                    editForm: {
                        membershipId: null,
                        membershipName: '',
                        start_date: '',
                        end_date: '',
                        price: 0,
                        status: 'ACTIVE',
                        is_recurring: true,
                        sessions_total: null,
                        sessions_used: 0,
                        next_billing_date: '',
                        hasSessionLimit: false,
                        loadingData: false,
                        // Datos para reglas de acceso
                        activityCategories: [],
                        activities: [],
                        serviceCategories: [],
                        services: [],
                        accessRules: []
                    },
                    addAccessRule() {
                        this.editForm.accessRules.push({
                            id: null,
                            activity_category_id: null,
                            activity_id: null,
                            service_category_id: null,
                            service_id: null,
                            quantity: 0,
                            quantity_used: 0,
                            period: 'PER_CYCLE'
                        });
                    },
                    removeAccessRule(index) {
                        this.editForm.accessRules.splice(index, 1);
                    },
                    getCsrfToken() {
                        const match = document.cookie.match(/csrftoken=([^;]+)/);
                        return match ? match[1] : '';
                    },
                    openPauseModal(membershipId, membershipName) {
                        this.pauseForm.membershipId = membershipId;
                        this.pauseForm.membershipName = membershipName;
                        // Set default dates (3 days from now to 30 days later)
                        const today = new Date();
                        const startDate = new Date(today.getTime() + (3 * 24 * 60 * 60 * 1000));
                        const endDate = new Date(startDate.getTime() + (30 * 24 * 60 * 60 * 1000));
                        this.pauseForm.start_date = startDate.toISOString().split('T')[0];
                        this.pauseForm.end_date = endDate.toISOString().split('T')[0];
                        this.showPauseModal = true;
                    },
                    calculateDays() {
                        if (!this.pauseForm.start_date || !this.pauseForm.end_date) return 0;
                        const start = new Date(this.pauseForm.start_date);
                        const end = new Date(this.pauseForm.end_date);
                        const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                        return diff > 0 ? diff : 0;
                    },
                    async submitPause() {
                        if (this.submittingPause) return;
                        this.submittingPause = true;

                        try {
                            const response = await fetch('{% url "api_membership_pause" %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': this.getCsrfToken()
                                },
                                body: JSON.stringify({
                                    membership_id: this.pauseForm.membershipId,
                                    start_date: this.pauseForm.start_date,
                                    end_date: this.pauseForm.end_date,
                                    reason: this.pauseForm.reason
                                })
                            });

                            const data = await response.json();

                            if (response.ok) {
                                alert(data.message || 'Pausa creada correctamente');
                                window.location.reload();
                            } else {
                                alert(data.error || 'Error al crear la pausa');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        } finally {
                            this.submittingPause = false;
                        }
                    },
                    openEditModal(membershipId, membershipName, startDate, endDate, price, status, isRecurring, sessionsTotal, sessionsUsed, nextBillingDate) {
                        this.editForm.membershipId = membershipId;
                        this.editForm.membershipName = membershipName;
                        this.editForm.start_date = startDate;
                        this.editForm.end_date = endDate || '';
                        this.editForm.price = parseFloat(price) || 0;
                        this.editForm.status = status;
                        this.editForm.is_recurring = isRecurring === true || isRecurring === 'true';
                        this.editForm.sessions_total = sessionsTotal;
                        this.editForm.sessions_used = sessionsUsed || 0;
                        this.editForm.next_billing_date = nextBillingDate || '';
                        this.editForm.hasSessionLimit = sessionsTotal !== null && sessionsTotal !== 'null';
                        this.editForm.loadingData = true;
                        this.editForm.activityCategories = [];
                        this.editForm.activities = [];
                        this.editForm.serviceCategories = [];
                        this.editForm.services = [];
                        this.editForm.accessRules = [];
                        this.showEditModal = true;
                        
                        // Cargar datos de reglas de acceso
                        this.loadMembershipDetails(membershipId);
                    },
                    async loadMembershipDetails(membershipId) {
                        try {
                            const response = await fetch(`/api/membership/${membershipId}/details/`);
                            if (response.ok) {
                                const data = await response.json();
                                this.editForm.activityCategories = data.activity_categories || [];
                                this.editForm.activities = data.activities || [];
                                this.editForm.serviceCategories = data.service_categories || [];
                                this.editForm.services = data.services || [];
                                this.editForm.accessRules = data.access_rules || [];
                            }
                        } catch (e) {
                            console.error('Error loading membership details:', e);
                        } finally {
                            this.editForm.loadingData = false;
                        }
                    },
                    async submitEdit() {
                        if (this.submittingEdit) return;
                        this.submittingEdit = true;

                        try {
                            const payload = {
                                membership_id: this.editForm.membershipId,
                                start_date: this.editForm.start_date,
                                end_date: this.editForm.end_date || null,
                                price: this.editForm.price,
                                status: this.editForm.status,
                                is_recurring: this.editForm.is_recurring,
                                sessions_total: this.editForm.hasSessionLimit ? parseInt(this.editForm.sessions_total) : null,
                                sessions_used: parseInt(this.editForm.sessions_used) || 0,
                                next_billing_date: this.editForm.next_billing_date || null,
                                access_rules: this.editForm.accessRules.map(rule => ({
                                    id: rule.id,
                                    activity_category_id: rule.activity_category_id || null,
                                    activity_id: rule.activity_id || null,
                                    service_category_id: rule.service_category_id || null,
                                    service_id: rule.service_id || null,
                                    quantity: parseInt(rule.quantity) || 0,
                                    quantity_used: parseInt(rule.quantity_used) || 0,
                                    period: rule.period || 'PER_CYCLE'
                                }))
                            };

                            const response = await fetch('/api/membership-edit/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': this.getCsrfToken()
                                },
                                body: JSON.stringify(payload)
                            });

                            const data = await response.json();

                            if (response.ok) {
                                alert(data.message || 'Membres√≠a actualizada correctamente');
                                window.location.reload();
                            } else {
                                alert(data.error || 'Error al actualizar');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        } finally {
                            this.submittingEdit = false;
                        }
                    },
                    async chargeMembership(id) {
                        if (this.chargingId) { return; }
                        if (!confirm('¬øCobrar la siguiente cuota ahora?')) { return; }
                        this.chargingId = id;
                        try {
                            const response = await fetch(`{% url 'api_subscription_charge' 0 %}`.replace('/0/', `/${id}/`), {
                                method: 'POST',
                                headers: { 'X-CSRFToken': this.getCsrfToken() }
                            });
                            const data = await response.json();
                            if (response.ok) {
                                alert(data.message || 'Cuota cobrada correctamente');
                                window.location.reload();
                            } else if (response.status === 409 && data.duplicate) {
                                if (confirm(data.warning + ' ¬øContinuar de todas formas?')) {
                                    const retry = await fetch(`{% url 'api_subscription_charge' 0 %}`.replace('/0/', `/${id}/`) + '?force=1', {
                                        method: 'POST',
                                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                                    });
                                    const retryData = await retry.json();
                                    if (retry.ok) {
                                        alert(retryData.message || 'Cuota cobrada correctamente');
                                        window.location.reload();
                                    } else {
                                        alert(retryData.error || 'No se pudo cobrar la cuota');
                                    }
                                }
                            } else {
                                alert(data.error || 'No se pudo cobrar la cuota');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n al cobrar la cuota');
                        } finally {
                            this.chargingId = null;
                        }
                    }
                };
            }
        </script>
                </div>
                <!-- FIN TAB: Membres√≠as -->

                <!-- TAB: Actividad -->
                <div x-show="activeTab === 'activity'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="space-y-6">

        <!-- Reservas y Asistencias a Clases -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Reservas y Asistencias</h3>
            </div>
            <div class="p-6">
                {% if visits %}
                <div class="space-y-4">
                    {% for visit in visits|slice:":5" %}
                    <div class="flex items-center justify-between hover:bg-slate-50 rounded-xl p-2 -mx-2 cursor-pointer transition-colors"
                        onclick="window.location.href='{% url 'calendar_view' %}?date={{ visit.date|date:'Y-m-d' }}'">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-100 text-slate-500">
                                {% if visit.status == 'SCHEDULED' %}üìÖ{% else %}üìç{% endif %}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-slate-800">{{ visit.concept|default:"Clase" }}</div>
                                <div class="text-xs text-slate-400">{{ visit.date|date:"l d M, Y" }} ¬∑ {{
                                    visit.check_in_time|time:"H:i"|default:"--" }}</div>
                            </div>
                        </div>
                        <div class="text-xs font-medium 
                            {% if visit.status == 'ATTENDED' %}text-emerald-600
                            {% elif visit.status == 'NOSHOW' %}text-red-500
                            {% else %}text-blue-500{% endif %}">
                            {{ visit.get_status_display }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">Sin reservas de clases todav√≠a.</p>
                {% endif %}
            </div>
        </section>

        <!-- Control de Acceso (Entradas/Salidas f√≠sicas) -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="accessControl()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Historial de Accesos</h3>
                <div class="flex items-center gap-2">
                    <button @click="registerAccess('ENTRY')" 
                            class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-green-700 bg-green-100 hover:bg-green-200 rounded-lg transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14"></path>
                        </svg>
                        Entrada
                    </button>
                    <button @click="registerAccess('EXIT')" 
                            class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-orange-700 bg-orange-100 hover:bg-orange-200 rounded-lg transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                        </svg>
                        Salida
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Mensaje de estado -->
                <div x-show="message" x-transition 
                     :class="messageType === 'success' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'"
                     class="mb-4 px-4 py-2 rounded-lg border text-sm flex items-center gap-2">
                    <span x-text="message"></span>
                </div>
                
                {% if access_logs %}
                <div class="space-y-3">
                    {% for log in access_logs|slice:":10" %}
                    <div class="flex items-center justify-between py-2 border-b border-slate-100 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center 
                                {% if log.direction == 'ENTRY' %}bg-green-100 text-green-600{% else %}bg-orange-100 text-orange-600{% endif %}">
                                {% if log.direction == 'ENTRY' %}
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14"></path>
                                </svg>
                                {% else %}
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                                </svg>
                                {% endif %}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-slate-800">
                                    {% if log.direction == 'ENTRY' %}Entrada{% else %}Salida{% endif %}
                                    {% if log.status == 'MANUAL' %}<span class="text-xs text-slate-400">(manual)</span>{% endif %}
                                </div>
                                <div class="text-xs text-slate-500">
                                    {{ log.timestamp|date:"d/m/Y" }} a las {{ log.timestamp|time:"H:i:s" }}
                                    {% if log.device %} ¬∑ {{ log.device.name }}{% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if log.status == 'GRANTED' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">OK</span>
                            {% elif log.status == 'DENIED' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Denegado</span>
                            {% elif log.status == 'MANUAL' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Manual</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if access_logs.count > 10 %}
                <a href="{% url 'access_control:log_list' %}?client={{ client.id }}" 
                   class="mt-4 block text-center text-sm text-[var(--brand-color)] hover:underline">
                    Ver historial completo ({{ access_logs.count }} registros)
                </a>
                {% endif %}
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">Sin registro de accesos todav√≠a.</p>
                {% endif %}
            </div>
        </section>
        
        <script>
            function accessControl() {
                return {
                    message: '',
                    messageType: '',
                    
                    async registerAccess(direction) {
                        try {
                            const response = await fetch('{% url "access_control:api_manual_access" %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    client_id: {{ client.id }},
                                    direction: direction
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                this.message = data.message;
                                this.messageType = 'success';
                                // Recargar despu√©s de 1.5 segundos
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                this.message = data.error || 'Error al registrar acceso';
                                this.messageType = 'error';
                            }
                        } catch (error) {
                            this.message = 'Error de conexi√≥n';
                            this.messageType = 'error';
                        }
                        
                        // Ocultar mensaje despu√©s de 5 segundos
                        setTimeout(() => this.message = '', 5000);
                    }
                };
            }
        </script>

        <!-- Taquillas Asignadas -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Taquillas Asignadas</h3>
                <a href="{% url 'lockers:assign_to_client' client.id %}" 
                   class="text-xs font-medium text-[var(--brand-color)] hover:underline flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Asignar
                </a>
            </div>
            <div class="p-6">
                {% if locker_assignments %}
                <div class="space-y-3">
                    {% for assignment in locker_assignments %}
                    <div class="flex items-center justify-between py-3 px-4 bg-slate-50 rounded-xl border border-slate-100 card-hover transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center">
                                <span class="text-lg font-bold text-indigo-700">{{ assignment.locker.number }}</span>
                            </div>
                            <div>
                                <div class="font-medium text-slate-800">
                                    Taquilla {{ assignment.locker.number }}
                                </div>
                                <div class="text-xs text-slate-500">
                                    {{ assignment.locker.zone.name }} ¬∑ {{ assignment.locker.get_size_display }}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm">
                                {% if assignment.end_date %}
                                    {% if assignment.days_remaining == 0 %}
                                    <span class="text-amber-600 font-medium">Vence hoy</span>
                                    {% elif assignment.days_remaining <= 7 %}
                                    <span class="text-amber-600">{{ assignment.days_remaining }} d√≠as</span>
                                    {% else %}
                                    <span class="text-slate-600">hasta {{ assignment.end_date|date:"d/m/Y" }}</span>
                                    {% endif %}
                                {% else %}
                                <span class="text-green-600">Indefinida</span>
                                {% endif %}
                            </div>
                            {% if assignment.monthly_price %}
                            <div class="text-xs text-slate-400">{{ assignment.monthly_price }}‚Ç¨/mes</div>
                            {% endif %}
                        </div>
                        <div class="ml-4">
                            {% if assignment.key_delivered %}
                            <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-green-100 text-green-700" title="Llave entregada">
                                <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                                Llave
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-slate-100 text-slate-500" title="Llave pendiente">
                                <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Sin llave
                            </span>
                            {% endif %}
                        </div>
                        <a href="{% url 'lockers:release' assignment.id %}" 
                           class="ml-3 p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                           title="Liberar taquilla">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
                            </svg>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6">
                    <svg class="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                    </svg>
                    <p class="text-sm text-slate-400 mb-3">Sin taquillas asignadas</p>
                    <a href="{% url 'lockers:assign_to_client' client.id %}" 
                       class="inline-flex items-center gap-1 text-sm font-medium text-[var(--brand-color)] hover:underline">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Asignar taquilla
                    </a>
                </div>
                {% endif %}
            </div>
        </section>
                </div>
                <!-- FIN TAB: Actividad -->

                <!-- TAB: Entrenamiento -->
                <div x-show="activeTab === 'training'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="space-y-6">

        <!-- Rutinas de Entrenamiento -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="routineHandler()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Rutinas de Entrenamiento</h3>
                <div class="flex gap-2">
                    <button @click="createPersonal()"
                        class="text-xs font-medium text-slate-500 hover-brand hover:underline">
                        + Nueva en Blanco
                    </button>
                    <button @click="showAssignModal = true"
                        class="btn-brand px-3 py-1 text-xs">
                        Asignar Plantilla
                    </button>
                </div>
            </div>

            <div class="p-6">
                {% if client_routines %}
                <div class="space-y-3">
                    {% for cr in client_routines %}
                    <div
                        class="flex items-center justify-between p-3 border border-[var(--brand-color)]/20 rounded-xl bg-[var(--brand-color)]/5 hover:bg-[var(--brand-color)]/10 transition-colors group">
                        <!-- Routine Info -->
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-lg border border-[var(--brand-color)]/30 text-[var(--brand-color)]">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm">{{ cr.routine.name }}</div>
                                <div class="text-xs text-slate-500">
                                    Inicio: {{ cr.start_date|date:"d M Y" }} ¬∑ {{ cr.routine.get_goal_display }}
                                </div>
                            </div>
                        </div>

                        <a href="{% url 'routine_detail' cr.routine.id %}"
                            class="text-xs font-bold text-[var(--brand-color)] hover-brand bg-white border border-[var(--brand-color)]/30 px-3 py-1.5 rounded-lg shadow-sm">
                            Abrir Editor
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">No tiene rutinas asignadas.</p>
                {% endif %}
            </div>

            <!-- Modal Assign -->
            <div x-show="showAssignModal" style="display: none;"
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-4 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-900">Asignar Plantilla</h3>
                        <button @click="showAssignModal = false" class="text-slate-400 hover:text-slate-600">‚úï</button>
                    </div>
                    <div class="p-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Selecciona una plantilla:</label>
                        <select x-model="selectedTemplate"
                            class="w-full px-3 py-2 border border-slate-200 rounded-xl mb-4 bg-white">
                            <option value="">-- Elegir --</option>
                            {% for t in routine_templates %}
                            <option value="{{ t.id }}">{{ t.name }} ({{ t.get_difficulty_display }})</option>
                            {% endfor %}
                        </select>
                        <button @click="assignTemplate()" :disabled="!selectedTemplate"
                            class="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold disabled:opacity-50 hover:bg-indigo-700 transition-colors">
                            Asignar y Copiar
                        </button>
                    </div>
                </div>
            </div>

            <script>
                function routineHandler() {
                    return {
                        showAssignModal: false,
                        selectedTemplate: '',
                        clientId: {{ client.id }},
                    
                    async assignTemplate() {
                    if (!this.selectedTemplate) return;

                    const res = await fetch(`/routines/api/clients/${this.clientId}/assign/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                        body: JSON.stringify({ template_id: this.selectedTemplate })
                    });
                    const data = await res.json();
                    if (data.status === 'success') location.reload();
                    else alert('Error: ' + data.message);
                },
                    
                    async createPersonal() {
                    if (!confirm('¬øCrear rutina personalizada en blanco?')) return;

                    const res = await fetch(`/routines/api/clients/${this.clientId}/create-personal/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        // Redirect to builder
                        window.location.href = `/backoffice/routines/${data.routine_id}/builder/`;
                    }
                    else alert('Error: ' + data.message);
                }
                }
            }
            </script>
        </section>
                </div>
                <!-- FIN TAB: Entrenamiento -->

                <!-- TAB: Ventas -->
                <div x-show="activeTab === 'sales'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="space-y-6">

        <!-- Compras (Orders) - Enhanced with expandable rows -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="purchaseHistory()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Historial de Ventas</h3>
                <a href="{% url 'pos_home' %}?client_id={{ client.id }}"
                    class="text-xs font-medium text-[var(--brand-color)] hover:underline flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Nueva Venta
                </a>
            </div>
            <div class="divide-y divide-slate-100">
                {% if client.orders.exists %}
                {% for order in client.orders.all %}
                <div class="group">
                    <!-- Order Row (Clickable) -->
                    <div @click="toggle({{ order.id }})"
                        class="px-6 py-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-4">
                            <!-- Status Icon -->
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg
                                    {% if order.total_amount < 0 %}bg-red-100 text-red-600
                                    {% elif order.status == 'PAID' %}bg-emerald-100 text-emerald-600
                                    {% elif order.status == 'CANCELLED' %}bg-red-100 text-red-500
                                    {% else %}bg-amber-100 text-amber-600{% endif %}">
                                {% if order.total_amount < 0 %}‚Ü©{% elif order.status == 'PAID' %}üí∞{% elif order.status == 'CANCELLED' %}‚úï{% else %}‚è≥{% endif %}
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800 flex items-center gap-2">
                                    {% if order.total_amount < 0 %}
                                    <span class="text-red-600">Devoluci√≥n</span>
                                    {% else %}
                                    Ticket #{{ order.id }}
                                    {% endif %}
                                    {% if order.invoice_number %}
                                    <span class="text-xs text-slate-400 font-normal">({{ order.invoice_number }})</span>
                                    {% endif %}
                                    {% if order.total_refunded > 0 %}
                                    <span class="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full">
                                        Dev: {{ order.total_refunded }}‚Ç¨
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-slate-400">{{ order.created_at|date:"d M Y ¬∑ H:i" }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Status Pill -->
                            <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-1 rounded-full
                                    {% if order.total_amount < 0 %}bg-red-100 text-red-600
                                    {% elif order.status == 'PAID' %}bg-emerald-100 text-emerald-700
                                    {% elif order.status == 'CANCELLED' %}bg-red-100 text-red-600
                                    {% else %}bg-amber-100 text-amber-700{% endif %}">
                                {% if order.total_amount < 0 %}Devoluci√≥n{% else %}{{ order.get_status_display }}{% endif %}
                            </span>
                            <!-- Amount -->
                            <div class="text-right min-w-[80px]">
                                <div class="font-bold {% if order.total_amount < 0 %}text-red-600{% else %}text-slate-900{% endif %}">
                                    {{ order.total_amount }}‚Ç¨
                                </div>
                                <div class="text-[10px] text-slate-400 mt-1" title="Cobrado por">
                                    üë§ {{ order.created_by.first_name|default:order.created_by.email }}
                                </div>
                            </div>
                            <!-- Hover Actions -->
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <!-- Send Ticket (Email) -->
                                <button @click.stop="sendTicket({{ order.id }}, '{{ client.email|default:'' }}')"
                                    class="p-2 rounded-lg text-slate-400 hover:text-blue-500 hover:bg-blue-50 transition-colors"
                                    title="Enviar ticket por email">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                </button>
                                <!-- Edit Order -->
                                <button @click.stop="openEditModal({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-amber-500 hover:bg-amber-50 transition-colors"
                                    title="Editar venta">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    </svg>
                                </button>
                                <!-- Print Ticket -->
                                <button @click.stop="printTicket({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-[var(--brand-color)] hover:bg-slate-100 transition-colors"
                                    title="Imprimir ticket">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                                        </path>
                                    </svg>
                                </button>
                                <!-- Generate Invoice -->
                                <button x-show="!{{ order.invoice_number|yesno:'true,false' }}"
                                    @click.stop="generateInvoice({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-purple-600 hover:bg-purple-50 transition-colors"
                                    title="Generar Factura">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                </button>
                                <!-- Cancel Order (only if PAID) -->
                                {% if order.status == 'PAID' %}
                                <button @click.stop="confirmCancel({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors"
                                    title="Cancelar venta">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                {% endif %}
                                <!-- Expand Indicator -->
                                <svg class="w-4 h-4 text-slate-300 transition-transform ml-1"
                                    :class="{ 'rotate-180': expanded === {{ order.id }} }" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Details -->
                    <div x-show="expanded === {{ order.id }}" x-collapse
                        class="bg-slate-50 border-t border-slate-100 px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Items -->
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Art√≠culos
                                </h4>
                                <ul class="space-y-2">
                                    {% for item in order.items.all %}
                                    <li class="flex justify-between text-sm">
                                        <span class="text-slate-700">
                                            <span class="font-medium">{{ item.quantity }}x</span> {{ item.description }}
                                        </span>
                                        <span class="text-slate-600 font-medium">{{ item.subtotal }}‚Ç¨</span>
                                    </li>
                                    {% empty %}
                                    <li class="text-sm text-slate-400">Sin art√≠culos</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <!-- Payments -->
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Pagos</h4>
                                <ul class="space-y-2">
                                    {% for payment in order.payments.all %}
                                    <li class="flex justify-between text-sm">
                                        <span class="text-slate-700">{{ payment.payment_method.name }}</span>
                                        <span class="text-slate-600 font-medium">{{ payment.amount }}‚Ç¨</span>
                                    </li>
                                    {% empty %}
                                    <li class="text-sm text-slate-400">Sin pagos registrados</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-slate-400 text-sm text-center py-6">No hay ventas registradas.</p>
                {% endif %}
            </div>

            <!-- Cancel Confirmation Modal -->
            <div x-show="showCancelModal" style="display: none;"
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-4 overflow-hidden">
                    <div class="p-6 text-center">
                        <div
                            class="w-12 h-12 rounded-full bg-red-100 text-red-500 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                </path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">¬øCancelar venta?</h3>
                        <p class="text-sm text-slate-500 mb-6">Esta acci√≥n no se puede deshacer. El estado de la venta
                            cambiar√° a "Cancelado".</p>
                        <div class="flex gap-3">
                            <button @click="showCancelModal = false"
                                class="flex-1 px-4 py-2 border border-slate-200 rounded-xl text-slate-600 font-medium hover:bg-slate-50 transition-colors">
                                No, volver
                            </button>
                            <button @click="executeCancel()"
                                class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                                S√≠, cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Order Modal -->
            <div x-show="showEditModal" style="display: none;"
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-900">Editar Venta #<span
                                x-text="editingOrder?.id"></span></h3>
                        <button @click="showEditModal = false" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <!-- Date & Time -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Fecha</label>
                                <input type="date" x-model="editForm.date"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hora</label>
                                <input type="time" x-model="editForm.time"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent">
                            </div>
                        </div>
                        <!-- Payment Methods (permission-gated) -->
                        {% if perms.sales.change_sale %}
                        <div x-show="editingOrder?.payments?.length > 0">
                            <label class="block text-sm font-medium text-slate-700 mb-2">M√©todo de pago</label>
                            <template x-for="(payment, index) in editingOrder?.payments || []" :key="index">
                                <div class="flex items-center gap-3 mb-2 p-3 bg-slate-50 rounded-xl">
                                    <div class="flex-1">
                                        <select x-model="editForm.payments[index]"
                                            class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent bg-white">
                                            {% for pm in payment_methods %}
                                            <option value="{{ pm.id }}">{{ pm.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="text-sm font-semibold text-slate-600" x-text="payment.amount + '‚Ç¨'">
                                    </div>
                                </div>
                            </template>
                        </div>
                        {% endif %}
                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Notas internas</label>
                            <textarea x-model="editForm.notes" rows="3"
                                class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent resize-none"
                                placeholder="Notas del personal..."></textarea>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 flex gap-3 justify-end">
                        <button @click="showEditModal = false"
                            class="px-4 py-2 border border-slate-200 rounded-xl text-slate-600 font-medium hover:bg-white transition-colors">
                            Cancelar
                        </button>
                        <button @click="saveOrderEdit()" :disabled="isSaving"
                            class="px-4 py-2 bg-[var(--brand-color)] text-white rounded-xl font-medium hover:opacity-90 transition-colors disabled:opacity-50">
                            <span x-show="!isSaving">Guardar</span>
                            <span x-show="isSaving">Guardando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <script>
            function purchaseHistory() {
                return {
                    expanded: null,
                    showCancelModal: false,
                    orderToCancel: null,
                    // Edit Modal
                    showEditModal: false,
                    editingOrder: null,
                    editForm: { date: '', time: '', notes: '', payment_method: '' },
                    isSaving: false,

                    toggle(orderId) {
                        this.expanded = this.expanded === orderId ? null : orderId;
                    },

                    confirmCancel(orderId) {
                        this.orderToCancel = orderId;
                        this.showCancelModal = true;
                    },

                    async executeCancel() {
                        if (!this.orderToCancel) return;

                        try {
                            const res = await fetch(`/sales/api/order/${this.orderToCancel}/cancel/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                }
                            });

                            if (res.ok) {
                                window.location.reload();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Error al cancelar la venta');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        }

                        this.showCancelModal = false;
                        this.orderToCancel = null;
                    },

                    printTicket(orderId) {
                        window.open(`/sales/ticket/${orderId}/print/`, '_blank');
                    },

                    async sendTicket(orderId, email) {
                        if (!email) {
                            email = prompt('Email del cliente:', '');
                            if (!email) return;
                        }

                        try {
                            const res = await fetch(`/sales/api/order/${orderId}/send-ticket/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ email })
                            });

                            if (res.ok) {
                                alert('‚úÖ Ticket enviado correctamente a ' + email);
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Error al enviar el ticket');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        }
                    },

                    async openEditModal(orderId) {
                        try {
                            const res = await fetch(`/sales/api/order/${orderId}/`);
                            if (res.ok) {
                                const order = await res.json();
                                this.editingOrder = order;
                                const dt = new Date(order.created_at);

                                // Map payments to editable format (array of method IDs)
                                const payments = order.payments.map(p => p.method_id);

                                this.editForm = {
                                    date: dt.toISOString().split('T')[0],
                                    time: dt.toTimeString().slice(0, 5),
                                    notes: order.internal_notes || '',
                                    payments: payments
                                };

                                // Since I haven't fixed the API in this turn, I will do a quick fix to the API in next turn?
                                // OR better: The HTML uses `payment_methods` context variable which has name/id.
                                // I can try to match name.
                                // Better: Update API.

                                this.showEditModal = true;
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error cargando datos');
                        }
                    },

                    async generateInvoice(orderId) {
                        try {
                            const res = await fetch(`/sales/api/order/${orderId}/invoice/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({})
                            });
                            const data = await res.json();
                            if (res.ok) {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert(data.error);
                            }
                        } catch (e) {
                            alert("Error generating invoice");
                        }
                    },

                    async saveOrderEdit() {
                        if (!this.editingOrder) return;
                        this.isSaving = true;

                        // Reconstruct payments array for API
                        // API expects: payments: [ { method_id: 1, amount: 50 }, ... ]
                        // editForm.payments is simple array of method_ids [1, 2] corresponding to editingOrder.payments indices

                        const paymentsPayload = this.editingOrder.payments.map((p, index) => ({
                            method_id: this.editForm.payments[index],
                            amount: p.amount,
                            transaction_id: p.transaction_id
                        }));

                        try {
                            const res = await fetch(`/sales/api/order/${this.editingOrder.id}/update/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    date: this.editForm.date,
                                    time: this.editForm.time,
                                    internal_notes: this.editForm.notes,
                                    payments: paymentsPayload
                                })
                            });

                            // ... existing handling ...
                            if (res.ok) {
                                window.location.reload();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Error al guardar');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        }

                        this.isSaving = false;
                    }
                }
            }
        </script>
                </div>
                <!-- FIN TAB: Ventas -->

            </div>
            <!-- Fin Contenido de Pesta√±as -->
            
        </div>
        <!-- Fin Columna Derecha -->

    </div>
    <!-- Fin Layout Principal con Pesta√±as -->

    <script>
            // Initialize clientDetail data
            document.addEventListener('alpine:init', () => {
                Alpine.data('clientDetail', () => ({
                    showAlerts: false,
                    clientReady: false,
                    clientId: {{ client.id }},
                    emailNotifications: {{ client.email_notifications_enabled|yesno:'true,false' }},
                    alerts: [
                        {% for alert in popup_alerts %}
                        {
                            id: {{ alert.id }},
                            text: `{{ alert.text|escapejs }}`,
                            type: '{{ alert.type }}',
                            author: '{{ alert.author.first_name|default:"Staff" }}',
                            date: '{{ alert.created_at|date:"d M" }}'
                        },
                        {% endfor %}
                    ],
                    init() {
                        // Clear previous alerts state immediately to prevent flash
                        this.showAlerts = false;
                        this.clientReady = false;
                        
                        // Store current client ID in sessionStorage
                        const storedClientId = sessionStorage.getItem('currentClientId');
                        const currentClientId = String(this.clientId);
                        
                        // Always update stored client ID first
                        sessionStorage.setItem('currentClientId', currentClientId);
                        
                        // Use requestAnimationFrame to ensure DOM is fully rendered
                        requestAnimationFrame(() => {
                            // Double-check we're still on the same client
                            if (String(this.clientId) === sessionStorage.getItem('currentClientId')) {
                                this.clientReady = true;
                                if (this.alerts.length > 0) {
                                    // Longer delay for different client, shorter for same
                                    const delay = (storedClientId && storedClientId !== currentClientId) ? 500 : 300;
                                    setTimeout(() => {
                                        // Final check before showing
                                        if (this.clientReady && String(this.clientId) === sessionStorage.getItem('currentClientId')) {
                                            this.showAlerts = true;
                                        }
                                    }, delay);
                                }
                            }
                        });
                        
                        // Hide alerts when clicking any navigation link
                        this.setupNavigationListeners();
                    },
                    setupNavigationListeners() {
                        // Listen for clicks on any link that navigates away
                        document.addEventListener('click', (e) => {
                            const link = e.target.closest('a[href]');
                            if (link && !link.hasAttribute('target')) {
                                // Hide alerts immediately on navigation
                                this.showAlerts = false;
                            }
                        });
                    },
                    async toggleEmailNotifications() {
                try {
                    const res = await fetch('{% url "client_toggle_email_notifications" client.id %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });

                    if (res.ok) {
                        const data = await res.json();
                        this.emailNotifications = data.email_notifications_enabled;

                        // Mostrar feedback visual
                        const icon = this.emailNotifications ? '‚úÖ' : 'üîï';
                        const msg = this.emailNotifications ? 'Notificaciones activadas' : 'Notificaciones desactivadas';
                        alert(`${icon} ${msg}`);
                    } else {
                        alert('Error al cambiar preferencia');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error de conexi√≥n');
                }
            }
                }));
            });
        </script>

    </div>
</div>
{% endblock %}