{% extends "backoffice/base.html" %}

{% block title %}Dashboard ¬∑ New CRM{% endblock %}
{% block breadcrumb %}Backoffice{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_right %}
<form method="post" action="{% url 'select_gym' %}" class="flex items-center gap-2">
  {% csrf_token %}
  <select name="gym_id" class="text-sm rounded-2xl border border-slate-300 px-3 py-2 bg-white">
    {% for m in request.user.gym_memberships.all %}
    <option value="{{ m.gym_id }}" {% if m.gym_id==request.session.current_gym_id %}selected{% endif %}>
      {{ m.gym.name }}
    </option>
    {% endfor %}
  </select>

  <button class="text-sm rounded-2xl border border-slate-300 px-3 py-2 hover:bg-slate-50">
    Cambiar
  </button>
</form>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Dashboard</h1>
      <p class="text-slate-500">Resumen de rendimiento de {{ gym.name }}</p>
    </div>
    <div class="flex gap-2">
      <span class="text-sm font-medium text-slate-500 bg-white px-3 py-1.5 rounded-lg border border-slate-200">
        üìÖ {{ stats.today|date:"F Y" }}
      </span>
    </div>
  </div>

  <!-- KPIs Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Revenue -->
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
      <div
        class="absolute right-0 top-0 w-24 h-24 bg-[var(--brand-color)] opacity-5 rounded-bl-full group-hover:scale-110 transition-transform">
      </div>
      <div class="relative z-10">
        <div class="text-sm font-medium text-slate-500 mb-1">Facturaci√≥n (Mes)</div>
        <div class="text-3xl font-bold text-slate-900">{{ stats.revenue_current }} ‚Ç¨</div>
        <div class="flex items-center gap-1 mt-2 text-sm">
          {% if stats.revenue_growth >= 0 %}
          <span class="text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded font-medium flex items-center">
            <svg class="w-3 h-3 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6">
              </path>
            </svg>
            +{{ stats.revenue_growth }}%
          </span>
          {% else %}
          <span class="text-red-600 bg-red-50 px-1.5 py-0.5 rounded font-medium flex items-center">
            <svg class="w-3 h-3 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6">
              </path>
            </svg>
            {{ stats.revenue_growth }}%
          </span>
          {% endif %}
          <span class="text-slate-400">vs mes anterior</span>
        </div>
      </div>
    </div>

    <!-- Members -->
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
      <div class="text-sm font-medium text-slate-500 mb-1">Socios Activos</div>
      <div class="text-3xl font-bold text-slate-900">{{ stats.active_members }}</div>
      <div class="text-sm text-slate-400 mt-2">
        <span class="text-emerald-600 font-medium">+{{ stats.new_members }}</span> nuevos este mes
      </div>
    </div>

    <!-- Taxes (Stimulated) -->
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
      <div class="text-sm font-medium text-slate-500 mb-1">Impuestos Estimados</div>
      <div class="text-3xl font-bold text-slate-900">{{ stats.taxes_current }} ‚Ç¨</div>
      <div class="text-sm text-slate-400 mt-2">IVA Recaudado</div>
    </div>

    <!-- Quick Actions (Minimal) -->
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between">
      <div class="text-sm font-medium text-slate-500 mb-4">Accesos R√°pidos</div>
      <div class="grid grid-cols-2 gap-3">
        <a href="{% url 'pos_home' %}"
          class="flex flex-col items-center justify-center p-3 rounded-xl border border-blue-100 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:border-blue-200 transition-all group">
          <div
            class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform text-blue-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
              </path>
            </svg>
          </div>
          <span class="text-xs font-bold">Ir al TPV</span>
        </a>

        <a href="{% url 'client_create' %}"
          class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 bg-slate-50 text-slate-600 hover:bg-slate-100 hover:border-slate-200 transition-all group">
          <div
            class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center mb-2 group-hover:border-slate-300 transition-colors text-slate-400 group-hover:text-slate-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
            </svg>
          </div>
          <span class="text-xs font-bold">Nuevo Socio</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Charts & Tables Row -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Risk Table -->
    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
      <div class="p-5 border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold text-slate-800">‚ö†Ô∏è Clientes en Riesgo</h3>
        <span class="text-xs font-medium bg-red-100 text-red-600 px-2 py-1 rounded-full">{{ risk_clients|length }}
          Detectados</span>
      </div>
      <div class="flex-1 overflow-y-auto max-h-[400px]">
        {% if risk_clients %}
        <table class="w-full text-sm text-left">
          <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
            <tr>
              <th class="px-4 py-3">Cliente</th>
              <th class="px-4 py-3">Raz√≥n</th>
              <th class="px-4 py-3">Nivel</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for item in risk_clients %}
            <tr class="hover:bg-slate-50 cursor-pointer"
              onclick="window.location='{% url 'client_detail' item.client.id %}'">
              <td class="px-4 py-3 font-medium text-slate-900">{{ item.client.first_name }} {{ item.client.last_name }}
              </td>
              <td class="px-4 py-3 text-slate-500">{{ item.reason }}</td>
              <td class="px-4 py-3">
                <span
                  class="px-2 py-1 rounded-full text-[10px] font-bold 
                                    {% if item.level == 'CRITICAL' %}bg-red-100 text-red-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                  {{ item.level }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-8 text-center text-slate-400 text-sm">
          No hay clientes en riesgo detectados.
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Top Clients -->
    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
      <div class="p-5 border-b border-slate-100">
        <h3 class="font-bold text-slate-800">‚≠ê Top Clientes (LTV)</h3>
      </div>
      <div class="flex-1 overflow-y-auto max-h-[400px]">
        {% if top_clients %}
        <div class="divide-y divide-slate-100">
          {% for client in top_clients %}
          <div class="p-4 flex items-center justify-between hover:bg-slate-50 cursor-pointer"
            onclick="window.location='{% url 'client_detail' client.id %}'">
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">
                {{ forloop.counter }}
              </div>
              <div>
                <div class="font-bold text-slate-900 text-sm">{{ client.first_name }} {{ client.last_name }}</div>
                <div class="text-xs text-slate-400">{{ client.email }}</div>
              </div>
            </div>
            <div class="font-bold text-slate-900 text-sm">{{ client.total_spent_fmt }} ‚Ç¨</div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="p-8 text-center text-slate-400 text-sm">No hay datos a√∫n.</div>
        {% endif %}
      </div>
    </div>

    <!-- Chart (Placeholder for Phase 2) -->
    <div
      class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6 flex flex-col items-center justify-center text-center">
      <div class="bg-blue-50 p-4 rounded-full mb-4">
        <svg class="w-8 h-8 text-[var(--brand-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
        </svg>
      </div>
      <h3 class="font-bold text-slate-900 mb-1">Anal√≠tica Avanzada</h3>
      <p class="text-sm text-slate-500">Pr√≥ximamente ver√°s aqu√≠ la evoluci√≥n gr√°fica de tus ingresos y retenci√≥n.</p>
    </div>

  </div>
</div>
{% endblock %}