{% extends "backoffice/base.html" %}

{% block page_title %}
<div>{{ title }}</div>
<div class="text-sm font-normal text-slate-500 mt-1">Planificador de clases y citas</div>
{% endblock %}

{% block content %}
<div class="h-[calc(100vh-140px)] flex flex-col">

    <!-- Toolbar / Filters -->
    <div
        class="mb-4 flex flex-wrap gap-4 items-center justify-between bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
        <div class="flex items-center gap-2">
            <!-- Room Filter -->
            <select id="roomFilter"
                class="text-sm rounded-lg border-slate-200 focus:border-blue-500 focus:ring-blue-500">
                <option value="">Todas las Salas</option>
                {% for room in rooms %}
                <option value="{{ room.id }}">{{ room.name }}</option>
                {% endfor %}
            </select>

            <button
                class="text-sm font-medium text-slate-600 hover:text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors">
                Filtrar Staff
            </button>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="calendar.changeView('timeGridDay')"
                class="text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 font-medium text-slate-600">Día</button>
            <button onclick="calendar.changeView('timeGridWeek')"
                class="text-sm px-3 py-1.5 rounded-lg bg-slate-100 font-bold text-slate-800">Semana</button>
            <button onclick="calendar.changeView('dayGridMonth')"
                class="text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 font-medium text-slate-600">Mes</button>

            <div class="h-6 w-px bg-slate-200 mx-1"></div>

            <button onclick="triggerNewClassModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Nueva Clase
            </button>
        </div>
    </div>

    <!-- Calendar Container -->
    <div class="flex-1 bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden p-2 relative">
        <div id="calendar" class="h-full"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="absolute inset-0 bg-white/80 flex items-center justify-center z-10 hidden">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
        </div>
    </div>

</div>

<!-- Custom Styles -->
<style>
    .fc {
        font-family: 'Inter', sans-serif;
        --fc-border-color: #f1f5f9;
        --fc-today-bg-color: #f8fafc;
        --fc-event-border-color: transparent;
    }

    .fc-toolbar-title {
        font-size: 1.25rem !important;
        font-weight: 700;
        color: #1e293b;
    }

    .fc-button-primary {
        background-color: #ffffff !important;
        color: #475569 !important;
        border: 1px solid #e2e8f0 !important;
        font-weight: 500;
    }

    .fc-button-primary:hover {
        background-color: #f8fafc !important;
        color: #1e293b !important;
    }

    .fc-button-active {
        background-color: #eff6ff !important;
        color: #2563eb !important;
        border-color: #bfdbfe !important;
    }

    .fc-event {
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 2px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: transform 0.1s;
    }

    .fc-event:hover {
        transform: scale(1.02);
        z-index: 5;
    }

    .fc-timegrid-event-harness-inset .fc-timegrid-event {
        box-shadow: none;
    }

    /* Striped Background for TimeGrid */
    .fc-timegrid-slot-minor {
        border-top-style: dotted !important;
    }

    .fc-timegrid-slot:nth-child(even) {
        background-color: #fcfcfc;
    }

    /* Hide scrollbars */
    .fc-scroller::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .fc-scroller::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
</style>

<!-- CREATE CLASS MODAL (Alpine.js) -->
<div x-data="{ 
    open: false, 
    type: 'single', 
    startStr: '', 
    endStr: '',
    formData: {
        activity: '',
        room: '',
        staff: '',
        days: [],
        end_date: ''
    },
    async submitForm() {
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const body = new FormData();
        
        body.append('type', this.type);
        body.append('activity', this.formData.activity);
        body.append('room', this.formData.room);
        body.append('staff', this.formData.staff);
        body.append('start_datetime', this.startStr); // Full ISO string
        
        // Recurring data
        if (this.type === 'recurring') {
            this.formData.days.forEach(d => body.append('days', d));
            body.append('end_date', this.formData.end_date);
        }
        
        try {
            const res = await fetch('{% url 'api_session_create' %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrf },
                body: body
            });
            const json = await res.json();
            
            if (res.ok) {
                this.open = false;
                // Refresh calendar
                window.calendar.refetchEvents();
                // Reset form (optional)
            } else {
                alert('Error: ' + json.error);
            }
        } catch(e) {
            console.error(e);
            alert('Error de conexión');
        }
    }
}" @open-create-modal.window="open = true; startStr = $event.detail.start; endStr = $event.detail.end"
    class="relative z-50">

    <!-- Backdrop -->
    <div x-show="open" x-transition.opacity class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm"></div>

    <!-- Modal Panel -->
    <div x-show="open" x-transition.scale class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full overflow-hidden" @click.away="open = false">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-bold text-slate-800">Nueva Clase / Sesión</h3>
                <button @click="open = false" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-6">
                <!-- Type Switcher -->
                <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                    <button @click="type = 'single'"
                        :class="{'bg-white shadow text-slate-800': type === 'single', 'text-slate-500': type !== 'single'}"
                        class="flex-1 py-2 text-sm font-bold rounded-lg transition-all">
                        Clase Suelta
                    </button>
                    <button @click="type = 'recurring'"
                        :class="{'bg-white shadow text-slate-800': type === 'recurring', 'text-slate-500': type !== 'recurring'}"
                        class="flex-1 py-2 text-sm font-bold rounded-lg transition-all">
                        Clase Recurrente
                    </button>
                </div>

                <form @submit.prevent="submitForm">
                    <!-- CSRF Token for FETCH -->
                    {% csrf_token %}

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Actividad</label>
                            <select x-model="formData.activity"
                                class="w-full rounded-xl border-slate-200 focus:border-blue-500 bg-slate-50/50"
                                required>
                                <option value="">Seleccionar Actividad...</option>
                                {% for activity in activities %}
                                <option value="{{ activity.id }}">{{ activity.name }} ({{ activity.duration }} min)
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Sala</label>
                                <select x-model="formData.room" class="w-full rounded-xl border-slate-200">
                                    <option value="">Sin sala</option>
                                    {% for room in rooms %}
                                    <option value="{{ room.id }}">{{ room.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Instructor</label>
                                <select x-model="formData.staff" class="w-full rounded-xl border-slate-200">
                                    <option value="">Sin instructor</option>
                                    {% for s in staff_list %}
                                    <option value="{{ s.id }}">{{ s.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Recurring Fields -->
                        <div x-show="type === 'recurring'" class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <label class="block text-xs font-bold text-blue-700 uppercase mb-2">Días de
                                repetición</label>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(day, index) in ['L','M','X','J','V','S','D']">
                                    <label
                                        class="inline-flex items-center gap-1 bg-white px-2 py-1 rounded border border-blue-200 text-xs cursor-pointer hover:bg-blue-50">
                                        <input type="checkbox" :value="index" x-model="formData.days"
                                            class="rounded text-blue-600 w-3 h-3">
                                        <span x-text="day"></span>
                                    </label>
                                </template>
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-bold text-blue-700 uppercase mb-1">Repetir
                                    hasta</label>
                                <input type="date" x-model="formData.end_date"
                                    class="w-full text-sm rounded-lg border-blue-200 focus:border-blue-500">
                            </div>
                        </div>

                        <!-- Info Display -->
                        <div class="text-xs text-slate-500 bg-slate-50 p-3 rounded-lg flex gap-2">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span
                                x-text="'Inicio: ' + (startStr ? new Date(startStr).toLocaleString() : 'Selecciona en calendario')"></span>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" @click="open = false"
                            class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg">Cancelar</button>
                        <button type="submit"
                            class="px-6 py-2 bg-slate-900 text-white font-bold rounded-lg hover:opacity-90 shadow-lg">Crear
                            Clase</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- UPDATE CONFIRMATION MODAL -->
<div x-data="{ open: false, event: null, newStart: null, newEnd: null, 
    confirm(mode) {
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch('{% url 'api_session_update' %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrf, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: this.event.id,
                start: this.newStart,
                end: this.newEnd,
                mode: mode
            })
        }).then(res => res.json().then(data => {
            if(res.ok) {
                this.open = false;
                window.calendar.refetchEvents(); 
            } else {
                alert('Error al actualizar: ' + (data.error || 'Desconocido'));
                this.event.revert(); 
                this.open = false;
            }
        })).catch(err => {
            alert('Error de conexión');
            this.event.revert();
            this.open = false;
        });
    },
    cancel() {
        if(this.event) this.event.revert();
        this.open = false;
    }
}" @open-update-modal.window="open = true; event = $event.detail.info.event; newStart = $event.detail.info.event.start.toISOString(); newEnd = $event.detail.info.event.end ? $event.detail.info.event.end.toISOString() : null;"
    class="relative z-50">

    <div x-show="open" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
    <div x-show="open" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 text-center" @click.away="cancel()">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Modificar Clase</h3>
            <p class="text-sm text-slate-500 mb-6">¿Cómo quieres aplicar este cambio de horario?</p>

            <div class="grid gap-3">
                <button @click="confirm('single')"
                    class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-xl transition-colors">
                    Solo esta clase
                </button>
                <button @click="confirm('future')"
                    class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-slate-900/20">
                    Esta y las siguientes
                </button>
                <button @click="cancel()" class="text-slate-400 font-medium text-sm mt-2 hover:text-slate-600">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT MODAL (Placeholder) -->
<div x-data="{ open: false, title: '' }" @open-edit-modal.window="open = true; title = $event.detail.title"
    class="relative z-50">
    <div x-show="open" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
    <div x-show="open" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6" @click.away="open = false">
            <h3 class="text-lg font-bold text-slate-800 mb-2" x-text="'Editar: ' + title"></h3>
            <p class="text-slate-500 text-sm mb-4">Aquí irán las opciones de asistencia, cancelación, etc.</p>
            <button @click="open = false"
                class="w-full bg-slate-100 py-2 rounded-lg font-bold text-slate-600">Cerrar</button>
        </div>
    </div>
</div>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var loadingEl = document.getElementById('loading');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'es',
            firstDay: 1,
            slotMinTime: '06:00:00',
            slotMaxTime: '23:00:00',
            allDaySlot: false,
            selectable: true,
            selectMirror: true,
            nowIndicator: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            events: {
                url: '{% url "api_calendar_events" %}',
                failure: function (err) {
                    console.error('Error fetching events:', err);
                    alert('Error cargando eventos. Revisa la consola o asegúrate de que el servidor está corriendo.');
                }
            },
            loading: function (isLoading) {
                if (isLoading) loadingEl.classList.remove('hidden');
                else loadingEl.classList.add('hidden');
            },

            // --- HANDLERS ---

            select: function (info) {
                window.dispatchEvent(new CustomEvent('open-create-modal', {
                    detail: { start: info.startStr, end: info.endStr }
                }));
            },

            eventClick: function (info) {
                // Open Edit Modal instead of Alert
                window.dispatchEvent(new CustomEvent('open-edit-modal', {
                    detail: { title: info.event.title, id: info.event.id }
                }));
            },

            eventDrop: function (info) {
                // Trigger Drag Confirmation Modal
                window.dispatchEvent(new CustomEvent('open-update-modal', {
                    detail: { info: info }
                }));
            },

            eventContent: function (arg) {
                let timeText = arg.timeText;
                let title = arg.event.title;
                let attendees = arg.event.extendedProps.attendees || 0;
                let max = arg.event.extendedProps.max_capacity || 0;
                let staff = arg.event.extendedProps.staff || '';

                let html = `
                    <div class="fc-content h-full flex flex-col justify-between p-1 relative">
                        <!-- Top: Time -->
                        <div class="text-[10px] uppercase tracking-wide opacity-90 font-semibold leading-tight">${timeText}</div>
                        
                        <!-- Center: Title -->
                        <div class="flex-1 flex flex-col items-center justify-center text-center leading-tight">
                            <div class="font-bold text-xs md:text-sm line-clamp-2">${title}</div>
                            <div class="text-[10px] opacity-80 truncate w-full px-1">${staff}</div>
                        </div>

                        <!-- Bottom Left: Capacity (Only for sessions) -->
                        ${arg.event.extendedProps.type === 'session' ?
                        `<div class="absolute bottom-1 left-1 flex items-center gap-0.5 text-[10px] bg-black/20 rounded px-1.5 py-0.5 backdrop-blur-sm">
                                <svg class="w-3 h-3 opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                <span class="font-bold">${attendees}/${max > 0 ? max : '∞'}</span>
                             </div>`
                        : ''}
                    </div>
                `;
                return { html: html };
            },
            editable: true
        });

        calendar.render();
        window.calendar = calendar;
    });

    function triggerNewClassModal() {
        window.dispatchEvent(new CustomEvent('open-create-modal', {
            detail: { start: new Date().toISOString(), end: '' }
        }));
    }
</script>
{% endblock %}