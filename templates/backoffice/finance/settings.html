{% extends "backoffice/base.html" %}

{% block title %}Finanzas - Configuración{% endblock %}
{% block breadcrumb %}
<a href="{% url 'settings_dashboard' %}" class="hover:underline">Configuración</a> > Finanzas
{% endblock %}
{% block page_title %}Configuración Financiera{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <p class="text-slate-500">Gestiona los impuestos, métodos de pago y pasarelas de tu centro</p>
    </div>

    <div x-data="{ tab: 'taxes' }">
        <!-- Tabs -->
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl w-fit mb-6">
            <button @click="tab = 'taxes'"
                :class="{'bg-white text-blue-600 shadow-sm': tab === 'taxes', 'text-slate-500 hover:text-slate-700': tab !== 'taxes'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                Impuestos
            </button>
            <button @click="tab = 'methods'"
                :class="{'bg-white text-blue-600 shadow-sm': tab === 'methods', 'text-slate-500 hover:text-slate-700': tab !== 'methods'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
            </button>
            <button @click="tab = 'config'"
                :class="{'bg-white text-blue-600 shadow-sm': tab === 'config', 'text-slate-500 hover:text-slate-700': tab !== 'config'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                Pasarelas de Pago
            </button>
        </div>

        <!-- Taxes Tab -->
        <div x-show="tab === 'taxes'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">Tipos Impositivos (IVA)</h3>
                <a href="{% url 'finance_tax_create' %}"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                    + Nuevo Impuesto
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Nombre</th>
                            <th class="px-6 py-4">Porcentaje</th>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for tax in tax_rates %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-medium text-slate-900">{{ tax.name }}</td>
                            <td class="px-6 py-4 text-slate-600">{{ tax.rate_percent }}%</td>
                            <td class="px-6 py-4">
                                {% if tax.is_active %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                                    Activo
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                    Inactivo
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <a href="{% url 'finance_tax_edit' tax.pk %}"
                                    class="text-blue-600 hover:text-blue-800 font-medium">Editar</a>
                                <form action="{% url 'finance_tax_delete' tax.pk %}" method="post" class="inline"
                                    onsubmit="return confirm('¿Seguro que deseas eliminar este impuesto?');">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-500 hover:text-red-700">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                No hay impuestos configurados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Methods Tab -->
        <div x-show="tab === 'methods'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden" style="display: none;">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">Métodos de Pago</h3>
                <a href="{% url 'finance_method_create' %}"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                    + Nuevo Método
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Nombre</th>
                            <th class="px-6 py-4">Control de Caja</th>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for pm in payment_methods %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-medium text-slate-900">{{ pm.name }}</td>
                            <td class="px-6 py-4">
                                {% if pm.is_cash %}
                                <span class="text-blue-600 font-medium">Sí (Efectivo)</span>
                                {% else %}
                                <span class="text-slate-400">No</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if pm.is_active %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                                    Activo
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                    Inactivo
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <a href="{% url 'finance_method_edit' pm.pk %}"
                                    class="text-blue-600 hover:text-blue-800 font-medium">Editar</a>
                                <form action="{% url 'finance_method_delete' pm.pk %}" method="post" class="inline"
                                    onsubmit="return confirm('¿Seguro que deseas eliminar este método?');">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-500 hover:text-red-700">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                No hay métodos de pago configurados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Configuration Tab (Stripe) -->
        <div x-show="tab === 'config'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden" style="display: none;">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-700">Configuración & Pasarelas</h3>
            </div>
            <div class="p-8">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="save_settings" value="1">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Stripe Section -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100"
                            x-data="{ editingStripe: {{ settings_form.stripe_secret_key.value|yesno:'false,true' }} }">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.16 0 9.613 0 7.559.664 6.132 1.943c-1.408 1.259-2.091 2.924-2.091 4.965 0 3.012 1.916 5.093 5.376 6.37 2.457.904 3.065 1.488 3.065 2.505 0 .972-.787 1.572-2.147 1.572-1.957 0-4.632-1.028-6.495-2.067l-.959 5.485c2.022.75 4.881 1.226 7.425 1.226 2.822 0 4.895-.824 6.22-2.225 1.25-1.328 1.838-3.033 1.838-4.992 0-3.321-2.147-5.467-5.399-6.632" />
                                    </svg>
                                </div>
                                <h4 class="font-bold text-indigo-900">Configuración Stripe</h4>

                                {% if settings_form.stripe_secret_key.value %}
                                <span
                                    class="ml-auto bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Vinculado
                                </span>
                                {% endif %}
                            </div>

                            <!-- Connected State -->
                            <div x-show="!editingStripe"
                                class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm text-center">
                                <div class="text-indigo-600 font-medium mb-2">Cuenta de Stripe Conectada</div>
                                <p class="text-xs text-slate-500 mb-4">Las claves están guardadas de forma segura.</p>
                                <button type="button" @click="editingStripe = true"
                                    class="text-sm text-slate-400 hover:text-indigo-600 underline">
                                    Cambiar configuración
                                </button>
                            </div>

                            <!-- Edit Form -->
                            <div x-show="editingStripe" class="space-y-4" x-transition>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Clave Pública
                                        (Publishable Key)</label>
                                    {{ settings_form.stripe_public_key }}
                                    <p class="text-xs text-slate-400 mt-1">Empieza por 'pk_'</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Clave Secreta (Secret
                                        Key)</label>
                                    {{ settings_form.stripe_secret_key }}
                                    <p class="text-xs text-slate-400 mt-1">Empieza por 'sk_'</p>
                                </div>
                                {% if settings_form.stripe_secret_key.value %}
                                <div class="text-right">
                                    <button type="button" @click="editingStripe = false"
                                        class="text-xs text-slate-400 hover:text-slate-600">Cancelar edición</button>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Redsys Section -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100"
                            x-data="{ editingRedsys: {{ settings_form.redsys_secret_key.value|yesno:'false,true' }} }">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-red-600 p-2 rounded-lg text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                                        </path>
                                    </svg>
                                </div>
                                <h4 class="font-bold text-red-900">Configuración Redsys</h4>

                                {% if settings_form.redsys_secret_key.value %}
                                <span
                                    class="ml-auto bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Vinculado
                                </span>
                                {% endif %}
                            </div>

                            <!-- Connected State -->
                            <div x-show="!editingRedsys"
                                class="bg-white p-4 rounded-xl border border-red-100 shadow-sm text-center">
                                <div class="text-red-700 font-medium mb-2">TPV Virtual Redsys Conectado</div>
                                <p class="text-xs text-slate-500 mb-4">Terminal {{
                                    settings_form.redsys_merchant_terminal.value }} Configurado</p>
                                <button type="button" @click="editingRedsys = true"
                                    class="text-sm text-slate-400 hover:text-red-600 underline">
                                    Cambiar configuración
                                </button>
                            </div>

                            <!-- Edit Form -->
                            <div x-show="editingRedsys" class="space-y-4" x-transition>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Código de Comercio
                                        (FUC)</label>
                                    {{ settings_form.redsys_merchant_code }}
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Terminal</label>
                                        {{ settings_form.redsys_merchant_terminal }}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Entorno</label>
                                        {{ settings_form.redsys_environment }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Clave Secreta
                                        (SHA-256)</label>
                                    {{ settings_form.redsys_secret_key }}
                                    <p class="text-xs text-slate-400 mt-1">Clave de encriptación del comercio</p>
                                </div>
                                {% if settings_form.redsys_secret_key.value %}
                                <div class="text-right">
                                    <button type="button" @click="editingRedsys = false"
                                        class="text-xs text-slate-400 hover:text-slate-600">Cancelar edición</button>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- General Finance -->
                        <div>
                            <h4 class="font-bold text-slate-800 mb-6">Moneda & General</h4>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Moneda Principal</label>
                                {{ settings_form.currency }}
                                <p class="text-xs text-slate-400 mt-1">Código ISO 4217 (ej: EUR, USD)</p>
                            </div>
                            <div class="mt-6 bg-white border border-slate-200 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-slate-800">App del Cliente</div>
                                        <p class="text-xs text-slate-500 mt-1">Gestiona permisos en Configuración → App del Cliente.</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-1 text-xs font-semibold">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full {% if settings_form.instance.allow_client_delete_card %}bg-emerald-100 text-emerald-700{% else %}bg-slate-100 text-slate-700{% endif %}">Eliminar tarjeta: {% if settings_form.instance.allow_client_delete_card %}Sí{% else %}No{% endif %}</span>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full {% if settings_form.instance.allow_client_pay_next_fee %}bg-emerald-100 text-emerald-700{% else %}bg-slate-100 text-slate-700{% endif %}">Pagar siguiente cuota: {% if settings_form.instance.allow_client_pay_next_fee %}Sí{% else %}No{% endif %}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                        <button type="submit"
                            class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-medium hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/10">
                            Guardar Configuración
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}