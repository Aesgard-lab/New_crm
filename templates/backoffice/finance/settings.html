{% extends "backoffice/base.html" %}

{% block title %}Finanzas - Configuraci√≥n{% endblock %}
{% block breadcrumb %}
<a href="{% url 'settings_dashboard' %}" class="hover:underline">Configuraci√≥n</a> > Finanzas
{% endblock %}
{% block page_title %}Configuraci√≥n Financiera{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <p class="text-slate-500">Gestiona los impuestos, m√©todos de pago y pasarelas de tu centro</p>
    </div>

    <div x-data="{ tab: 'taxes' }" x-cloak>
        <!-- Tabs -->
        <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl w-fit mb-6">
            <button @click="tab = 'taxes'"
                :class="{'bg-white text-[var(--brand-color)] shadow-sm': tab === 'taxes', 'text-slate-500 hover:text-slate-700': tab !== 'taxes'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                Impuestos
            </button>
            <button @click="tab = 'methods'"
                :class="{'bg-white text-[var(--brand-color)] shadow-sm': tab === 'methods', 'text-slate-500 hover:text-slate-700': tab !== 'methods'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                M√©todos de Pago
            </button>
            <button @click="tab = 'config'"
                :class="{'bg-white text-[var(--brand-color)] shadow-sm': tab === 'config', 'text-slate-500 hover:text-slate-700': tab !== 'config'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                Pasarelas de Pago
            </button>
            <a href="{% url 'wallet_settings' %}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-slate-700 hover:bg-white">
                üí∞ Monedero
            </a>
            {% if has_verifactu_module %}
            <button @click="tab = 'verifactu'"
                :class="{'bg-white text-[var(--brand-color)] shadow-sm': tab === 'verifactu', 'text-slate-500 hover:text-slate-700': tab !== 'verifactu'}"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                üá™üá∏ Verifactu
            </button>
            {% endif %}
        </div>

        <!-- Taxes Tab -->
        <div x-show="tab === 'taxes'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">Tipos Impositivos (IVA)</h3>
                <a href="{% url 'finance_tax_create' %}"
                    class="btn-brand px-4 py-2 text-sm">
                    + Nuevo Impuesto
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Nombre</th>
                            <th class="px-6 py-4">Porcentaje</th>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for tax in tax_rates %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-medium text-slate-900">{{ tax.name }}</td>
                            <td class="px-6 py-4 text-slate-600">{{ tax.rate_percent }}%</td>
                            <td class="px-6 py-4">
                                {% if tax.is_active %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                                    Activo
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                    Inactivo
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <a href="{% url 'finance_tax_edit' tax.pk %}"
                                    class="text-[var(--brand-color)] hover-brand font-medium">Editar</a>
                                <form action="{% url 'finance_tax_delete' tax.pk %}" method="post" class="inline"
                                    onsubmit="return confirm('¬øSeguro que deseas eliminar este impuesto?');">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-500 hover:text-red-700">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                No hay impuestos configurados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Methods Tab -->
        <div x-show="tab === 'methods'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">M√©todos de Pago</h3>
                <a href="{% url 'finance_method_create' %}"
                    class="btn-brand px-4 py-2 text-sm">
                    + Nuevo M√©todo
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Nombre</th>
                            <th class="px-6 py-4">Control de Caja</th>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for pm in payment_methods %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-medium text-slate-900">{{ pm.name }}</td>
                            <td class="px-6 py-4">
                                {% if pm.is_cash %}
                                <span class="text-[var(--brand-color)] font-medium">S√≠ (Efectivo)</span>
                                {% else %}
                                <span class="text-slate-400">No</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if pm.is_active %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                                    Activo
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                    Inactivo
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <a href="{% url 'finance_method_edit' pm.pk %}"
                                    class="text-[var(--brand-color)] hover-brand font-medium">Editar</a>
                                <form action="{% url 'finance_method_delete' pm.pk %}" method="post" class="inline"
                                    onsubmit="return confirm('¬øSeguro que deseas eliminar este m√©todo?');">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-500 hover:text-red-700">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                No hay m√©todos de pago configurados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Configuration Tab (Stripe) -->
        <div x-show="tab === 'config'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-700">Configuraci√≥n & Pasarelas</h3>
            </div>
            <div class="p-8">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="save_settings" value="1">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Stripe Section -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100"
                            x-data="{ editingStripe: {{ settings_form.stripe_secret_key.value|yesno:'false,true' }} }">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.16 0 9.613 0 7.559.664 6.132 1.943c-1.408 1.259-2.091 2.924-2.091 4.965 0 3.012 1.916 5.093 5.376 6.37 2.457.904 3.065 1.488 3.065 2.505 0 .972-.787 1.572-2.147 1.572-1.957 0-4.632-1.028-6.495-2.067l-.959 5.485c2.022.75 4.881 1.226 7.425 1.226 2.822 0 4.895-.824 6.22-2.225 1.25-1.328 1.838-3.033 1.838-4.992 0-3.321-2.147-5.467-5.399-6.632" />
                                    </svg>
                                </div>
                                <h4 class="font-bold text-indigo-900">Configuraci√≥n Stripe</h4>

                                {% if settings_form.stripe_secret_key.value %}
                                <span
                                    class="ml-auto bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Vinculado
                                </span>
                                {% endif %}
                            </div>

                            <!-- Connected State -->
                            <div x-show="!editingStripe"
                                class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm text-center">
                                <div class="text-indigo-600 font-medium mb-2">Cuenta de Stripe Conectada</div>
                                <p class="text-xs text-slate-500 mb-4">Las claves est√°n guardadas de forma segura.</p>
                                <button type="button" @click="editingStripe = true"
                                    class="text-sm text-slate-400 hover:text-indigo-600 underline">
                                    Cambiar configuraci√≥n
                                </button>
                            </div>

                            <!-- Edit Form -->
                            <div x-show="editingStripe" class="space-y-4" x-transition>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Clave P√∫blica
                                        (Publishable Key)</label>
                                    {{ settings_form.stripe_public_key }}
                                    <p class="text-xs text-slate-400 mt-1">Empieza por 'pk_'</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Clave Secreta (Secret
                                        Key)</label>
                                    {{ settings_form.stripe_secret_key }}
                                    <p class="text-xs text-slate-400 mt-1">Empieza por 'sk_'</p>
                                </div>
                                {% if settings_form.stripe_secret_key.value %}
                                <div class="text-right">
                                    <button type="button" @click="editingStripe = false"
                                        class="text-xs text-slate-400 hover:text-slate-600">Cancelar edici√≥n</button>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Redsys Section -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100"
                            x-data="{ editingRedsys: {{ settings_form.redsys_secret_key.value|yesno:'false,true' }} }">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-red-600 p-2 rounded-lg text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                                        </path>
                                    </svg>
                                </div>
                                <h4 class="font-bold text-red-900">Configuraci√≥n Redsys</h4>

                                {% if settings_form.redsys_secret_key.value %}
                                <span
                                    class="ml-auto bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Vinculado
                                </span>
                                {% endif %}
                            </div>

                            <!-- Connected State -->
                            <div x-show="!editingRedsys"
                                class="bg-white p-4 rounded-xl border border-red-100 shadow-sm text-center">
                                <div class="text-red-700 font-medium mb-2">TPV Virtual Redsys Conectado</div>
                                <p class="text-xs text-slate-500 mb-4">Terminal {{
                                    settings_form.redsys_merchant_terminal.value }} Configurado</p>
                                <button type="button" @click="editingRedsys = true"
                                    class="text-sm text-slate-400 hover:text-red-600 underline">
                                    Cambiar configuraci√≥n
                                </button>
                            </div>

                            <!-- Edit Form -->
                            <div x-show="editingRedsys" class="space-y-4" x-transition>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">C√≥digo de Comercio
                                        (FUC)</label>
                                    {{ settings_form.redsys_merchant_code }}
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Terminal</label>
                                        {{ settings_form.redsys_merchant_terminal }}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Entorno</label>
                                        {{ settings_form.redsys_environment }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Clave Secreta
                                        (SHA-256)</label>
                                    {{ settings_form.redsys_secret_key }}
                                    <p class="text-xs text-slate-400 mt-1">Clave de encriptaci√≥n del comercio</p>
                                </div>
                                {% if settings_form.redsys_secret_key.value %}
                                <div class="text-right">
                                    <button type="button" @click="editingRedsys = false"
                                        class="text-xs text-slate-400 hover:text-slate-600">Cancelar edici√≥n</button>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Stripe Migration Tool -->
                        <a href="{% url 'stripe_migration' %}" class="block bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-2xl border border-purple-200 hover:border-purple-300 hover:shadow-md transition-all">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-purple-600 p-2 rounded-lg text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-purple-900">Migraci√≥n desde Stripe</h4>
                                    <p class="text-xs text-purple-700">Importar clientes con tarjetas de otro software</p>
                                </div>
                            </div>
                            <p class="text-sm text-purple-800">
                                Si vienes de otro software que usa Stripe, puedes importar tus clientes con sus tarjetas tokenizadas.
                            </p>
                            <div class="mt-4 flex items-center gap-2 text-purple-600 text-sm font-medium">
                                <span>Ir a migraci√≥n</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </a>

                        <!-- General Finance -->
                        <div>
                            <h4 class="font-bold text-slate-800 mb-6">Moneda & General</h4>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Moneda Principal</label>
                                {{ settings_form.currency }}
                                <p class="text-xs text-slate-400 mt-1">C√≥digo ISO 4217 (ej: EUR, USD)</p>
                            </div>
                            <div class="mt-6 bg-white border border-slate-200 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-slate-800">App del Cliente</div>
                                        <p class="text-xs text-slate-500 mt-1">Gestiona permisos en Configuraci√≥n ‚Üí App del Cliente.</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-1 text-xs font-semibold">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full {% if settings_form.instance.allow_client_delete_card %}bg-emerald-100 text-emerald-700{% else %}bg-slate-100 text-slate-700{% endif %}">Eliminar tarjeta: {% if settings_form.instance.allow_client_delete_card %}S√≠{% else %}No{% endif %}</span>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full {% if settings_form.instance.allow_client_pay_next_fee %}bg-emerald-100 text-emerald-700{% else %}bg-slate-100 text-slate-700{% endif %}">Pagar siguiente cuota: {% if settings_form.instance.allow_client_pay_next_fee %}S√≠{% else %}No{% endif %}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto Charge Settings -->
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-2xl border border-amber-100">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-amber-500 p-2 rounded-lg text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-amber-900">Cobro Autom√°tico</h4>
                                    <p class="text-xs text-amber-700">Configuraci√≥n de reintentos y horario</p>
                                </div>
                            </div>
                            
                            <div class="space-y-5">
                                <!-- Enable Toggle -->
                                <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-amber-100">
                                    <div>
                                        <div class="text-sm font-medium text-slate-800">Habilitar cobro autom√°tico</div>
                                        <p class="text-xs text-slate-500">El sistema intentar√° cobrar autom√°ticamente las cuotas vencidas</p>
                                    </div>
                                    {{ settings_form.auto_charge_enabled }}
                                </div>
                                
                                <!-- Time Setting -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">
                                        <span class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Hora del cobro diario
                                        </span>
                                    </label>
                                    {{ settings_form.auto_charge_time }}
                                    <p class="text-xs text-slate-400 mt-1">Hora a la que se ejecutan los cobros autom√°ticos cada d√≠a</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Max Retries -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">
                                            <span class="flex items-center gap-2">
                                                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                </svg>
                                                M√°ximo de reintentos
                                            </span>
                                        </label>
                                        {{ settings_form.auto_charge_max_retries }}
                                        <p class="text-xs text-slate-400 mt-1">Intentos si falla el cobro</p>
                                    </div>
                                    
                                    <!-- Days Between Retries -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">
                                            <span class="flex items-center gap-2">
                                                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                D√≠as entre reintentos
                                            </span>
                                        </label>
                                        {{ settings_form.auto_charge_retry_days }}
                                        <p class="text-xs text-slate-400 mt-1">Esperar X d√≠as antes de reintentar</p>
                                    </div>
                                </div>
                                
                                <div class="bg-amber-100/50 rounded-lg p-3 text-xs text-amber-800">
                                    <strong>Ejemplo:</strong> Si un cobro falla, el sistema reintentar√° hasta {{ settings_form.instance.auto_charge_max_retries|default:3 }} veces, 
                                    esperando {{ settings_form.instance.auto_charge_retry_days|default:3 }} d√≠as entre cada intento.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                        <button type="submit"
                            class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-medium hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/10">
                            Guardar Configuraci√≥n
                        </button>
                    </div>
                </form>

                {% if is_franchise_owner and franchise_gyms %}
                <!-- Franchise Propagation Section -->
                <div class="mt-8 pt-8 border-t-2 border-dashed border-indigo-200" x-data="{ expanded: false }">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="propagate_settings" value="1">
                        
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 border border-indigo-200">
                            <div class="flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
                                <div class="flex items-center gap-4">
                                    <div class="bg-indigo-600 p-3 rounded-xl text-white">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-indigo-900 text-lg">üåê Propagar a Franquicia</h4>
                                        <p class="text-sm text-indigo-700">Sincroniza la configuraci√≥n financiera con otros gimnasios de tu red</p>
                                    </div>
                                    <span class="bg-indigo-200 text-indigo-800 px-3 py-1 rounded-full text-sm font-bold">
                                        {{ franchise_gyms|length }} gimnasio{{ franchise_gyms|length|pluralize:"s" }}
                                    </span>
                                </div>
                                <svg class="w-6 h-6 text-indigo-600 transition-transform" :class="{'rotate-180': expanded}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            
                            <div x-show="expanded" x-collapse class="mt-6 space-y-6">
                                <!-- What to propagate -->
                                <div class="bg-white rounded-xl p-5 border border-indigo-100">
                                    <h5 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        ¬øQu√© configuraci√≥n propagar?
                                    </h5>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <label class="flex items-center gap-3 p-3 bg-indigo-50 rounded-lg border border-indigo-100 hover:border-indigo-300 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_stripe" value="1" checked
                                                class="rounded text-indigo-600 focus:ring-indigo-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">Stripe</span>
                                                <p class="text-xs text-slate-500">Claves API</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-red-50 rounded-lg border border-red-100 hover:border-red-300 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_redsys" value="1" checked
                                                class="rounded text-red-600 focus:ring-red-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">Redsys</span>
                                                <p class="text-xs text-slate-500">TPV Virtual</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-amber-50 rounded-lg border border-amber-100 hover:border-amber-300 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_auto_charge" value="1" checked
                                                class="rounded text-amber-600 focus:ring-amber-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">Cobro Autom√°tico</span>
                                                <p class="text-xs text-slate-500">Horario y reintentos</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-emerald-50 rounded-lg border border-emerald-100 hover:border-emerald-300 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_currency" value="1" checked
                                                class="rounded text-emerald-600 focus:ring-emerald-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">Moneda</span>
                                                <p class="text-xs text-slate-500">{{ settings_form.instance.currency|default:"EUR" }}</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg border border-purple-100 hover:border-purple-300 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_gateway_strategy" value="1" checked
                                                class="rounded text-purple-600 focus:ring-purple-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">Estrategia Pasarela</span>
                                                <p class="text-xs text-slate-500">App y POS</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-cyan-50 rounded-lg border border-cyan-100 hover:border-cyan-300 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_app_permissions" value="1"
                                                class="rounded text-cyan-600 focus:ring-cyan-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">Permisos App</span>
                                                <p class="text-xs text-slate-500">Eliminar tarjeta, pagar cuota</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200 hover:border-slate-400 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_payment_methods" value="1"
                                                class="rounded text-slate-600 focus:ring-slate-500 h-5 w-5">
                                            <div>
                                                <span class="font-medium text-slate-800">M√©todos de Pago</span>
                                                <p class="text-xs text-slate-500">Efectivo, tarjeta, etc.</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Target gyms -->
                                <div class="bg-white rounded-xl p-5 border border-indigo-100">
                                    <div class="flex items-center justify-between mb-4">
                                        <h5 class="font-bold text-slate-800 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                            Gimnasios destino
                                        </h5>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="document.querySelectorAll('input[name=propagate_to_gyms]').forEach(c => c.checked = true)"
                                                class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg hover:bg-indigo-200 transition-colors">
                                                Seleccionar todos
                                            </button>
                                            <button type="button" onclick="document.querySelectorAll('input[name=propagate_to_gyms]').forEach(c => c.checked = false)"
                                                class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-lg hover:bg-slate-200 transition-colors">
                                                Ninguno
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {% for fgym in franchise_gyms %}
                                        <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 cursor-pointer transition-colors">
                                            <input type="checkbox" name="propagate_to_gyms" value="{{ fgym.id }}"
                                                class="rounded text-indigo-600 focus:ring-indigo-500 h-5 w-5">
                                            <div class="flex-1 min-w-0">
                                                <span class="font-medium text-slate-800 block truncate">{{ fgym.commercial_name|default:fgym.name }}</span>
                                                <span class="text-xs text-slate-500">{{ fgym.city|default:"Sin ciudad" }}</span>
                                            </div>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Warning -->
                                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3">
                                    <svg class="w-6 h-6 text-amber-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-medium text-amber-800">‚ö†Ô∏è Esta acci√≥n sobrescribir√° la configuraci√≥n</p>
                                        <p class="text-sm text-amber-700 mt-1">La configuraci√≥n actual de los gimnasios seleccionados ser√° reemplazada. Aseg√∫rate de que las claves de Stripe/Redsys son correctas.</p>
                                    </div>
                                </div>
                                
                                <!-- Submit button -->
                                <div class="flex justify-end">
                                    <button type="submit"
                                        class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-medium hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-600/20 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        Propagar Configuraci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        {% if has_verifactu_module %}
        <!-- Verifactu Tab -->
        <div x-show="tab === 'verifactu'" x-transition
            class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-700">üá™üá∏ Verifactu - Sistema de Verificaci√≥n de Facturas AEAT</h3>
            </div>
            <div class="p-8">
                <div class="max-w-2xl mx-auto text-center">
                    <div class="bg-gradient-to-br from-red-50 to-amber-50 rounded-2xl p-8 border border-red-100 mb-6">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h4 class="text-xl font-bold text-slate-800 mb-2">Cumplimiento RD 1007/2023</h4>
                        <p class="text-slate-600 mb-4">
                            Verifactu es el sistema de la Agencia Tributaria para verificar la integridad de las facturas mediante hash SHA-256 encadenado y c√≥digo QR.
                        </p>
                        <div class="flex flex-wrap gap-3 justify-center text-sm">
                            <span class="bg-white px-3 py-1 rounded-full border border-slate-200">
                                üîó Hash encadenado
                            </span>
                            <span class="bg-white px-3 py-1 rounded-full border border-slate-200">
                                üì± C√≥digo QR verificable
                            </span>
                            <span class="bg-white px-3 py-1 rounded-full border border-slate-200">
                                üîí Firma electr√≥nica
                            </span>
                        </div>
                    </div>
                    
                    <a href="{% url 'verifactu_settings' %}" 
                       class="inline-flex items-center gap-2 bg-red-600 text-white px-6 py-3 rounded-xl font-medium hover:bg-red-700 transition-colors shadow-lg shadow-red-600/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Configurar Verifactu
                    </a>
                    
                    <p class="text-xs text-slate-400 mt-4">
                        ‚ö†Ô∏è Atenci√≥n: Una vez activado Verifactu, no se puede desactivar.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}