{% extends "backoffice/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ routine.name }} - {% trans "Constructor" %}{% endblock %}
{% block breadcrumb %}
<a href="{% url 'routine_list' %}" class="hover:underline">{% trans "Rutinas" %}</a> › {{ routine.name }}
{% endblock %}

{% block content %}
<div class="h-[calc(100vh-120px)] flex flex-col" x-data="routineBuilder()">

    <!-- Header Minimalista -->
    <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
        <div class="flex items-center gap-4">
            <div>
                <h1 class="text-xl font-bold text-slate-900">{{ routine.name }}</h1>
                <div class="flex gap-2 mt-1">
                    <span class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">{{ routine.get_goal_display }}</span>
                    <span class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">{{ routine.get_difficulty_display }}</span>
                </div>
            </div>
        </div>
        <div class="flex gap-3">
            <button @click="addDay()"
                class="text-slate-600 hover:text-slate-900 px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 font-medium transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                {% trans "Añadir Día" %}
            </button>
            <a href="{% url 'routine_list' %}" class="btn-brand px-5 py-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                {% trans "Guardar" %}
            </a>
        </div>
    </div>

    <!-- Main Content: 2 Columnas -->
    <div class="flex-1 flex gap-6 overflow-hidden">

        <!-- Columna Principal: Días -->
        <div class="flex-1 overflow-y-auto pr-2 space-y-4" id="days-container">
            {% for day in routine.days.all %}
            <div class="day-card bg-white rounded-xl border border-slate-200 overflow-hidden" data-day-id="{{ day.id }}"
                :class="{'ring-2 ring-[var(--brand-color)] ring-offset-2': activeDay === {{ day.id }}}">

                <!-- Day Header -->
                <div class="flex justify-between items-center px-4 py-3 bg-slate-50 border-b border-slate-100 cursor-pointer"
                    @click="activeDay = {{ day.id }}">
                    <div class="flex items-center gap-3">
                        <span class="w-7 h-7 rounded-lg bg-[var(--brand-color)] text-white text-xs font-bold flex items-center justify-center">{{ forloop.counter }}</span>
                        <div x-data="{ editing: false, name: '{{ day.name|escapejs }}' }">
                            <template x-if="!editing">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-slate-800" x-text="name"></span>
                                    <button @click.stop="editing = true; $nextTick(() => $refs.inp.focus())"
                                        class="text-slate-400 hover:text-slate-600">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <template x-if="editing">
                                <input x-ref="inp" x-model="name" type="text"
                                    class="text-sm font-semibold border border-slate-300 rounded px-2 py-1 w-40 focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)]"
                                    @blur="updateDayName({{ day.id }}, name); editing = false"
                                    @keydown.enter="updateDayName({{ day.id }}, name); editing = false" @click.stop>
                            </template>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-slate-400 mr-2">{{ day.exercises.count }} {% trans "ejercicios" %}</span>
                        <button @click.stop="duplicateDay({{ day.id }})"
                            class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"
                            title="Duplicar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                </path>
                            </svg>
                        </button>
                        <button @click.stop="deleteDay({{ day.id }})"
                            class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"
                            title="Eliminar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Exercises List -->
                <div class="exercises-list p-3 space-y-2 min-h-[60px]" id="day-{{ day.id }}">
                    {% for rx in day.exercises.all %}
                    <div class="exercise-item group rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-200 transition-all overflow-hidden"
                        data-rx-id="{{ rx.id }}">
                        <!-- Video Thumbnail -->
                        {% if rx.exercise.video_url %}
                        <div class="relative max-w-[10rem] mx-auto my-2">
                            {% if 'youtube' in rx.exercise.video_url or 'youtu.be' in rx.exercise.video_url %}
                            <div class="relative aspect-video bg-slate-900 rounded-lg overflow-hidden shadow-md">
                                <img :src="getYoutubeThumbnail('{{ rx.exercise.video_url }}')"
                                     class="w-full h-full object-cover"
                                     alt="{{ rx.exercise.name }}">
                                <!-- Play overlay -->
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <div class="w-6 h-6 bg-red-600 rounded-full flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="flex items-center gap-3 px-3 py-2">
                            <!-- Drag Handle -->
                            <div class="handle cursor-grab text-slate-300 hover:text-slate-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 8h16M4 16h16"></path>
                                </svg>
                            </div>

                            <!-- Exercise Name -->
                            <button
                                @click="openExerciseModal({{ rx.exercise.id }}, '{{ rx.exercise.name|escapejs }}', '{{ rx.exercise.video_url }}', '{{ rx.exercise.description|escapejs }}')"
                                class="flex-1 text-left font-medium text-slate-700 hover:text-[var(--brand-color)] truncate">
                                {{ rx.exercise.name }}
                            </button>

                        <!-- Params Inline -->
                        <div class="flex items-center gap-2 text-sm"
                            x-data="{ sets: '{{ rx.sets }}', reps: '{{ rx.reps }}', rest: '{{ rx.rest }}' }">
                            <input type="text" x-model="sets" @change="updateExerciseParam({{ rx.id }}, 'sets', sets)"
                                class="w-10 text-center text-slate-600 bg-slate-100 rounded px-1 py-0.5 text-xs font-medium focus:outline-none focus:ring-1 focus:ring-[var(--brand-color)]"
                                title="Series">
                            <span class="text-slate-400">×</span>
                            <input type="text" x-model="reps" @change="updateExerciseParam({{ rx.id }}, 'reps', reps)"
                                class="w-14 text-center text-slate-600 bg-slate-100 rounded px-1 py-0.5 text-xs font-medium focus:outline-none focus:ring-1 focus:ring-[var(--brand-color)]"
                                title="Repeticiones">
                            <input type="text" x-model="rest" @change="updateExerciseParam({{ rx.id }}, 'rest', rest)"
                                class="w-12 text-center text-slate-500 bg-slate-50 rounded px-1 py-0.5 text-xs focus:outline-none focus:ring-1 focus:ring-[var(--brand-color)]"
                                title="Descanso" placeholder="60s">
                        </div>

                            <!-- Actions -->
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="duplicateExercise({{ rx.id }})"
                                    class="p-1 text-slate-400 hover:text-slate-600" title="Duplicar">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                </button>
                                <button @click="deleteExercise({{ rx.id }}, $el.closest('.exercise-item'))"
                                    class="p-1 text-slate-400 hover:text-red-500" title="Eliminar">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-6 text-slate-400 text-sm empty-state">
                        <p>{% trans "Arrastra ejercicios aquí o usa el botón +" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-16 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
                <svg class="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                <p class="text-slate-500 font-medium">{% trans "No hay días creados" %}</p>
                <p class="text-sm text-slate-400 mb-4">{% trans "Haz clic en 'Añadir Día' para empezar" %}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Sidebar: Biblioteca de Ejercicios -->
        <div class="w-72 bg-white rounded-xl border border-slate-200 flex flex-col overflow-hidden shrink-0">
            <!-- Header -->
            <div class="p-4 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800 mb-3">{% trans "Ejercicios" %}</h3>
                <div class="relative">
                    <svg class="w-4 h-4 absolute left-3 top-2.5 text-slate-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" x-model="search" placeholder="{% trans 'Buscar...' %}"
                        class="w-full pl-9 pr-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent">
                </div>
            </div>

            <!-- Muscle Filters -->
            <div class="px-4 py-2 border-b border-slate-100 flex flex-wrap gap-1">
                <button @click="filterGroup = ''"
                    :class="filterGroup === '' ? 'bg-[var(--brand-color)] text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                    class="px-2 py-0.5 text-[10px] font-medium rounded-full transition-colors">{% trans "Todos" %}</button>
                {% for key, label in muscle_groups %}
                <button @click="filterGroup = '{{ key }}'"
                    :class="filterGroup === '{{ key }}' ? 'bg-[var(--brand-color)] text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                    class="px-2 py-0.5 text-[10px] font-medium rounded-full transition-colors">{{ label }}</button>
                {% endfor %}
            </div>

            <!-- Exercise List -->
            <div class="flex-1 overflow-y-auto" id="library-list">
                {% for exercise in exercises %}
                <div class="exercise-lib-item group relative border-b border-slate-50 hover:bg-slate-50 transition-colors cursor-pointer"
                    data-id="{{ exercise.id }}" data-name="{{ exercise.name }}"
                    data-muscle="{{ exercise.muscle_group }}" data-video="{{ exercise.video_url|default:'' }}"
                    x-show="shouldShow('{{ exercise.name|lower|escapejs }}', '{{ exercise.muscle_group }}')">

                    <!-- Video Preview Thumbnail (always visible, 30% smaller) -->
                    {% if exercise.video_url %}
                    <div class="mx-2 mt-1.5 mb-1.5 relative z-10 shadow-sm rounded overflow-hidden">
                        {% if 'youtube' in exercise.video_url or 'youtu.be' in exercise.video_url %}
                            {% comment %} Mostrar thumbnail de YouTube {% endcomment %}
                            <div class="relative aspect-video bg-slate-900">
                                <img :src="getYoutubeThumbnail('{{ exercise.video_url }}')" 
                                     class="w-full h-full object-cover"
                                     alt="{{ exercise.name }}">
                                <!-- Play overlay -->
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
                                    <div class="w-6 h-6 bg-red-600 rounded-full flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="aspect-video bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                                </svg>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Exercise Info Row -->
                    <div class="flex items-center justify-between px-3 py-2"
                        @click="openExerciseModal({{ exercise.id }}, '{{ exercise.name|escapejs }}', '{{ exercise.video_url }}', '{{ exercise.description|escapejs }}')">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            {% if exercise.video_url %}
                            <div class="w-4 h-4 rounded bg-slate-100 flex items-center justify-center shrink-0">
                                <svg class="w-2.5 h-2.5 text-slate-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"></path>
                                </svg>
                            </div>
                            {% endif %}
                            <div class="min-w-0">
                                <p class="text-xs font-medium text-slate-700 truncate">{{ exercise.name }}</p>
                                <p class="text-[9px] text-slate-400">{{ exercise.get_muscle_group_display }}</p>
                            </div>
                        </div>
                        <button @click.stop="quickAddExercise({{ exercise.id }})"
                            class="shrink-0 w-6 h-6 flex items-center justify-center text-slate-400 hover:text-white hover:bg-[var(--brand-color)] rounded-lg transition-all"
                            title="Añadir al día activo">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Modal: Detalle de Ejercicio -->
    <div x-show="exerciseModal.open" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50" @click="exerciseModal.open = false"></div>

        <!-- Modal Content -->
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden"
            x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100">

            <!-- Header -->
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-900" x-text="exerciseModal.name"></h3>
                <button @click="exerciseModal.open = false" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Video -->
            <template x-if="exerciseModal.videoUrl">
                <div class="aspect-video bg-black">
                    <iframe :src="getEmbedUrl(exerciseModal.videoUrl)" class="w-full h-full" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>
            </template>
            <template x-if="!exerciseModal.videoUrl">
                <div class="aspect-video bg-slate-100 flex items-center justify-center">
                    <div class="text-center text-slate-400">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                        <p class="text-sm">{% trans "Sin video disponible" %}</p>
                    </div>
                </div>
            </template>

            <!-- Description & Actions -->
            <div class="p-6">
                <template x-if="exerciseModal.description">
                    <p class="text-sm text-slate-600 mb-4 whitespace-pre-line" x-text="exerciseModal.description"></p>
                </template>
                <button @click="quickAddExercise(exerciseModal.id); exerciseModal.open = false"
                    class="btn-brand w-full py-2.5 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    {% trans "Añadir al Día Activo" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    function routineBuilder() {
        return {
            search: '',
            filterGroup: '',
            activeDay: {% if routine.days.first %}{{ routine.days.first.id }}{% else %}null{% endif %},
            exerciseModal: { open: false, id: null, name: '', videoUrl: '', description: '' },
            csrfToken: '{{ csrf_token }}',
            routineId: {{ routine.id }},

        init() {
            this.initSortables();
        },

        shouldShow(name, muscleGroup) {
            const matchesSearch = name.includes(this.search.toLowerCase());
            const matchesGroup = this.filterGroup === '' || muscleGroup === this.filterGroup;
            return matchesSearch && matchesGroup;
        },

        openExerciseModal(id, name, videoUrl, description) {
            this.exerciseModal = { open: true, id, name, videoUrl, description };
        },

        initSortables() {
            // Library drag source
            new Sortable(document.getElementById('library-list'), {
                group: { name: 'exercises', pull: 'clone', put: false },
                sort: false,
                animation: 150,
                ghostClass: 'opacity-30'
            });

            // Day drop targets
            document.querySelectorAll('.exercises-list').forEach(el => {
                new Sortable(el, {
                    group: 'exercises',
                    animation: 150,
                    handle: '.handle',
                    ghostClass: 'opacity-30',
                    onAdd: (evt) => {
                        const dayId = evt.to.id.replace('day-', '');
                        const exerciseId = evt.item.dataset.id;
                        evt.item.remove();
                        this.addExerciseToDay(dayId, exerciseId);
                    },
                    onUpdate: (evt) => {
                        const dayId = evt.to.id.replace('day-', '');
                        this.updateOrder(dayId, evt.to);
                    }
                });
            });
        },

        async quickAddExercise(exerciseId) {
            if (!this.activeDay) {
                alert('Selecciona un día primero');
                return;
            }
            await this.addExerciseToDay(this.activeDay, exerciseId);
        },

        async addExerciseToDay(dayId, exerciseId) {
            try {
                const res = await fetch(`/routines/api/routines/${this.routineId}/add-exercise/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ day_id: dayId, exercise_id: exerciseId })
                });
                if (res.ok) location.reload();
            } catch (e) { console.error(e); }
        },

        async updateOrder(dayId, container) {
            const ids = [...container.querySelectorAll('[data-rx-id]')].map(el => el.dataset.rxId);
            try {
                await fetch(`/routines/api/routines/${this.routineId}/update-order/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ day_id: dayId, ordered_ids: ids })
                });
            } catch (e) { console.error(e); }
        },

        async updateExerciseParam(rxId, field, value) {
            try {
                await fetch(`/routines/api/exercises/${rxId}/update/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
            } catch (e) { console.error(e); }
        },

        async updateDayName(dayId, name) {
            try {
                await fetch(`/routines/api/days/${dayId}/update-name/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
            } catch (e) { console.error(e); }
        },

        async deleteExercise(rxId, el) {
            if (!confirm('¿Eliminar este ejercicio?')) return;
            try {
                await fetch(`/routines/api/exercises/${rxId}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                el.style.opacity = '0';
                el.style.transform = 'translateX(-10px)';
                setTimeout(() => el.remove(), 150);
            } catch (e) { console.error(e); }
        },

        async duplicateExercise(rxId) {
            try {
                await fetch(`/routines/api/exercises/${rxId}/duplicate/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                location.reload();
            } catch (e) { console.error(e); }
        },

        async addDay() {
            try {
                await fetch(`/routines/api/routines/${this.routineId}/add-day/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                location.reload();
            } catch (e) { console.error(e); }
        },

        async deleteDay(dayId) {
            if (!confirm('¿Eliminar este día y todos sus ejercicios?')) return;
            try {
                await fetch(`/routines/api/days/${dayId}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                location.reload();
            } catch (e) { console.error(e); }
        },

        async duplicateDay(dayId) {
            try {
                await fetch(`/routines/api/days/${dayId}/duplicate/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                location.reload();
            } catch (e) { console.error(e); }
        },

        getEmbedUrl(url) {
            if (!url) return '';
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                const watchMatch = url.match(/[?&]v=([^&]+)/);
                if (watchMatch) videoId = watchMatch[1];
                else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
                else if (url.includes('/embed/')) videoId = url.split('/embed/')[1].split('?')[0];
                if (videoId) return `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&loop=1&playlist=${videoId}`;
            }
            if (url.includes('vimeo')) {
                const match = url.match(/vimeo\.com\/(\d+)/);
                if (match) return `https://player.vimeo.com/video/${match[1]}?loop=1`;
            }
            return url;
        },

        getPreviewUrl(url) {
            if (!url) return '';
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                const watchMatch = url.match(/[?&]v=([^&]+)/);
                if (watchMatch) videoId = watchMatch[1];
                else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
                else if (url.includes('/embed/')) videoId = url.split('/embed/')[1].split('?')[0];
                if (videoId) return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&controls=0&modestbranding=1&playlist=${videoId}`;
            }
            if (url.includes('vimeo')) {
                const match = url.match(/vimeo\.com\/(\d+)/);
                if (match) return `https://player.vimeo.com/video/${match[1]}?autoplay=1&muted=1&loop=1&background=1`;
            }
            return url;
        },

        getYoutubeThumbnail(url) {
            if (!url) return '';
            let videoId = '';
            
            // Extraer video ID de diferentes formatos de URL de YouTube
            const watchMatch = url.match(/[?&]v=([^&]+)/);
            if (watchMatch) {
                videoId = watchMatch[1];
            } else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            } else if (url.includes('/embed/')) {
                videoId = url.split('/embed/')[1].split('?')[0];
            }
            
            if (videoId) {
                // Usar thumbnail de alta calidad
                return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            }
            
            return '';
        }
    }
}
</script>

<style>
    [x-cloak] {
        display: none !important;
    }

    .exercise-item {
        transition: all 0.15s ease;
    }
</style>
{% endblock %}