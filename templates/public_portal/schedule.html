{% extends 'public_portal/base.html' %}

{% block title %}{{ t.class_schedule }} - {{ gym.commercial_name|default:gym.name }}{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .fc-event {
        cursor: pointer;
    }
    .fc-event-main {
        padding: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">{{ t.class_schedule }}</h1>
    <p class="text-slate-600">{{ t.check_classes_availability }}</p>
    
    {% if can_book %}
        {% if requires_login and not user.is_authenticated %}
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl text-sm">
            <strong>üí° Tip:</strong> <a href="{% url 'public_login' slug=settings.public_slug %}?next={% url 'public_schedule' slug=settings.public_slug %}" class="brand-text font-bold hover:underline">{{ t.login_to_book }}</a>
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- Filtros de Actividades -->
{% if activities %}
<div class="mb-6 flex flex-wrap gap-2">
    <span class="text-sm font-medium text-slate-700">{{ t.filter_by_activity }}:</span>
    {% for activity in activities %}
    <button onclick="filterByActivity('{{ activity.id }}')" 
            class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 hover:border-slate-400 transition-colors"
            style="background-color: {{ activity.color }}20; color: {{ activity.color }};">
        {{ activity.name }}
    </button>
    {% endfor %}
    <button onclick="filterByActivity(null)" 
            class="text-xs px-3 py-1.5 rounded-lg border border-slate-300 bg-slate-100 hover:bg-slate-200 transition-colors">
        {{ t.view_all }}
    </button>
</div>
{% endif %}

<!-- Calendario -->
<div id="calendar" class="bg-white rounded-2xl shadow-lg border border-slate-100 p-4"></div>

<!-- Modal de Detalle de Clase -->
<div id="sessionModal" style="display:none;" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 id="modalTitle" class="text-xl font-bold text-slate-900"></h3>
                <p id="modalTime" class="text-sm text-slate-600"></p>
            </div>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="space-y-3">
            <div id="modalStaff" class="flex items-center gap-2 text-sm">
                <span class="font-medium">üë§ {{ t.instructor }}:</span>
                <span id="modalStaffName"></span>
            </div>
            
            <div id="modalRoom" class="flex items-center gap-2 text-sm">
                <span class="font-medium">üìç {{ t.room }}:</span>
                <span id="modalRoomName"></span>
            </div>
            
            <div class="flex items-center gap-2 text-sm">
                <span class="font-medium">üë• {{ t.availability }}:</span>
                <span id="modalCapacity"></span>
            </div>
            
            <div id="modalAvailability" class="mt-4"></div>
        </div>
        
        {% if can_book and user.is_authenticated %}
        <div class="mt-6">
            <button onclick="bookClass()" 
                    class="w-full brand-bg text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity">
                {{ t.book_spot }}
            </button>
        </div>
        {% elif can_book and not user.is_authenticated %}
        <div class="mt-6">
            <a href="{% url 'public_login' slug=settings.public_slug %}?next={% url 'public_schedule' slug=settings.public_slug %}" 
               class="block w-full brand-bg text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity text-center">
                {{ t.login_to_book_btn }}
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    let calendar;
    let currentFilter = null;
    let currentSessionId = null;
    
    // Translation strings
    const t = {
        spots_occupied: '{{ t.spots_occupied }}',
        class_full: '{{ t.class_full }}',
        spots_available: '{{ t.spots_available }}',
        booking_in_progress: '{{ t.booking_in_progress }}',
        booking_error: '{{ t.booking_error }}',
        could_not_complete: '{{ t.could_not_complete }}'
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const locale = '{{ current_language|default:"es" }}';
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: locale,
            firstDay: 1,
            slotMinTime: '06:00:00',
            slotMaxTime: '23:00:00',
            allDaySlot: false,
            nowIndicator: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            events: {
                url: '{% url "api_public_schedule_events" slug=settings.public_slug %}',
                failure: function(err) {
                    console.error('Error loading events:', err);
                }
            },
            eventClick: function(info) {
                showSessionDetail(info.event);
            }
        });
        
        calendar.render();
    });
    
    function filterByActivity(activityId) {
        currentFilter = activityId;
        calendar.refetchEvents();
        
        // Actualizar query params
        const url = new URL(window.location);
        if (activityId) {
            url.searchParams.set('activity', activityId);
        } else {
            url.searchParams.delete('activity');
        }
        window.history.replaceState({}, '', url);
    }
    
    function showSessionDetail(event) {
        const props = event.extendedProps;
        const locale = '{{ current_language|default:"es" }}';
        const localeMap = {'es': 'es-ES', 'en': 'en-US'};
        
        document.getElementById('modalTitle').textContent = event.title;
        document.getElementById('modalTime').textContent = event.start.toLocaleString(localeMap[locale] || 'es-ES', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Staff
        if (props.staff) {
            document.getElementById('modalStaffName').textContent = props.staff;
            document.getElementById('modalStaff').style.display = 'flex';
        } else {
            document.getElementById('modalStaff').style.display = 'none';
        }
        
        // Room
        if (props.room) {
            document.getElementById('modalRoomName').textContent = props.room;
            document.getElementById('modalRoom').style.display = 'flex';
        } else {
            document.getElementById('modalRoom').style.display = 'none';
        }
        
        // Capacity
        document.getElementById('modalCapacity').textContent = 
            `${props.attendees}/${props.max_capacity} ${t.spots_occupied}`;
        
        // Availability
        const availDiv = document.getElementById('modalAvailability');
        if (props.is_full) {
            availDiv.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800"><strong>‚ùå ${t.class_full}</strong></div>`;
        } else {
            availDiv.innerHTML = `<div class="p-3 bg-green-50 border border-green-200 rounded-xl text-sm text-green-800"><strong>‚úÖ ${props.spots_available} ${t.spots_available}</strong></div>`;
        }
        
        currentSessionId = event.id.replace('sess_', '');
        document.getElementById('sessionModal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('sessionModal').style.display = 'none';
    }
    
    function bookClass() {
        {% if user.is_authenticated %}
        const button = document.querySelector('.brand-bg[onclick="bookClass()"]');
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '‚è≥ ' + t.booking_in_progress;
        
        fetch('{% url "api_book_session" slug=settings.public_slug %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: currentSessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.message);
                closeModal();
                calendar.refetchEvents();
            } else {
                alert('‚ùå ' + (data.error || t.could_not_complete));
                button.disabled = false;
                button.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(t.booking_error);
            button.disabled = false;
            button.textContent = originalText;
        });
        {% else %}
        window.location.href = '{% url "public_login" slug=settings.public_slug %}?next={% url "public_schedule" slug=settings.public_slug %}';
        {% endif %}
    }
    
    // Cerrar modal al hacer clic fuera
    document.getElementById('sessionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}