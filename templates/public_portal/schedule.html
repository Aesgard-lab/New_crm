{% extends 'public_portal/base.html' %}

{% block title %}{{ t.class_schedule }} - {{ gym.commercial_name|default:gym.name }}{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .fc-event {
        cursor: pointer;
    }
    .fc-event-main {
        padding: 4px;
    }
    .claim-timer {
        animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">{{ t.class_schedule }}</h1>
    <p class="text-slate-600">{{ t.check_classes_availability }}</p>
    
    {% if can_book %}
        {% if requires_login and not user.is_authenticated %}
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl text-sm">
            <strong>üí° Tip:</strong> <a href="{% url 'public_login' slug=settings.public_slug %}?next={% url 'public_schedule' slug=settings.public_slug %}" class="brand-text font-bold hover:underline">{{ t.login_to_book }}</a>
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- Banner de Plaza Disponible para Reclamar -->
{% if user.is_authenticated %}
<div id="waitlistClaimBanner" style="display:none;" 
     class="mb-6 p-4 bg-amber-50 border-2 border-amber-400 rounded-xl animate-pulse">
    <div class="flex items-start gap-3">
        <div class="text-2xl">üéâ</div>
        <div class="flex-1">
            <h3 class="font-bold text-amber-800">¬°Hay una plaza disponible para ti!</h3>
            <p id="claimActivityName" class="text-sm text-amber-700 mt-1"></p>
            <p class="text-xs text-amber-600 mt-2 claim-timer">‚è±Ô∏è Tiempo restante: <span id="claimTimeRemaining"></span></p>
        </div>
        <button onclick="claimWaitlistSpot()" 
                class="px-4 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600 transition-colors whitespace-nowrap">
            ¬°Reclamar Plaza!
        </button>
    </div>
</div>
{% endif %}

<!-- Filtros de Actividades -->
{% if activities %}
<div class="mb-6 flex flex-wrap gap-2">
    <span class="text-sm font-medium text-slate-700">{{ t.filter_by_activity }}:</span>
    {% for activity in activities %}
    <button onclick="filterByActivity('{{ activity.id }}')" 
            class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 hover:border-slate-400 transition-colors"
            style="background-color: {{ activity.color }}20; color: {{ activity.color }};">
        {{ activity.name }}
    </button>
    {% endfor %}
    <button onclick="filterByActivity(null)" 
            class="text-xs px-3 py-1.5 rounded-lg border border-slate-300 bg-slate-100 hover:bg-slate-200 transition-colors">
        {{ t.view_all }}
    </button>
</div>
{% endif %}

<!-- Calendario -->
<div id="calendar" class="bg-white rounded-2xl shadow-lg border border-slate-100 p-4"></div>

<!-- Modal de Detalle de Clase -->
<div id="sessionModal" style="display:none;" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 id="modalTitle" class="text-xl font-bold text-slate-900"></h3>
                <p id="modalTime" class="text-sm text-slate-600"></p>
            </div>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="space-y-3">
            <div id="modalStaff" class="flex items-center gap-2 text-sm">
                <span class="font-medium">üë§ {{ t.instructor }}:</span>
                <span id="modalStaffName"></span>
            </div>
            
            <div id="modalRoom" class="flex items-center gap-2 text-sm">
                <span class="font-medium">üìç {{ t.room }}:</span>
                <span id="modalRoomName"></span>
            </div>
            
            <div class="flex items-center gap-2 text-sm">
                <span class="font-medium">üë• {{ t.availability }}:</span>
                <span id="modalCapacity"></span>
            </div>
            
            <div id="modalAvailability" class="mt-4"></div>
            
            <!-- Selector de Puestos -->
            <div id="spotSelectorContainer" style="display: none;" class="mt-4 border-t border-slate-200 pt-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-slate-900">ü™ë Selecciona tu puesto</h4>
                    <span id="selectedSpotLabel" class="text-sm text-slate-600"></span>
                </div>
                <div id="spotSelectorGrid" class="relative bg-slate-100 rounded-lg border-2 border-slate-300" style="min-height: 200px;">
                    <!-- Los puestos se cargan din√°micamente -->
                    <div id="spotSelectorLoading" class="absolute inset-0 flex items-center justify-center">
                        <svg class="animate-spin h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2 flex gap-4 text-xs text-slate-500">
                    <span class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-emerald-500"></span> Disponible
                    </span>
                    <span class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-slate-400"></span> Ocupado
                    </span>
                    <span class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded bg-blue-500"></span> Tu selecci√≥n
                    </span>
                </div>
            </div>
        </div>
        
        {% if can_book and user.is_authenticated %}
        <div class="mt-6">
            <button id="bookButton" onclick="bookClass()" 
                    class="w-full brand-bg text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity">
                {{ t.book_spot }}
            </button>
        </div>
        {% elif can_book and not user.is_authenticated %}
        <div class="mt-6">
            <a href="{% url 'public_login' slug=settings.public_slug %}?next={% url 'public_schedule' slug=settings.public_slug %}" 
               class="block w-full brand-bg text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity text-center">
                {{ t.login_to_book_btn }}
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    let calendar;
    let currentFilter = null;
    let currentSessionId = null;
    let pendingClaim = null;  // Para guardar la entrada de waitlist pendiente de claim
    let claimTimer = null;
    let selectedSpotNumber = null;  // Puesto seleccionado
    let spotsData = null;  // Datos de puestos de la sesi√≥n actual
    
    // Translation strings
    const t = {
        spots_occupied: '{{ t.spots_occupied }}',
        class_full: '{{ t.class_full }}',
        spots_available: '{{ t.spots_available }}',
        booking_in_progress: '{{ t.booking_in_progress }}',
        booking_error: '{{ t.booking_error }}',
        could_not_complete: '{{ t.could_not_complete }}',
        join_waitlist: 'Unirse a Lista de Espera',
        waitlist_position: 'Posici√≥n en lista de espera',
        waitlist_vip: '‚≠ê Tienes prioridad VIP',
        select_spot: 'Selecciona un puesto',
        spot_selected: 'Puesto seleccionado'
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const locale = '{{ current_language|default:"es" }}';
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: locale,
            firstDay: 1,
            slotMinTime: '06:00:00',
            slotMaxTime: '23:00:00',
            allDaySlot: false,
            nowIndicator: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            events: {
                url: '{% url "api_public_schedule_events" slug=settings.public_slug %}',
                failure: function(err) {
                    console.error('Error loading events:', err);
                }
            },
            eventClick: function(info) {
                showSessionDetail(info.event);
            }
        });
        
        calendar.render();
        
        // Comprobar si hay plazas pendientes de claim
        {% if user.is_authenticated %}
        checkPendingClaims();
        {% endif %}
    });
    
    {% if user.is_authenticated %}
    function checkPendingClaims() {
        fetch('{% url "api_my_waitlist_entries" slug=settings.public_slug %}')
        .then(r => r.json())
        .then(data => {
            const claimable = data.entries?.filter(e => e.can_claim) || [];
            if (claimable.length > 0) {
                showClaimBanner(claimable[0]);
            }
        })
        .catch(console.error);
    }
    
    function showClaimBanner(entry) {
        pendingClaim = entry;
        document.getElementById('claimActivityName').textContent = 
            `${entry.activity_name} - ${new Date(entry.start_datetime).toLocaleString()}`;
        document.getElementById('waitlistClaimBanner').style.display = 'block';
        
        // Iniciar timer
        updateClaimTimer();
        claimTimer = setInterval(updateClaimTimer, 1000);
    }
    
    function updateClaimTimer() {
        if (!pendingClaim?.claim_expires_at) return;
        
        const expires = new Date(pendingClaim.claim_expires_at);
        const now = new Date();
        const diff = expires - now;
        
        if (diff <= 0) {
            clearInterval(claimTimer);
            document.getElementById('waitlistClaimBanner').style.display = 'none';
            alert('‚è∞ El tiempo para reclamar la plaza ha expirado.');
            location.reload();
            return;
        }
        
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        document.getElementById('claimTimeRemaining').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function claimWaitlistSpot() {
        if (!pendingClaim) return;
        
        const button = document.querySelector('#waitlistClaimBanner button');
        button.disabled = true;
        button.textContent = '‚è≥ Reclamando...';
        
        fetch(`{% url "api_claim_waitlist_spot" slug=settings.public_slug entry_id=0 %}`.replace('/0/', `/${pendingClaim.id}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('üéâ ¬°Plaza reclamada con √©xito! Ya est√°s en la clase.');
                clearInterval(claimTimer);
                document.getElementById('waitlistClaimBanner').style.display = 'none';
                calendar.refetchEvents();
            } else {
                alert('‚ùå ' + (data.error || 'Error al reclamar la plaza'));
                if (data.code === 'SPOT_TAKEN') {
                    document.getElementById('waitlistClaimBanner').style.display = 'none';
                }
            }
            button.disabled = false;
            button.textContent = '¬°Reclamar Plaza!';
        })
        .catch(err => {
            console.error(err);
            alert('Error al procesar la solicitud');
            button.disabled = false;
            button.textContent = '¬°Reclamar Plaza!';
        });
    }
    {% endif %}
    
    function filterByActivity(activityId) {
        currentFilter = activityId;
        calendar.refetchEvents();
        
        // Actualizar query params
        const url = new URL(window.location);
        if (activityId) {
            url.searchParams.set('activity', activityId);
        } else {
            url.searchParams.delete('activity');
        }
        window.history.replaceState({}, '', url);
    }
    
    function showSessionDetail(event) {
        const props = event.extendedProps;
        const locale = '{{ current_language|default:"es" }}';
        const localeMap = {'es': 'es-ES', 'en': 'en-US'};
        
        document.getElementById('modalTitle').textContent = event.title;
        document.getElementById('modalTime').textContent = event.start.toLocaleString(localeMap[locale] || 'es-ES', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Staff
        if (props.staff) {
            document.getElementById('modalStaffName').textContent = props.staff;
            document.getElementById('modalStaff').style.display = 'flex';
        } else {
            document.getElementById('modalStaff').style.display = 'none';
        }
        
        // Room
        if (props.room) {
            document.getElementById('modalRoomName').textContent = props.room;
            document.getElementById('modalRoom').style.display = 'flex';
        } else {
            document.getElementById('modalRoom').style.display = 'none';
        }
        
        // Capacity
        document.getElementById('modalCapacity').textContent = 
            `${props.attendees}/${props.max_capacity} ${t.spots_occupied}`;
        
        // Availability
        const availDiv = document.getElementById('modalAvailability');
        if (props.is_full) {
            availDiv.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800"><strong>‚ùå ${t.class_full}</strong></div>`;
        } else {
            availDiv.innerHTML = `<div class="p-3 bg-green-50 border border-green-200 rounded-xl text-sm text-green-800"><strong>‚úÖ ${props.spots_available} ${t.spots_available}</strong></div>`;
        }
        
        currentSessionId = event.id.replace('sess_', '');
        document.getElementById('sessionModal').style.display = 'flex';
        
        // Cargar puestos si la actividad lo permite
        selectedSpotNumber = null;
        spotsData = null;
        document.getElementById('selectedSpotLabel').textContent = '';
        loadSessionSpots(currentSessionId, props.allow_spot_booking);
    }
    
    function loadSessionSpots(sessionId, allowSpotBooking) {
        const container = document.getElementById('spotSelectorContainer');
        const grid = document.getElementById('spotSelectorGrid');
        const loading = document.getElementById('spotSelectorLoading');
        
        // Si no permite reserva de puestos, ocultar
        if (!allowSpotBooking) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        loading.style.display = 'flex';
        
        fetch(`/portal/gym/{{ settings.public_slug }}/api/session/${sessionId}/spots/`)
        .then(r => r.json())
        .then(data => {
            loading.style.display = 'none';
            spotsData = data;
            
            // Ocultar si no hay layout o no hay puestos configurados
            if (!data.has_layout || !data.spots || data.spots.length === 0) {
                container.style.display = 'none';
                spotsData = null;
                return;
            }
            
            renderSpotSelector(data);
        })
        .catch(err => {
            console.error('Error loading spots:', err);
            loading.style.display = 'none';
            grid.innerHTML = '<div class="p-4 text-center text-red-500">Error al cargar los puestos</div>';
        });
    }
    
    function renderSpotSelector(data) {
        const grid = document.getElementById('spotSelectorGrid');
        const layout = data.layout;
        
        // Calcular dimensiones del layout
        const maxX = Math.max(...data.spots.map(s => s.x), ...data.obstacles.map(o => o.x)) + 60;
        const maxY = Math.max(...data.spots.map(s => s.y), ...data.obstacles.map(o => o.y)) + 60;
        
        // Calcular escala para ajustar al contenedor
        const containerWidth = grid.clientWidth || 400;
        const containerHeight = 250;
        const scale = Math.min(containerWidth / maxX, containerHeight / maxY, 1);
        
        grid.style.height = `${Math.max(containerHeight, maxY * scale + 20)}px`;
        grid.innerHTML = '';
        
        // Renderizar obst√°culos
        data.obstacles.forEach(obs => {
            const el = document.createElement('div');
            el.className = 'absolute rounded bg-slate-300 border border-slate-400';
            el.style.left = `${obs.x * scale}px`;
            el.style.top = `${obs.y * scale}px`;
            el.style.width = `${40 * scale}px`;
            el.style.height = `${40 * scale}px`;
            el.title = obs.type || 'Obst√°culo';
            grid.appendChild(el);
        });
        
        // Renderizar puestos
        data.spots.forEach(spot => {
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'absolute rounded-lg flex items-center justify-center font-bold text-white shadow transition-all transform hover:scale-105';
            el.style.left = `${spot.x * scale}px`;
            el.style.top = `${spot.y * scale}px`;
            el.style.width = `${40 * scale}px`;
            el.style.height = `${40 * scale}px`;
            el.style.fontSize = `${12 * scale}px`;
            el.textContent = spot.number;
            el.dataset.spotNumber = spot.number;
            
            if (spot.status === 'occupied') {
                el.className += ' bg-slate-400 cursor-not-allowed';
                el.disabled = true;
                el.title = 'Puesto ocupado';
            } else if (spot.status === 'mine') {
                el.className += ' bg-blue-500 ring-2 ring-blue-300';
                el.title = 'Tu puesto reservado';
                selectedSpotNumber = spot.number;
                document.getElementById('selectedSpotLabel').textContent = `#${spot.number}`;
            } else {
                el.className += ' bg-emerald-500 hover:bg-emerald-600 cursor-pointer';
                el.title = `Puesto ${spot.number} - Disponible`;
                el.onclick = () => selectSpot(spot.number);
            }
            
            grid.appendChild(el);
        });
    }
    
    function selectSpot(spotNumber) {
        selectedSpotNumber = spotNumber;
        document.getElementById('selectedSpotLabel').textContent = `#${spotNumber}`;
        
        // Actualizar visualizaci√≥n
        const grid = document.getElementById('spotSelectorGrid');
        grid.querySelectorAll('button').forEach(btn => {
            const num = parseInt(btn.dataset.spotNumber);
            if (btn.disabled) return; // No cambiar ocupados
            
            if (num === spotNumber) {
                btn.className = btn.className.replace('bg-emerald-500 hover:bg-emerald-600', 'bg-blue-500 ring-2 ring-blue-300');
            } else {
                btn.className = btn.className.replace('bg-blue-500 ring-2 ring-blue-300', 'bg-emerald-500 hover:bg-emerald-600');
            }
        });
    }
    
    function closeModal() {
        document.getElementById('sessionModal').style.display = 'none';
        selectedSpotNumber = null;
        spotsData = null;
    }
    
    function bookClass() {
        {% if user.is_authenticated %}
        // Verificar si requiere puesto y no se ha seleccionado
        const spotContainer = document.getElementById('spotSelectorContainer');
        if (spotContainer.style.display !== 'none' && spotsData && spotsData.spots.length > 0 && !selectedSpotNumber) {
            alert('‚ö†Ô∏è Por favor, selecciona un puesto antes de reservar');
            return;
        }
        
        const button = document.getElementById('bookButton');
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '‚è≥ ' + t.booking_in_progress;
        
        const bookingData = {
            session_id: currentSessionId
        };
        
        // Agregar puesto si se seleccion√≥
        if (selectedSpotNumber) {
            bookingData.spot_number = selectedSpotNumber;
        }
        
        fetch('{% url "api_book_session" slug=settings.public_slug %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bookingData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.message);
                closeModal();
                calendar.refetchEvents();
            } else {
                alert('‚ùå ' + (data.error || t.could_not_complete));
                button.disabled = false;
                button.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(t.booking_error);
            button.disabled = false;
            button.textContent = originalText;
        });
        {% else %}
        window.location.href = '{% url "public_login" slug=settings.public_slug %}?next={% url "public_schedule" slug=settings.public_slug %}';
        {% endif %}
    }
    
    // Cerrar modal al hacer clic fuera
    document.getElementById('sessionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}