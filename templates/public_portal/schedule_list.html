{% extends 'public_portal/base.html' %}

{% block title %}Reservar - {{ gym.commercial_name|default:gym.name }}{% endblock %}

{% block extra_css %}
<style>
    .day-selector {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        padding: 0.5rem 0;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    .day-selector::-webkit-scrollbar { display: none; }
    
    .day-btn {
        flex-shrink: 0;
        width: 56px;
        padding: 0.75rem 0;
        border-radius: 1rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        background: white;
    }
    .day-btn:hover { border-color: var(--brand-color); }
    .day-btn.active {
        background: var(--brand-color);
        color: white;
        border-color: var(--brand-color);
    }
    .day-btn .day-num { font-size: 1.25rem; font-weight: 700; }
    .day-btn .day-name { font-size: 0.65rem; text-transform: uppercase; opacity: 0.7; }
    
    .session-card {
        transition: all 0.2s;
        border-left: 4px solid var(--activity-color, var(--brand-color));
    }
    .session-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
    }
    
    .tab-btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--brand-color); }
    .tab-btn.active {
        color: var(--brand-color);
        border-bottom-color: var(--brand-color);
    }
    
    .activity-image {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .staff-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .notification-banner {
        background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header con tabs -->
<div class="mb-6">
    <div class="flex items-center gap-4 border-b border-slate-200">
        <button class="tab-btn active" data-tab="clases">Clases</button>
        <button class="tab-btn" data-tab="citas">Citas</button>
    </div>
</div>

<!-- Selector de d√≠as -->
<div class="mb-6">
    <div class="day-selector" id="daySelector">
        <!-- Se genera din√°micamente -->
    </div>
</div>

<!-- Banner de notificaciones (opcional) -->
{% if settings.allow_online_booking and user.is_authenticated %}
<div class="notification-banner rounded-xl p-4 mb-6 flex items-center gap-3">
    <span class="text-2xl">üîî</span>
    <p class="text-sm text-amber-900">
        Habilite los permisos de recordatorio para recibir notificaciones cuando llegue el momento de registrarse.
    </p>
</div>
{% endif %}

<!-- T√≠tulo del d√≠a seleccionado -->
<h2 class="text-xl font-bold text-slate-900 mb-4" id="selectedDayTitle">
    Cargando...
</h2>

<!-- Lista de sesiones -->
<div id="sessionsContainer" class="space-y-4">
    <!-- Skeleton loading -->
    <div class="animate-pulse">
        <div class="bg-white rounded-xl p-4 flex gap-4">
            <div class="w-14 h-14 bg-slate-200 rounded-xl"></div>
            <div class="flex-1 space-y-2">
                <div class="h-5 bg-slate-200 rounded w-3/4"></div>
                <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                <div class="h-4 bg-slate-200 rounded w-1/4"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de detalle de clase -->
<div id="sessionModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4" style="display: none;">
    <div class="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
        <!-- Header con imagen -->
        <div class="relative h-48 bg-gradient-to-br from-slate-600 to-slate-800" id="modalHeader">
            <img id="modalImage" src="" alt="" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            <button onclick="closeModal()" class="absolute top-4 right-4 w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <div class="absolute bottom-4 left-4 right-4">
                <h3 id="modalTitle" class="text-2xl font-bold text-white mb-1"></h3>
                <p id="modalTime" class="text-white/80"></p>
            </div>
        </div>
        
        <!-- Contenido -->
        <div class="p-6 space-y-6">
            <!-- Info principal -->
            <div class="flex items-center gap-4">
                <div id="modalStaffAvatar" class="staff-avatar">
                    <span id="modalStaffInitial">M</span>
                </div>
                <div>
                    <div id="modalStaffName" class="font-semibold text-slate-900"></div>
                    <div id="modalRoomName" class="text-sm text-slate-500"></div>
                </div>
            </div>
            
            <!-- Detalles -->
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                    <div class="text-lg font-bold text-slate-900" id="modalDuration">50</div>
                    <div class="text-xs text-slate-500">minutos</div>
                </div>
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                    <div class="text-lg font-bold text-slate-900" id="modalIntensity">Media</div>
                    <div class="text-xs text-slate-500">intensidad</div>
                </div>
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                    <div class="text-lg font-bold text-slate-900" id="modalSpots">8</div>
                    <div class="text-xs text-slate-500">plazas</div>
                </div>
            </div>
            
            <!-- Descripci√≥n -->
            <div id="modalDescription" class="text-slate-600 text-sm"></div>
            
            <!-- Disponibilidad -->
            <div id="modalAvailability" class="p-4 rounded-xl"></div>
            
            <!-- Bot√≥n de reserva -->
            {% if settings.allow_online_booking %}
            <button id="bookBtn" onclick="bookSession()" class="w-full brand-bg text-white font-bold py-4 rounded-xl hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed">
                Reservar
            </button>
            {% else %}
            <div class="text-center text-slate-500 text-sm py-4">
                Contacta con el gimnasio para reservar
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const SLUG = '{{ settings.public_slug }}';
const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
const API_URL = '/public/gym/' + SLUG + '/api/schedule/events/';
let currentDate = new Date();
let selectedDate = new Date();
let currentSessionId = null;

// Generar selector de d√≠as (7 d√≠as)
function renderDaySelector() {
    const container = document.getElementById('daySelector');
    const days = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
    container.innerHTML = '';
    
    for (let i = 0; i < 14; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        
        const isToday = i === 0;
        const isSelected = date.toDateString() === selectedDate.toDateString();
        
        const btn = document.createElement('button');
        btn.className = `day-btn ${isSelected ? 'active' : ''}`;
        btn.innerHTML = `
            <div class="day-num">${date.getDate()}</div>
            <div class="day-name">${days[date.getDay()]}</div>
        `;
        btn.onclick = () => selectDay(date);
        container.appendChild(btn);
    }
}

function selectDay(date) {
    selectedDate = date;
    renderDaySelector();
    loadSessions();
}

function updateDayTitle() {
    const options = { weekday: 'long', day: 'numeric', month: 'short' };
    const title = selectedDate.toLocaleDateString('es-ES', options);
    document.getElementById('selectedDayTitle').textContent = title.charAt(0).toUpperCase() + title.slice(1);
}

async function loadSessions() {
    updateDayTitle();
    const container = document.getElementById('sessionsContainer');
    
    // Skeleton
    container.innerHTML = `
        <div class="animate-pulse space-y-4">
            ${[1,2,3].map(() => `
                <div class="bg-white rounded-xl p-4 flex gap-4">
                    <div class="w-14 h-14 bg-slate-200 rounded-xl"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-5 bg-slate-200 rounded w-3/4"></div>
                        <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    const start = selectedDate.toISOString().split('T')[0];
    const end = new Date(selectedDate);
    end.setDate(end.getDate() + 1);
    
    try {
        const response = await fetch(`${API_URL}?start=${start}&end=${end.toISOString().split('T')[0]}`);
        const sessions = await response.json();
        
        if (sessions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üì≠</div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">No hay clases este d√≠a</h3>
                    <p class="text-slate-500">Prueba con otro d√≠a de la semana</p>
                </div>
            `;
            return;
        }
        
        // Ordenar por hora
        sessions.sort((a, b) => new Date(a.start) - new Date(b.start));
        
        container.innerHTML = sessions.map(session => {
            const startTime = new Date(session.start);
            const endTime = new Date(session.end);
            const duration = Math.round((endTime - startTime) / (1000 * 60));
            const props = session.extendedProps || {};
            const isFull = props.is_full;
            const spotsLeft = props.spots_available || 0;
            
            return `
                <div class="session-card bg-white rounded-xl p-4 shadow-sm border border-slate-100 cursor-pointer hover:bg-slate-50"
                     style="--activity-color: ${session.backgroundColor || 'var(--brand-color)'}"
                     onclick='showSessionDetail(${JSON.stringify(session).replace(/'/g, "\\'")})'>
                    <div class="flex gap-4">
                        <!-- Imagen o placeholder -->
                        ${props.image ? 
                            `<img src="${props.image}" alt="${session.title}" class="activity-image">` :
                            `<div class="activity-image bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>`
                        }
                        
                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-900 mb-1">${session.title}</h3>
                            <p class="text-sm text-slate-600 mb-1">
                                ${startTime.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})} ‚Ä¢ ${duration} min
                            </p>
                            <div class="flex items-center gap-2 text-sm text-slate-500">
                                ${props.staff ? `<span>${props.staff}</span>` : ''}
                                ${props.room ? `<span class="text-slate-300">‚Ä¢</span><span>${props.room}</span>` : ''}
                            </div>
                        </div>
                        
                        <!-- Disponibilidad -->
                        <div class="flex flex-col items-end justify-between">
                            ${isFull ? 
                                `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-lg">Completo</span>` :
                                `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-lg">${spotsLeft} plazas</span>`
                            }
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading sessions:', error);
        container.innerHTML = `
            <div class="text-center py-12">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Error al cargar</h3>
                <p class="text-slate-500">Intenta de nuevo m√°s tarde</p>
            </div>
        `;
    }
}

function showSessionDetail(session) {
    const props = session.extendedProps || {};
    const startTime = new Date(session.start);
    const endTime = new Date(session.end);
    const duration = Math.round((endTime - startTime) / (1000 * 60));
    
    // Header
    document.getElementById('modalTitle').textContent = session.title;
    document.getElementById('modalTime').textContent = startTime.toLocaleString('es-ES', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Imagen
    const modalImg = document.getElementById('modalImage');
    if (props.image) {
        modalImg.src = props.image;
        modalImg.style.display = 'block';
    } else {
        modalImg.style.display = 'none';
    }
    
    // Staff
    document.getElementById('modalStaffName').textContent = props.staff || 'Sin asignar';
    document.getElementById('modalStaffInitial').textContent = props.staff ? props.staff.charAt(0) : '?';
    document.getElementById('modalRoomName').textContent = props.room || '';
    
    // Detalles
    document.getElementById('modalDuration').textContent = duration;
    document.getElementById('modalIntensity').textContent = props.intensity || 'Media';
    document.getElementById('modalSpots').textContent = props.spots_available || 0;
    
    // Descripci√≥n
    document.getElementById('modalDescription').textContent = props.description || '';
    
    // Disponibilidad y acceso
    const availDiv = document.getElementById('modalAvailability');
    const bookBtn = document.getElementById('bookBtn');
    
    // Verificar acceso del cliente
    if (props.booking_message === 'no_membership') {
        // Sin membres√≠a
        availDiv.className = 'p-4 rounded-xl bg-amber-50 text-amber-800';
        availDiv.innerHTML = `
            <strong>‚ö†Ô∏è Necesitas un bono o suscripci√≥n</strong>
            <p class="text-sm mt-1">Adquiere un plan para reservar esta actividad</p>
        `;
        if (bookBtn) {
            bookBtn.textContent = 'Ver Planes';
            bookBtn.className = 'w-full py-4 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 transition';
            bookBtn.onclick = () => window.location.href = '/public/gym/' + SLUG + '/pricing/';
        }
    } else if (props.booking_message === 'activity_not_included') {
        // Actividad no incluida en su cuota
        availDiv.className = 'p-4 rounded-xl bg-orange-50 text-orange-800';
        availDiv.innerHTML = `
            <strong>üîí Tu cuota "${props.membership_name || 'actual'}" no incluye esta actividad</strong>
            <p class="text-sm mt-1">Consulta otros planes que incluyan ${session.title}</p>
        `;
        if (bookBtn) {
            bookBtn.textContent = 'Ver Planes Disponibles';
            bookBtn.className = 'w-full py-4 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition';
            bookBtn.onclick = () => window.location.href = '/public/gym/' + SLUG + '/pricing/';
        }
    } else if (props.is_full) {
        availDiv.className = 'p-4 rounded-xl bg-red-50 text-red-800';
        availDiv.innerHTML = '<strong>‚ùå Clase Completa</strong><p class="text-sm mt-1">Puedes apuntarte a la lista de espera</p>';
        if (bookBtn) {
            bookBtn.textContent = 'Apuntarse a lista de espera';
            bookBtn.className = 'w-full py-4 brand-bg text-white font-bold rounded-xl hover:opacity-90 transition';
            bookBtn.onclick = bookSession;
        }
    } else if (!IS_AUTHENTICATED) {
        availDiv.className = 'p-4 rounded-xl bg-green-50 text-green-800';
        availDiv.innerHTML = `<strong>‚úÖ ${props.spots_available} plazas disponibles</strong>`;
        if (bookBtn) {
            bookBtn.textContent = 'Iniciar sesi√≥n para reservar';
            bookBtn.className = 'w-full py-4 brand-bg text-white font-bold rounded-xl hover:opacity-90 transition';
            bookBtn.onclick = () => window.location.href = '/public/gym/' + SLUG + '/login/?next=/public/gym/' + SLUG + '/schedule/';
        }
    } else {
        // Puede reservar normalmente
        availDiv.className = 'p-4 rounded-xl bg-green-50 text-green-800';
        availDiv.innerHTML = `<strong>‚úÖ ${props.spots_available} plazas disponibles</strong>`;
        if (bookBtn) {
            bookBtn.textContent = 'Reservar';
            bookBtn.className = 'w-full py-4 brand-bg text-white font-bold rounded-xl hover:opacity-90 transition';
            bookBtn.onclick = bookSession;
        }
    }
    
    currentSessionId = session.id ? session.id.replace('sess_', '') : null;
    document.getElementById('sessionModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('sessionModal').style.display = 'none';
    document.body.style.overflow = '';
}

async function bookSession() {
    if (!IS_AUTHENTICATED) {
        window.location.href = '/public/gym/' + SLUG + '/login/?next=/public/gym/' + SLUG + '/schedule/';
        return;
    }
    
    if (!currentSessionId) return;
    
    const btn = document.getElementById('bookBtn');
    btn.disabled = true;
    btn.textContent = 'Reservando...';
    
    try {
        const response = await fetch('/public/gym/' + SLUG + '/api/bookings/book/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ session_id: currentSessionId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeModal();
            // Toast de √©xito
            showToast('‚úÖ ¬°Reserva confirmada!', 'success');
            loadSessions();
        } else {
            showToast(data.error || 'Error al reservar', 'error');
            btn.disabled = false;
            btn.textContent = 'Reservar';
        }
    } catch (error) {
        showToast('Error de conexi√≥n', 'error');
        btn.disabled = false;
        btn.textContent = 'Reservar';
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-auto p-4 rounded-xl shadow-lg z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // TODO: Cambiar entre clases y citas
    });
});

// Click fuera del modal para cerrar
document.getElementById('sessionModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// Init
renderDaySelector();
loadSessions();
</script>
{% endblock %}
