{% extends 'public_portal/base.html' %}
{% load static %}

{% block title %}M√©todos de Pago - {{ gym.name }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --brand-color: {{ settings.primary_color|default:'#6366f1' }};
    }
    .brand-bg { background-color: var(--brand-color); }
    .brand-text { color: var(--brand-color); }
    
    .card-item {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .card-icon {
        width: 56px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
    }
    
    .card-number {
        font-family: 'Courier New', monospace;
        font-size: 16px;
        letter-spacing: 2px;
    }
    
    .card-visa { background: linear-gradient(135deg, #1a1f71 0%, #0066b2 100%); }
    .card-mastercard { background: linear-gradient(135deg, #eb001b 0%, #f79e1b 100%); }
    .card-redsys { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    
    .add-card-form {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-top: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .StripeElement {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: white;
    }
    
    .StripeElement--focus {
        border-color: var(--brand-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .StripeElement--invalid {
        border-color: #ef4444;
    }
</style>

{% if show_stripe and stripe_public_key %}
<script src="https://js.stripe.com/v3/"></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-6">
        <a href="{% url 'public_client_profile' slug=settings.public_slug %}" class="p-2 bg-white rounded-xl shadow">
            <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </a>
        <h1 class="text-2xl font-bold text-slate-900">M√©todos de Pago</h1>
    </div>
    
    <!-- Tarjetas Stripe -->
    {% if stripe_cards %}
        {% for card in stripe_cards %}
        <div class="card-item">
            <div class="card-icon {% if 'visa' in card.card.brand|lower %}card-visa{% elif 'master' in card.card.brand|lower %}card-mastercard{% endif %}">
                üí≥
            </div>
            <div class="flex-1">
                <div class="card-number text-slate-900">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ card.card.last4 }}</div>
                <div class="text-sm text-slate-500 mt-1">
                    {{ card.card.brand|title }}
                    ¬∑ Expira {{ card.card.exp_month }}/{{ card.card.exp_year }}
                </div>
            </div>
            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded-full">Stripe</span>
        </div>
        {% endfor %}
    {% endif %}
    
    <!-- Tokens Redsys -->
    {% if redsys_tokens %}
        {% for token in redsys_tokens %}
        <div class="card-item">
            <div class="card-icon card-redsys">
                üí≥
            </div>
            <div class="flex-1">
                <div class="card-number text-slate-900">{{ token.card_number|default:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ****" }}</div>
                <div class="text-sm text-slate-500 mt-1">
                    {{ token.card_brand|default:"Tarjeta" }}
                    {% if token.expiration %}
                        ¬∑ Expira {{ token.expiration }}
                    {% endif %}
                </div>
            </div>
            <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full">Redsys</span>
        </div>
        {% endfor %}
    {% endif %}
    
    <!-- Mensaje si no hay tarjetas -->
    {% if not stripe_cards and not redsys_tokens %}
        <div class="text-center py-12 bg-white rounded-2xl shadow">
            <div class="text-6xl mb-4">üí≥</div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Sin tarjetas guardadas</h3>
            <p class="text-slate-500 mb-6">No tienes m√©todos de pago registrados</p>
        </div>
    {% endif %}
    
    <!-- Bot√≥n para a√±adir tarjeta -->
    {% if show_stripe or show_redsys %}
    <div class="mt-6">
        <button id="addCardButton" onclick="showAddCardForm()" class="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all">
            + A√±adir M√©todo de Pago
        </button>
    </div>
    
    <!-- Formulario para a√±adir tarjeta (oculto inicialmente) -->
    <div id="addCardForm" class="add-card-form" style="display: none;">
        <h3 class="text-lg font-bold text-slate-900 mb-4">A√±adir Nueva Tarjeta</h3>
        
        {% if show_choice %}
        <!-- Selector de pasarela -->
        <div class="mb-4">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Pago</label>
            <div class="flex gap-3">
                {% if show_stripe %}
                <button onclick="selectGateway('stripe')" id="stripeBtn" class="flex-1 py-3 border-2 border-slate-200 rounded-lg hover:border-blue-500 transition-colors">
                    <span class="font-semibold">üí≥ Stripe</span>
                </button>
                {% endif %}
                {% if show_redsys %}
                <button onclick="selectGateway('redsys')" id="redsysBtn" class="flex-1 py-3 border-2 border-slate-200 rounded-lg hover:border-red-500 transition-colors">
                    <span class="font-semibold">üè¶ Redsys</span>
                </button>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Formulario Stripe -->
        {% if show_stripe %}
        <div id="stripeForm" {% if show_choice %}style="display: none;"{% endif %}>
            <form id="payment-form">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Nombre del titular</label>
                    <input type="text" id="cardholder-name" placeholder="Nombre como aparece en la tarjeta" 
                           class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Datos de la tarjeta</label>
                    <div id="card-element" class="p-3 border border-slate-300 rounded-lg"></div>
                </div>
                <div id="card-errors" class="text-red-600 text-sm mb-4"></div>
                <button type="submit" id="submit-stripe" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors">
                    Guardar Tarjeta
                </button>
            </form>
        </div>
        {% endif %}
        
        <!-- Formulario Redsys -->
        {% if show_redsys %}
        <div id="redsysForm" {% if show_choice %}style="display: none;"{% elif not show_stripe %}{% else %}style="display: none;"{% endif %}>
            <p class="text-sm text-slate-600 mb-4">
                Para a√±adir una tarjeta Redsys, debes realizar un pago o compra. La tarjeta se guardar√° autom√°ticamente.
            </p>
            <a href="{% url 'public_pricing' slug=settings.public_slug %}" class="block w-full py-3 bg-red-600 text-white font-bold rounded-xl text-center hover:bg-red-700 transition-colors">
                Ver Planes
            </a>
        </div>
        {% endif %}
        
        <button onclick="hideAddCardForm()" class="w-full mt-3 py-3 border border-slate-200 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
            Cancelar
        </button>
    </div>
    {% else %}
    <p class="text-sm text-slate-500 text-center mt-6 bg-white rounded-xl p-4">
        Las tarjetas se guardan autom√°ticamente cuando realizas un pago
    </p>
    {% endif %}
</div>

<script>
// Funciones b√°sicas siempre disponibles
function showAddCardForm() {
    const form = document.getElementById('addCardForm');
    const button = document.getElementById('addCardButton');
    if (form) form.style.display = 'block';
    if (button) button.style.display = 'none';
    
    {% if show_stripe and stripe_public_key and stripe_client_secret and not show_choice %}
    if (typeof cardElement !== 'undefined' && !cardMounted) {
        cardElement.mount('#card-element');
        cardMounted = true;
    }
    {% endif %}
}

function hideAddCardForm() {
    const form = document.getElementById('addCardForm');
    const button = document.getElementById('addCardButton');
    if (form) form.style.display = 'none';
    if (button) button.style.display = 'block';
}
</script>

{% if show_stripe and stripe_public_key and stripe_client_secret %}
<script>
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const cardElement = elements.create('card', {
    style: {
        base: {
            fontSize: '16px',
            color: '#1e293b',
            '::placeholder': {
                color: '#94a3b8',
            },
        },
    },
});

// Solo montar el elemento cuando se muestre el formulario
let cardMounted = false;

{% if show_choice %}
function selectGateway(gateway) {
    const stripeBtn = document.getElementById('stripeBtn');
    const redsysBtn = document.getElementById('redsysBtn');
    const stripeForm = document.getElementById('stripeForm');
    const redsysForm = document.getElementById('redsysForm');
    
    if (gateway === 'stripe') {
        stripeBtn.classList.add('border-blue-500', 'bg-blue-50');
        redsysBtn.classList.remove('border-red-500', 'bg-red-50');
        stripeForm.style.display = 'block';
        redsysForm.style.display = 'none';
        
        if (!cardMounted) {
            cardElement.mount('#card-element');
            cardMounted = true;
        }
    } else {
        redsysBtn.classList.add('border-red-500', 'bg-red-50');
        stripeBtn.classList.remove('border-blue-500', 'bg-blue-50');
        redsysForm.style.display = 'block';
        stripeForm.style.display = 'none';
    }
}
{% endif %}

// Handle form submission
const form = document.getElementById('payment-form');
form.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const submitButton = document.getElementById('submit-stripe');
    submitButton.disabled = true;
    submitButton.textContent = 'Guardando...';
    
    const {error} = await stripe.confirmCardSetup(
        '{{ stripe_client_secret }}',
        {
            payment_method: {
                card: cardElement,
            }
        }
    );
    
    if (error) {
        document.getElementById('card-errors').textContent = error.message;
        submitButton.disabled = false;
        submitButton.textContent = 'Guardar Tarjeta';
    } else {
        // Tarjeta guardada exitosamente
        window.location.reload();
    }
});

// Display error messages
cardElement.on('change', (event) => {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
        displayError.textContent = event.error.message;
    } else {
        displayError.textContent = '';
    }
});
</script>
{% endif %}
{% endblock %}
