{% load popup_tags %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="{{ client.gym.brand_color|default:'#0f172a' }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="{{ client.gym.name|default:'Mi Gym' }}">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/static/manifest_portal.json">
    <link rel="apple-touch-icon" href="/static/icons/portal/icon-192.png">

    <title>{% block title %}{{ client.gym.name|default:'Mi Gym' }}{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    
    <!-- Swiper for Advertisements Carousel -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <style>
        :root {
            --brand-color: {{ client.gym.brand_color|default:'#0f172a' }};
            --brand-rgb: {{ client.gym.brand_color|default:'#0f172a' }};
        }

        * {
            font-family: 'Outfit', sans-serif;
        }

        /* Safe area for iPhone notch */
        .pb-safe {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        .pt-safe {
            padding-top: env(safe-area-inset-top);
        }

        /* Hide scrollbar but allow scroll */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Glass morphism */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* Brand color utilities */
        .bg-brand {
            background-color: var(--brand-color);
        }

        .text-brand {
            color: var(--brand-color);
        }

        .border-brand {
            border-color: var(--brand-color);
        }

        .gradient-brand {
            background: linear-gradient(135deg, var(--brand-color), #1e293b);
        }

        /* Smooth page transitions */
        .page-enter {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.4s ease-out;
        }

        /* Pull to refresh indicator */
        .refresh-indicator {
            transition: transform 0.2s;
        }

        /* Bottom nav active indicator */
        .nav-active {
            color: var(--brand-color);
        }

        .nav-active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--brand-color);
            border-radius: 50%;
        }

        /* Modern card shadows */
        .card-modern {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-modern:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body class="bg-slate-50 min-h-screen {% block body_class %}pb-24{% endblock %}">

    {% block header %}
    <!-- Default Header -->
    <header class="bg-white p-4 sticky top-0 z-30 shadow-sm flex items-center gap-4">
        {% block header_left %}
        <a href="{% url 'portal_home' %}"
            class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </a>
        {% endblock %}

        <h1 class="font-bold text-lg text-slate-800 flex-1">{% block page_title %}{% endblock %}</h1>

        {% block header_right %}{% endblock %}
    </header>
    {% endblock %}

    <!-- Messages Toast -->
    {% if messages %}
    <div class="fixed top-4 left-4 right-4 z-50 space-y-2" x-data="{ show: true }" x-show="show"
        x-init="setTimeout(() => show = false, 4000)">
        {% for message in messages %}
        <div class="p-4 rounded-2xl shadow-lg text-sm font-medium flex items-center gap-3 animate-[fadeIn_0.3s_ease-out]
            {% if message.tags == 'success' %}bg-emerald-500 text-white
            {% elif message.tags == 'error' %}bg-red-500 text-white
            {% elif message.tags == 'warning' %}bg-amber-500 text-white
            {% else %}bg-slate-800 text-white{% endif %}">
            {% if message.tags == 'success' %}
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            {% elif message.tags == 'error' %}
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            {% endif %}
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Popup Notification System -->
    {% if popups %}
    <div x-data="{ 
        show: true,
        popupId: {{ popups.0.id }},
        markRead() {
            this.show = false;
            fetch('/app/api/popup/' + this.popupId + '/read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
        }
    }" x-show="show" class="fixed inset-0 z-50 flex items-center justify-center px-4">
        <!-- Debug Popups: {{ popups|length }} -->

        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" x-transition.opacity></div>

        <!-- Modal -->
        <div class="relative bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-10 scale-95"
            x-transition:enter-end="opacity-100 translate-y-0 scale-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95">

            {% if popups.0.image %}
            <div class="h-48 w-full bg-slate-100 relative">
                <img src="{{ popups.0.image.url }}" class="w-full h-full object-cover">
            </div>
            {% endif %}

            <div class="p-6">
                <!-- Priority Badge -->
                {% if popups.0.priority == 'URGENT' %}
                <div class="inline-block px-3 py-1 rounded-full bg-red-100 text-red-600 text-xs font-bold mb-3">
                    URGENTE
                </div>
                {% elif popups.0.priority == 'WARNING' %}
                <div class="inline-block px-3 py-1 rounded-full bg-amber-100 text-amber-600 text-xs font-bold mb-3">
                    AVISO
                </div>
                {% endif %}

                <h3 class="text-xl font-bold text-slate-800 mb-2">{{ popups.0.title }}</h3>
                <div class="prose prose-sm text-slate-600 mb-6">
                    {{ popups.0|render_popup_content:client|safe }}
                </div>

                <button @click="markRead()"
                    class="w-full py-3.5 rounded-2xl bg-indigo-600 text-white font-bold text-lg shadow-lg shadow-indigo-500/30 active:scale-95 transition-transform">
                    Entendido
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="p-4 page-enter {% block main_class %}{% endblock %}">
        {% block content %}{% endblock %}
    </main>

    {% block bottom_nav %}
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-40 pb-safe">
        <div class="flex justify-around items-center py-2.5 px-4">
            <a href="{% url 'portal_home' %}"
                class="flex flex-col items-center gap-0.5 relative {% if request.resolver_match.url_name == 'portal_home' %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                <span class="text-[10px] font-bold">Inicio</span>
            </a>

            <a href="{% url 'portal_bookings' %}"
                class="flex flex-col items-center gap-0.5 relative {% if 'booking' in request.resolver_match.url_name %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                <span class="text-[10px] font-bold">Reservas</span>
            </a>

            <!-- Check-in Button (destacado en el centro) -->
            <a href="{% url 'portal_checkin' %}"
                class="flex flex-col items-center gap-0.5 relative -mt-6 {% if 'checkin' in request.resolver_match.url_name %}nav-active{% endif %}">
                <div class="w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-white mb-1" style="background-color: var(--brand-color);">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" 
                            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                        </path>
                    </svg>
                </div>
                <span class="text-[10px] font-bold" style="color: var(--brand-color);">Check-in</span>
            </a>

            <a href="{% url 'portal_routines' %}"
                class="flex flex-col items-center gap-0.5 relative {% if 'routine' in request.resolver_match.url_name %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
                <span class="text-[10px] font-bold">Rutinas</span>
            </a>

            <a href="{% url 'portal_documents' %}"
                class="flex flex-col items-center gap-0.5 relative {% if 'document' in request.resolver_match.url_name %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <span class="text-[10px] font-bold">Docs</span>
            </a>

            <a href="{% url 'portal_profile' %}"
                class="flex flex-col items-center gap-0.5 relative {% if 'profile' in request.resolver_match.url_name %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span class="text-[10px] font-bold">Perfil</span>
            </a>

            <a href="{% url 'portal_shop' %}"
                class="flex flex-col items-center gap-0.5 relative {% if 'shop' in request.resolver_match.url_name %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <span class="text-[10px] font-bold">Tienda</span>
            </a>

            <a href="{% url 'portal_chat' %}"
                class="flex flex-col items-center gap-0.5 relative {% if 'chat' in request.resolver_match.url_name %}nav-active{% else %}text-slate-400{% endif %}">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span class="text-[10px] font-bold">Chat</span>
            </a>
        </div>
    </nav>
    {% endblock %}

    {% block extra_js %}{% endblock %}

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW failed:', err));
        }
    </script>
</body>

</html>