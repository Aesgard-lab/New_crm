{% extends "portal/base.html" %}

{% block title %}Valorar Clase - {{ client.gym.name }}{% endblock %}

{% block page_title %}Valorar tu Clase{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header con info de la clase -->
    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 mb-6">
        <div class="flex items-start gap-4">
            {% if review_request.session.activity.image %}
            <img src="{{ review_request.session.activity.image.url }}" 
                 class="w-20 h-20 rounded-2xl object-cover">
            {% else %}
            <div class="w-20 h-20 rounded-2xl bg-slate-100 flex items-center justify-center">
                <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
            </div>
            {% endif %}
            
            <div class="flex-1">
                <h2 class="text-xl font-bold text-slate-900 mb-1">{{ review_request.session.activity.name }}</h2>
                <p class="text-sm text-slate-600">
                    Con {{ review_request.session.staff.user.first_name }} {{ review_request.session.staff.user.last_name }}
                </p>
                <p class="text-xs text-slate-400 mt-1">
                    {{ review_request.session.start_datetime|date:"d M Y" }} a las 
                    {{ review_request.session.start_datetime|time:"H:i" }}
                </p>
            </div>
        </div>
    </div>

    <!-- Formulario de valoración -->
    <form method="post" class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6" x-data="reviewForm()">
        {% csrf_token %}

        <!-- Valoración del Instructor -->
        <div class="mb-8">
            <label class="block text-lg font-bold text-slate-900 mb-3">¿Cómo valorías al instructor?</label>
            <div class="flex gap-3 justify-center mb-2">
                <template x-for="star in 5" :key="star">
                    <button type="button" 
                            @click="instructorRating = star"
                            class="transition-transform hover:scale-110">
                        <svg class="w-12 h-12 transition-colors" 
                             :class="star <= instructorRating ? 'text-yellow-400 fill-current' : 'text-slate-300'"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z">
                            </path>
                        </svg>
                    </button>
                </template>
            </div>
            <p class="text-center text-sm text-slate-500" x-show="instructorRating > 0" x-cloak>
                <span x-text="instructorRating"></span> de 5 estrellas
            </p>
            <input type="hidden" name="instructor_rating" :value="instructorRating" required>
        </div>

        <!-- Valoración de la Clase -->
        <div class="mb-8">
            <label class="block text-lg font-bold text-slate-900 mb-3">¿Cómo valorías la clase?</label>
            <div class="flex gap-3 justify-center mb-2">
                <template x-for="star in 5" :key="star">
                    <button type="button" 
                            @click="classRating = star"
                            class="transition-transform hover:scale-110">
                        <svg class="w-12 h-12 transition-colors" 
                             :class="star <= classRating ? 'text-yellow-400 fill-current' : 'text-slate-300'"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z">
                            </path>
                        </svg>
                    </button>
                </template>
            </div>
            <p class="text-center text-sm text-slate-500" x-show="classRating > 0" x-cloak>
                <span x-text="classRating"></span> de 5 estrellas
            </p>
            <input type="hidden" name="class_rating" :value="classRating" required>
        </div>

        <!-- Tags predefinidos -->
        <div class="mb-8">
            <label class="block text-sm font-bold text-slate-700 mb-3">¿Cómo describirías la clase? (opcional)</label>
            <div class="flex flex-wrap gap-2">
                <template x-for="tag in availableTags" :key="tag">
                    <button type="button"
                            @click="toggleTag(tag)"
                            :class="selectedTags.includes(tag) ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-700'"
                            class="px-4 py-2 rounded-full text-sm font-medium transition-colors">
                        <span x-text="tag"></span>
                    </button>
                </template>
            </div>
            <input type="hidden" name="tags" :value="JSON.stringify(selectedTags)">
        </div>

        <!-- Comentario -->
        <div class="mb-6">
            <label class="block text-sm font-bold text-slate-700 mb-2">Comentario (opcional)</label>
            <textarea name="comment" 
                      rows="4" 
                      placeholder="Cuéntanos más sobre tu experiencia..."
                      class="w-full rounded-xl border-slate-200 p-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
        </div>

        <!-- Botones -->
        <div class="flex gap-3">
            <a href="{% url 'portal_home' %}" 
               class="flex-1 py-3 px-4 rounded-xl border-2 border-slate-200 text-slate-700 font-bold text-center hover:bg-slate-50 transition-colors">
                Más Tarde
            </a>
            <button type="submit"
                    :disabled="instructorRating === 0 || classRating === 0"
                    :class="instructorRating > 0 && classRating > 0 ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-300 cursor-not-allowed'"
                    class="flex-1 py-3 px-4 rounded-xl text-white font-bold transition-colors">
                Enviar Valoración
            </button>
        </div>
    </form>
</div>

<script>
    function reviewForm() {
        return {
            instructorRating: 0,
            classRating: 0,
            selectedTags: [],
            availableTags: ['Limpio', 'Intenso', 'Amigable', 'Motivador', 'Técnico', 'Divertido', 'Desafiante', 'Relajado'],
            
            toggleTag(tag) {
                const index = this.selectedTags.indexOf(tag);
                if (index > -1) {
                    this.selectedTags.splice(index, 1);
                } else {
                    this.selectedTags.push(tag);
                }
            }
        }
    }
</script>
{% endblock %}
