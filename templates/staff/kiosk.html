<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Kiosco Staff - Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Deshabilitar zoom en input al hacer tap en mÃ³viles */
        input {
            font-size: 16px;
        }
        
        /* Modo Quiosco: Pantalla completa */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }
        
        /* AnimaciÃ³n de Ã©xito/error */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .pulse-success {
            animation: pulse-success 0.6s;
        }
        
        /* VibraciÃ³n visual al presionar botÃ³n */
        @keyframes tap-feedback {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        .tap-feedback {
            animation: tap-feedback 0.2s;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 h-screen flex items-center justify-center overflow-hidden">

    <!-- Logo del Gimnasio -->
    <div class="absolute top-8 left-8 text-white">
        <h2 class="text-2xl font-bold">{{ gym.name|default:"TechGym" }}</h2>
        <p class="text-sm text-slate-400">Control de Personal</p>
    </div>
    
    <!-- Reloj Digital -->
    <div class="absolute top-8 right-8 text-white text-right">
        <div id="current-time" class="text-3xl font-bold tabular-nums"></div>
        <div id="current-date" class="text-sm text-slate-400"></div>
    </div>

    <div class="relative w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 text-center mx-4">

        <!-- Modal de ConfirmaciÃ³n -->
        <div id="confirm-modal"
            class="hidden absolute top-0 left-0 w-full h-full bg-white/98 backdrop-blur-sm rounded-3xl flex flex-col items-center justify-center z-20 transition-all p-6 overflow-hidden">
            
            <!-- Vista de captura de cÃ¡mara (oculta por defecto) -->
            <div id="camera-view" class="hidden absolute inset-0 bg-black flex flex-col items-center justify-center z-30">
                <video id="camera-video" class="w-full h-full object-cover" autoplay playsinline></video>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6 flex flex-col items-center">
                    <p class="text-white text-lg mb-4" id="camera-instruction">Mira a la cÃ¡mara para capturar</p>
                    <button id="capture-btn" 
                        class="w-20 h-20 rounded-full bg-white border-4 border-white/50 shadow-xl flex items-center justify-center hover:scale-105 transition-transform">
                        <div class="w-16 h-16 rounded-full bg-white"></div>
                    </button>
                    <button id="cancel-camera-btn" class="mt-4 text-white/70 text-sm hover:text-white">Cancelar</button>
                </div>
                <canvas id="photo-canvas" class="hidden"></canvas>
            </div>
            
            <!-- Vista de confirmaciÃ³n normal -->
            <div id="confirm-content" class="flex flex-col items-center justify-center">
                <!-- Foto del empleado o selfie capturado -->
                <div id="confirm-photo-container" class="mb-4 relative">
                    <img id="confirm-photo" src="" alt="" class="w-28 h-28 rounded-full object-cover border-4 shadow-xl">
                    <!-- Badge de cÃ¡mara si se requiere selfie -->
                    <div id="selfie-badge" class="hidden absolute -bottom-1 -right-1 bg-blue-500 text-white rounded-full p-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                </div>
                
                <h2 id="confirm-name" class="text-2xl font-bold text-slate-800 mb-1"></h2>
                <p id="confirm-duration" class="text-slate-500 text-sm mb-4"></p>
                
                <div id="confirm-action-badge" class="px-6 py-3 rounded-2xl text-xl font-bold mb-4">
                    <!-- ENTRADA o SALIDA -->
                </div>
                
                <!-- MÃ©todo requerido -->
                <div id="method-required" class="hidden text-xs text-slate-500 mb-4 flex items-center gap-2">
                    <span id="method-icon">ðŸ“¸</span>
                    <span id="method-text">Se requiere selfie</span>
                </div>
                
                <!-- Advertencia mÃ³dulo en pruebas -->
                <div id="selfie-warning" class="hidden text-xs bg-amber-50 text-amber-700 px-3 py-2 rounded-lg mb-4">
                    ðŸ§ª MÃ³dulo en pruebas - Foto guardada como evidencia
                </div>
                
                <p class="text-slate-500 text-sm mb-6">Â¿Confirmar fichaje?</p>
                
                <div class="flex gap-4 w-full max-w-xs">
                    <button id="cancel-confirm-btn" 
                        class="flex-1 bg-slate-200 text-slate-700 font-bold py-4 rounded-xl transition-all hover:bg-slate-300">
                        Cancelar
                    </button>
                    <button id="do-confirm-btn" 
                        class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all hover:shadow-xl">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

        <!-- Estado (Mensajes) -->
        <div id="status-message"
            class="hidden absolute top-0 left-0 w-full h-full bg-white/95 backdrop-blur-sm rounded-3xl flex flex-col items-center justify-center z-10 transition-all">
            
            <!-- Foto del empleado tras fichaje exitoso -->
            <div id="staff-photo-container" class="hidden mb-4">
                <img id="staff-photo" src="" alt="" class="w-32 h-32 rounded-full object-cover border-4 border-green-500 shadow-xl">
            </div>
            
            <div id="status-icon" class="text-7xl mb-4">ðŸ‘‹</div>
            <h2 id="status-title" class="text-3xl font-bold text-slate-800 mb-2"></h2>
            <p id="status-text" class="text-slate-600 text-lg"></p>
            <p id="status-time" class="text-slate-400 text-sm mt-2"></p>
        </div>

        <div class="mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-700 mb-1">Control de Acceso</h1>
            <p class="text-slate-500 text-sm">Introduce tu PIN de empleado</p>
        </div>

        <!-- PIN Display -->
        <div class="mb-8">
            <div class="flex justify-center gap-4" id="pin-display">
                <div class="w-5 h-5 rounded-full bg-slate-200 pin-dot transition-all duration-200"></div>
                <div class="w-5 h-5 rounded-full bg-slate-200 pin-dot transition-all duration-200"></div>
                <div class="w-5 h-5 rounded-full bg-slate-200 pin-dot transition-all duration-200"></div>
                <div class="w-5 h-5 rounded-full bg-slate-200 pin-dot transition-all duration-200"></div>
                <div class="w-4 h-4 rounded-full bg-slate-200 pin-dot transition-all duration-200 opacity-50"></div>
                <div class="w-4 h-4 rounded-full bg-slate-200 pin-dot transition-all duration-200 opacity-50"></div>
            </div>
            <p class="text-xs text-slate-400 mt-2">PIN de 4-6 dÃ­gitos</p>
            <input type="password" id="pin-input" class="opacity-0 absolute w-0 h-0" maxlength="6" inputmode="numeric">
        </div>

        <!-- Numpad -->
        <div class="grid grid-cols-3 gap-3 max-w-xs mx-auto mb-6">
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="1">1</button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="2">2</button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="3">3</button>

            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="4">4</button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="5">5</button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="6">6</button>

            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="7">7</button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="8">8</button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="9">9</button>

            <button class="w-20 h-20 text-slate-400 hover:text-slate-600 active:text-red-500 text-xl font-semibold flex items-center justify-center transition-all"
                onclick="clearPin()">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <button
                class="numpad-btn w-20 h-20 rounded-2xl bg-slate-50 border-2 border-slate-200 text-3xl font-bold text-slate-700 hover:bg-slate-100 active:bg-blue-100 active:border-blue-400 transition-all text-center flex items-center justify-center shadow-sm"
                data-val="0">0</button>
            <button class="w-20 h-20 text-slate-400 hover:text-slate-600 active:text-amber-500 text-xl font-semibold flex items-center justify-center transition-all"
                onclick="backspace()">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path>
                </svg>
            </button>
        </div>

        <button id="submit-btn"
            class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl opacity-50 cursor-not-allowed transition-all disabled:opacity-50 enabled:hover:shadow-2xl enabled:hover:scale-[1.02]"
            disabled>
            <span class="flex items-center justify-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                FICHAR
            </span>
        </button>

        <div class="mt-6 text-xs text-slate-400 space-y-1">
            <p>TechGym CRM System v2.0</p>
            <p>ðŸ”’ ConexiÃ³n Segura</p>
        </div>
    </div>

    <!-- Audio para feedback -->
    <audio id="success-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEwxOouHwuGoiByJ+0fPQezAFKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEwxOouHwuGoiByJ+0fPQezAFKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEwxOouHwuGoiByJ+0fPQezAFKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEwxOouHwuGoiByJ+0fPQezAFKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEwxOouHwuGoiByJ+0fPQezAFKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEw==" type="audio/wav">
    </audio>
    <audio id="error-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuGz/LTgjMGHm7A7+OZRA0PVKvo66NFEw==" type="audio/wav">
    </audio>

    <script>
        const dots = document.querySelectorAll('.pin-dot');
        const submitBtn = document.getElementById('submit-btn');
        const pinDisplay = document.getElementById('pin-display');
        let currentPin = "";
        const MIN_PIN = 4;
        const MAX_PIN = 6;
        let isSubmitting = false;
        
        // Actualizar reloj en tiempo real
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateStr = now.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('current-time').textContent = timeStr;
            document.getElementById('current-date').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        }
        
        updateClock();
        setInterval(updateClock, 1000);
        
        // Auto-reset despuÃ©s de inactividad (30 segundos)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (currentPin.length > 0 && !isSubmitting) {
                    clearPin();
                    showTemporaryMessage('â±ï¸ Tiempo agotado', 'Por seguridad, el PIN fue borrado', 'warning');
                }
            }, 30000); // 30 segundos
        }
        
        resetInactivityTimer();

        document.querySelectorAll('.numpad-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (currentPin.length < MAX_PIN && !isSubmitting) {
                    // Feedback visual
                    btn.classList.add('tap-feedback');
                    setTimeout(() => btn.classList.remove('tap-feedback'), 200);
                    
                    // VibraciÃ³n en mÃ³viles
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                    
                    currentPin += btn.dataset.val;
                    updateUI();
                    resetInactivityTimer();
                    
                    // NO auto-submit - el usuario debe pulsar FICHAR
                }
            });
        });

        function clearPin() {
            currentPin = "";
            updateUI();
            resetInactivityTimer();
        }

        function backspace() {
            currentPin = currentPin.slice(0, -1);
            updateUI();
            resetInactivityTimer();
            
            // VibraciÃ³n en mÃ³viles
            if (navigator.vibrate) {
                navigator.vibrate(5);
            }
        }

        function updateUI() {
            dots.forEach((dot, index) => {
                if (index < currentPin.length) {
                    dot.classList.add('bg-blue-600', 'scale-110');
                    dot.classList.remove('bg-slate-200');
                } else {
                    dot.classList.remove('bg-blue-600', 'scale-110');
                    dot.classList.add('bg-slate-200');
                }
            });

            if (currentPin.length >= MIN_PIN) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.add('cursor-pointer');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.remove('cursor-pointer');
            }
        }

        submitBtn.addEventListener('click', checkStatusBeforeSubmit);
        
        // Variables para confirmaciÃ³n
        let pendingCheckinData = null;
        let capturedPhotoBase64 = null;
        let capturedLatitude = null;
        let capturedLongitude = null;
        let videoStream = null;
        
        // Elementos de cÃ¡mara
        const cameraView = document.getElementById('camera-view');
        const cameraVideo = document.getElementById('camera-video');
        const photoCanvas = document.getElementById('photo-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const cameraInstruction = document.getElementById('camera-instruction');
        const selfieBadge = document.getElementById('selfie-badge');
        const methodRequired = document.getElementById('method-required');
        const methodIcon = document.getElementById('method-icon');
        const methodText = document.getElementById('method-text');

        function checkStatusBeforeSubmit() {
            if (isSubmitting || currentPin.length < 4) return;
            
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Verificando...</span>';
            
            const formData = new FormData();
            formData.append('pin', currentPin);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            {% if gym_id %}
            formData.append('gym_id', '{{ gym_id }}');
            {% endif %}

            fetch("{% url 'staff_check_status' %}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Mostrar modal de confirmaciÃ³n
                        showConfirmModal(data);
                    } else {
                        // PIN incorrecto o error
                        showStatus(data);
                        resetSubmitButton();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showStatus({ status: 'error', message: 'Error de conexiÃ³n. Verifica tu red.' });
                    resetSubmitButton();
                });
        }
        
        function showConfirmModal(data) {
            const modal = document.getElementById('confirm-modal');
            const photo = document.getElementById('confirm-photo');
            const photoContainer = document.getElementById('confirm-photo-container');
            const name = document.getElementById('confirm-name');
            const duration = document.getElementById('confirm-duration');
            const actionBadge = document.getElementById('confirm-action-badge');
            
            // Reset captured data
            capturedPhotoBase64 = null;
            capturedLatitude = null;
            capturedLongitude = null;
            
            // Guardar datos para el fichaje
            pendingCheckinData = {
                pin: currentPin,
                staffName: data.staff_name,
                requirePhoto: data.require_photo || false,
                requireGeo: data.require_geo || false,
                action: data.action
            };
            
            // Mostrar nombre
            name.textContent = data.staff_name || 'Empleado';
            
            // Mostrar foto si existe
            if (data.staff_photo) {
                photo.src = data.staff_photo;
                photoContainer.classList.remove('hidden');
            } else {
                photoContainer.classList.add('hidden');
            }
            
            // Mostrar requisitos de mÃ©todo y advertencia de pruebas
            const selfieWarning = document.getElementById('selfie-warning');
            if (data.require_photo || data.require_geo) {
                methodRequired.classList.remove('hidden');
                let reqText = [];
                if (data.require_photo) reqText.push('ðŸ“¸ selfie');
                if (data.require_geo) reqText.push('ðŸ“ ubicaciÃ³n');
                methodText.textContent = 'Se requiere: ' + reqText.join(' y ');
                
                if (data.require_photo) {
                    selfieBadge.classList.remove('hidden');
                    selfieWarning.classList.remove('hidden');
                } else {
                    selfieBadge.classList.add('hidden');
                    selfieWarning.classList.add('hidden');
                }
            } else {
                methodRequired.classList.add('hidden');
                selfieBadge.classList.add('hidden');
                selfieWarning.classList.add('hidden');
            }
            
            // Configurar badge de acciÃ³n
            if (data.action === 'checkin') {
                actionBadge.textContent = 'ðŸ“¥ ENTRADA';
                actionBadge.className = 'px-6 py-3 rounded-2xl text-xl font-bold mb-4 bg-green-100 text-green-700';
                photo.className = 'w-28 h-28 rounded-full object-cover border-4 shadow-xl border-green-500';
                duration.textContent = '';
            } else {
                actionBadge.textContent = 'ðŸ“¤ SALIDA';
                actionBadge.className = 'px-6 py-3 rounded-2xl text-xl font-bold mb-4 bg-orange-100 text-orange-700';
                photo.className = 'w-28 h-28 rounded-full object-cover border-4 shadow-xl border-orange-500';
                
                // Mostrar duraciÃ³n si existe
                if (data.duration_hours) {
                    const hours = Math.floor(data.duration_hours);
                    const minutes = Math.round((data.duration_hours - hours) * 60);
                    duration.textContent = `â±ï¸ Tiempo trabajado: ${hours}h ${minutes}m`;
                } else {
                    duration.textContent = '';
                }
            }
            
            modal.classList.remove('hidden');
            
            // Si se requiere geolocalizaciÃ³n, obtenerla automÃ¡ticamente
            if (data.require_geo) {
                getGeolocation();
            }
        }
        
        // Event listeners para botones de confirmaciÃ³n
        document.getElementById('cancel-confirm-btn').addEventListener('click', function() {
            stopCamera();
            document.getElementById('confirm-modal').classList.add('hidden');
            pendingCheckinData = null;
            capturedPhotoBase64 = null;
            capturedLatitude = null;
            capturedLongitude = null;
            clearPin();
            resetSubmitButton();
        });
        
        document.getElementById('do-confirm-btn').addEventListener('click', function() {
            // Si se requiere foto y no la tenemos, abrir cÃ¡mara
            if (pendingCheckinData.requirePhoto && !capturedPhotoBase64) {
                openCamera();
                return;
            }
            
            // Si se requiere geo y no la tenemos, mostrar error
            if (pendingCheckinData.requireGeo && (!capturedLatitude || !capturedLongitude)) {
                showTemporaryMessage('ðŸ“ UbicaciÃ³n requerida', 'Esperando ubicaciÃ³n GPS...', 'warning');
                getGeolocation();
                return;
            }
            
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-content').classList.remove('hidden');
            executeCheckin();
        });
        
        // Event listeners para cÃ¡mara
        if (captureBtn) {
            captureBtn.addEventListener('click', capturePhoto);
        }
        if (cancelCameraBtn) {
            cancelCameraBtn.addEventListener('click', function() {
                stopCamera();
                cameraView.classList.add('hidden');
                document.getElementById('confirm-content').classList.remove('hidden');
            });
        }
        
        function openCamera() {
            document.getElementById('confirm-content').classList.add('hidden');
            cameraView.classList.remove('hidden');
            cameraInstruction.textContent = 'Mira a la cÃ¡mara y toca el botÃ³n';
            
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user', width: 640, height: 480 },
                audio: false 
            })
            .then(function(stream) {
                videoStream = stream;
                cameraVideo.srcObject = stream;
                cameraVideo.play();
            })
            .catch(function(err) {
                console.error('Error accessing camera:', err);
                cameraView.classList.add('hidden');
                document.getElementById('confirm-content').classList.remove('hidden');
                showTemporaryMessage('âŒ Error de cÃ¡mara', 'No se pudo acceder a la cÃ¡mara', 'error');
            });
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            cameraVideo.srcObject = null;
            cameraView.classList.add('hidden');
        }
        
        function capturePhoto() {
            if (!cameraVideo.srcObject) return;
            
            // Configurar canvas
            photoCanvas.width = cameraVideo.videoWidth || 640;
            photoCanvas.height = cameraVideo.videoHeight || 480;
            
            // Dibujar frame actual
            const ctx = photoCanvas.getContext('2d');
            ctx.drawImage(cameraVideo, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // Convertir a base64
            capturedPhotoBase64 = photoCanvas.toDataURL('image/jpeg', 0.8);
            
            // Mostrar preview
            const confirmPhoto = document.getElementById('confirm-photo');
            const photoContainer = document.getElementById('confirm-photo-container');
            confirmPhoto.src = capturedPhotoBase64;
            photoContainer.classList.remove('hidden');
            
            // Cerrar cÃ¡mara
            stopCamera();
            document.getElementById('confirm-content').classList.remove('hidden');
            
            // Feedback
            cameraInstruction.textContent = 'âœ… Foto capturada';
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // Marcar selfie badge como completo
            if (selfieBadge) {
                selfieBadge.classList.remove('bg-blue-500');
                selfieBadge.classList.add('bg-green-500');
            }
            
            // Si tambiÃ©n tenemos geo (o no se requiere), proceder automÃ¡ticamente
            if (!pendingCheckinData.requireGeo || (capturedLatitude && capturedLongitude)) {
                setTimeout(function() {
                    document.getElementById('confirm-modal').classList.add('hidden');
                    executeCheckin();
                }, 500);
            }
        }
        
        function getGeolocation() {
            if (!navigator.geolocation) {
                showTemporaryMessage('âŒ GeolocalizaciÃ³n', 'Tu navegador no soporta GPS', 'error');
                return;
            }
            
            methodText.textContent = 'ðŸ“ Obteniendo ubicaciÃ³n...';
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    capturedLatitude = position.coords.latitude;
                    capturedLongitude = position.coords.longitude;
                    methodText.textContent = 'âœ… UbicaciÃ³n obtenida';
                    
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    let msg = 'No se pudo obtener ubicaciÃ³n';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            msg = 'Permiso de ubicaciÃ³n denegado';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            msg = 'UbicaciÃ³n no disponible';
                            break;
                        case error.TIMEOUT:
                            msg = 'Tiempo de espera agotado';
                            break;
                    }
                    methodText.textContent = 'âŒ ' + msg;
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0 
                }
            );
        }
        
        function executeCheckin() {
            const formData = new FormData();
            formData.append('pin', pendingCheckinData.pin);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            {% if gym_id %}
            formData.append('gym_id', '{{ gym_id }}');
            {% endif %}
            
            // AÃ±adir foto si fue capturada
            if (capturedPhotoBase64) {
                formData.append('photo', capturedPhotoBase64);
            }
            
            // AÃ±adir geolocalizaciÃ³n si fue capturada
            if (capturedLatitude && capturedLongitude) {
                formData.append('latitude', capturedLatitude);
                formData.append('longitude', capturedLongitude);
            }

            fetch("{% url 'staff_checkin' %}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    showStatus(data);
                    setTimeout(() => {
                        clearPin();
                        resetSubmitButton();
                        pendingCheckinData = null;
                        capturedPhotoBase64 = null;
                        capturedLatitude = null;
                        capturedLongitude = null;
                    }, 3500);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showStatus({ status: 'error', message: 'Error de conexiÃ³n. Verifica tu red.' });
                    setTimeout(() => {
                        clearPin();
                        resetSubmitButton();
                        pendingCheckinData = null;
                        capturedPhotoBase64 = null;
                        capturedLatitude = null;
                        capturedLongitude = null;
                    }, 3500);
                });
        }
        
        function resetSubmitButton() {
            isSubmitting = false;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>FICHAR</span>';
        }

        function submitPin() {
            if (isSubmitting || currentPin.length < 4) return;
            
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Verificando...</span>';
            
            const formData = new FormData();
            formData.append('pin', currentPin);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            {% if gym_id %}
            formData.append('gym_id', '{{ gym_id }}');
            {% endif %}

            fetch("{% url 'staff_checkin' %}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    showStatus(data);
                    setTimeout(() => {
                        clearPin();
                        isSubmitting = false;
                        submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>FICHAR</span>';
                    }, 3500);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showStatus({ status: 'error', message: 'Error de conexiÃ³n. Verifica tu red.' });
                    setTimeout(() => {
                        clearPin();
                        isSubmitting = false;
                        submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>FICHAR</span>';
                    }, 3500);
                });
        }

        function showStatus(data) {
            const modal = document.getElementById('status-message');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            const text = document.getElementById('status-text');
            const timeDisplay = document.getElementById('status-time');
            const photoContainer = document.getElementById('staff-photo-container');
            const photo = document.getElementById('staff-photo');

            modal.classList.remove('hidden');

            if (data.status === 'success') {
                // Sonido de Ã©xito
                try {
                    document.getElementById('success-sound').play();
                } catch (e) {}
                
                // VibraciÃ³n de Ã©xito
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                modal.classList.add('pulse-success');
                
                if (data.action === 'checkin') {
                    icon.textContent = 'ðŸ‘‹';
                    icon.style.fontSize = '6rem';
                    title.textContent = 'Â¡Bienvenido/a!';
                    title.style.color = '#16a34a';
                } else {
                    icon.textContent = 'ðŸ';
                    icon.style.fontSize = '6rem';
                    title.textContent = 'Â¡Hasta luego!';
                    title.style.color = '#ea580c';
                }
                
                text.textContent = data.staff_name || 'Empleado';
                text.style.fontSize = '1.5rem';
                text.style.fontWeight = '700';
                
                // Mostrar hora de fichaje
                const now = new Date();
                const timeStr = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                timeDisplay.textContent = `Fichaje registrado a las ${timeStr}`;
                
                // Mostrar foto si estÃ¡ disponible
                if (data.staff_photo) {
                    photo.src = data.staff_photo;
                    photoContainer.classList.remove('hidden');
                    icon.classList.add('hidden');
                }
                
            } else {
                // Sonido de error
                try {
                    document.getElementById('error-sound').play();
                } catch (e) {}
                
                // VibraciÃ³n de error
                if (navigator.vibrate) {
                    navigator.vibrate([50, 100, 50, 100, 50]);
                }
                
                pinDisplay.classList.add('shake');
                setTimeout(() => pinDisplay.classList.remove('shake'), 500);
                
                icon.textContent = 'âŒ';
                icon.style.fontSize = '5rem';
                title.textContent = 'PIN Incorrecto';
                title.style.color = '#dc2626';
                text.textContent = data.message || 'Verifica tu cÃ³digo';
                text.style.fontSize = '1.125rem';
                text.style.fontWeight = '400';
                timeDisplay.textContent = '';
                photoContainer.classList.add('hidden');
                icon.classList.remove('hidden');
            }

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('pulse-success');
                photoContainer.classList.add('hidden');
                icon.classList.remove('hidden');
                resetInactivityTimer();
            }, 3500);
        }
        
        function showTemporaryMessage(title, message, type = 'info') {
            const modal = document.getElementById('status-message');
            const icon = document.getElementById('status-icon');
            const titleEl = document.getElementById('status-title');
            const text = document.getElementById('status-text');
            
            modal.classList.remove('hidden');
            icon.textContent = type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            titleEl.textContent = title;
            text.textContent = message;
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 2000);
        }
    </script>
</body>

</html>